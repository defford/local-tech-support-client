<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TechSupportApiClient.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Local Tech Support CLI Client</a> &gt; <a href="index.source.html" class="el_package">com.localtechsupport.cli.client</a> &gt; <span class="el_source">TechSupportApiClient.java</span></div><h1>TechSupportApiClient.java</h1><pre class="source lang-java linenums">package com.localtechsupport.cli.client;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;
import com.fasterxml.jackson.core.type.TypeReference;
import okhttp3.OkHttpClient;
import okhttp3.Request;
import okhttp3.Response;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.util.concurrent.TimeUnit;

/**
 * HTTP client for communicating with the Local Tech Support Server API
 * 
 * This client handles all HTTP requests to the server and provides
 * JSON response parsing capabilities.
 */
public class TechSupportApiClient {

<span class="fc" id="L23">    private static final Logger logger = LoggerFactory.getLogger(TechSupportApiClient.class);</span>

    private final OkHttpClient httpClient;
    private final ObjectMapper objectMapper;
    private final String baseUrl;

<span class="fc" id="L29">    public TechSupportApiClient(String baseUrl) {</span>
<span class="fc bfc" id="L30" title="All 2 branches covered.">        this.baseUrl = baseUrl.endsWith(&quot;/&quot;) ? baseUrl.substring(0, baseUrl.length() - 1) : baseUrl;</span>
        
<span class="fc" id="L32">        this.httpClient = new OkHttpClient.Builder()</span>
<span class="fc" id="L33">            .connectTimeout(10, TimeUnit.SECONDS)</span>
<span class="fc" id="L34">            .readTimeout(30, TimeUnit.SECONDS)</span>
<span class="fc" id="L35">            .build();</span>
            
<span class="fc" id="L37">        this.objectMapper = new ObjectMapper()</span>
<span class="fc" id="L38">            .registerModule(new JavaTimeModule())</span>
<span class="fc" id="L39">            .configure(com.fasterxml.jackson.databind.SerializationFeature.WRITE_DATES_AS_TIMESTAMPS, false);</span>
            
<span class="fc" id="L41">        logger.info(&quot;TechSupportApiClient initialized with base URL: {}&quot;, this.baseUrl);</span>
<span class="fc" id="L42">    }</span>

    /**
     * Performs a GET request to the specified endpoint and returns the parsed response
     * 
     * @param endpoint The API endpoint (e.g., &quot;/api/tickets/statistics&quot;)
     * @param responseType The class to deserialize the response into
     * @return ApiResponse containing the parsed data and metadata
     * @throws ApiException if the request fails or response cannot be parsed
     */
    public &lt;T&gt; ApiResponse&lt;T&gt; get(String endpoint, Class&lt;T&gt; responseType) throws ApiException {
<span class="fc" id="L53">        String url = baseUrl + endpoint;</span>
<span class="fc" id="L54">        logger.debug(&quot;Making GET request to: {}&quot;, url);</span>

<span class="fc" id="L56">        Request request = new Request.Builder()</span>
<span class="fc" id="L57">            .url(url)</span>
<span class="fc" id="L58">            .header(&quot;Accept&quot;, &quot;application/json&quot;)</span>
<span class="fc" id="L59">            .header(&quot;User-Agent&quot;, &quot;TechSupport-CLI/1.0&quot;)</span>
<span class="fc" id="L60">            .build();</span>

<span class="fc" id="L62">        try (Response response = httpClient.newCall(request).execute()) {</span>
<span class="fc" id="L63">            logger.debug(&quot;Response status: {} for URL: {}&quot;, response.code(), url);</span>
            
<span class="fc bfc" id="L65" title="All 2 branches covered.">            if (!response.isSuccessful()) {</span>
<span class="pc bpc" id="L66" title="1 of 2 branches missed.">                String errorBody = response.body() != null ? response.body().string() : &quot;No error details&quot;;</span>
<span class="fc" id="L67">                throw new ApiException(</span>
<span class="fc" id="L68">                    String.format(&quot;API call failed with status %d: %s&quot;, response.code(), errorBody),</span>
<span class="fc" id="L69">                    response.code()</span>
                );
            }

<span class="pc bpc" id="L73" title="1 of 2 branches missed.">            if (response.body() == null) {</span>
<span class="nc" id="L74">                throw new ApiException(&quot;Response body is null&quot;, response.code());</span>
            }

<span class="fc" id="L77">            String responseBody = response.body().string();</span>
<span class="fc" id="L78">            logger.debug(&quot;Response body length: {} characters&quot;, responseBody.length());</span>

<span class="fc" id="L80">            T data = objectMapper.readValue(responseBody, responseType);</span>
            
<span class="fc" id="L82">            return new ApiResponse&lt;&gt;(</span>
<span class="fc" id="L83">                data,</span>
<span class="fc" id="L84">                response.code(),</span>
<span class="fc" id="L85">                response.headers().toMultimap()</span>
            );

<span class="fc" id="L88">        } catch (IOException e) {</span>
<span class="fc" id="L89">            logger.error(&quot;Network error while calling {}: {}&quot;, url, e.getMessage());</span>
<span class="fc" id="L90">            throw new ApiException(&quot;Network error: &quot; + e.getMessage(), e);</span>
<span class="fc" id="L91">        } catch (Exception e) {</span>
<span class="fc" id="L92">            logger.error(&quot;Unexpected error while calling {}: {}&quot;, url, e.getMessage());</span>
<span class="fc" id="L93">            throw new ApiException(&quot;Unexpected error: &quot; + e.getMessage(), e);</span>
        }
    }

    /**
     * Performs a GET request to the specified endpoint and returns the parsed response using TypeReference
     * 
     * @param endpoint The API endpoint (e.g., &quot;/api/clients&quot;)
     * @param typeReference The TypeReference to deserialize the response into
     * @return ApiResponse containing the parsed data and metadata
     * @throws ApiException if the request fails or response cannot be parsed
     */
    public &lt;T&gt; ApiResponse&lt;T&gt; get(String endpoint, TypeReference&lt;T&gt; typeReference) throws ApiException {
<span class="nc" id="L106">        String url = baseUrl + endpoint;</span>
<span class="nc" id="L107">        logger.debug(&quot;Making GET request to: {}&quot;, url);</span>

<span class="nc" id="L109">        Request request = new Request.Builder()</span>
<span class="nc" id="L110">            .url(url)</span>
<span class="nc" id="L111">            .header(&quot;Accept&quot;, &quot;application/json&quot;)</span>
<span class="nc" id="L112">            .header(&quot;User-Agent&quot;, &quot;TechSupport-CLI/1.0&quot;)</span>
<span class="nc" id="L113">            .build();</span>

<span class="nc" id="L115">        try (Response response = httpClient.newCall(request).execute()) {</span>
<span class="nc" id="L116">            logger.debug(&quot;Response status: {} for URL: {}&quot;, response.code(), url);</span>
            
<span class="nc bnc" id="L118" title="All 2 branches missed.">            if (!response.isSuccessful()) {</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">                String errorBody = response.body() != null ? response.body().string() : &quot;No error details&quot;;</span>
<span class="nc" id="L120">                throw new ApiException(</span>
<span class="nc" id="L121">                    String.format(&quot;API call failed with status %d: %s&quot;, response.code(), errorBody),</span>
<span class="nc" id="L122">                    response.code()</span>
                );
            }

<span class="nc bnc" id="L126" title="All 2 branches missed.">            if (response.body() == null) {</span>
<span class="nc" id="L127">                throw new ApiException(&quot;Response body is null&quot;, response.code());</span>
            }

<span class="nc" id="L130">            String responseBody = response.body().string();</span>
<span class="nc" id="L131">            logger.debug(&quot;Response body length: {} characters&quot;, responseBody.length());</span>

<span class="nc" id="L133">            T data = objectMapper.readValue(responseBody, typeReference);</span>
            
<span class="nc" id="L135">            return new ApiResponse&lt;&gt;(</span>
<span class="nc" id="L136">                data,</span>
<span class="nc" id="L137">                response.code(),</span>
<span class="nc" id="L138">                response.headers().toMultimap()</span>
            );

<span class="nc" id="L141">        } catch (IOException e) {</span>
<span class="nc" id="L142">            logger.error(&quot;Network error while calling {}: {}&quot;, url, e.getMessage());</span>
<span class="nc" id="L143">            throw new ApiException(&quot;Network error: &quot; + e.getMessage(), e);</span>
<span class="nc" id="L144">        } catch (Exception e) {</span>
<span class="nc" id="L145">            logger.error(&quot;Unexpected error while calling {}: {}&quot;, url, e.getMessage());</span>
<span class="nc" id="L146">            throw new ApiException(&quot;Unexpected error: &quot; + e.getMessage(), e);</span>
        }
    }

    /**
     * Get the base URL configured for this client
     * 
     * @return the base URL
     */
    public String getBaseUrl() {
<span class="fc" id="L156">        return baseUrl;</span>
    }

    /**
     * Test connection to the API server
     * 
     * @return true if the server is reachable, false otherwise
     */
    public boolean testConnection() {
        try {
<span class="fc" id="L166">            Request request = new Request.Builder()</span>
<span class="fc" id="L167">                .url(baseUrl + &quot;/actuator/health&quot;)</span>
<span class="fc" id="L168">                .header(&quot;Accept&quot;, &quot;application/json&quot;)</span>
<span class="fc" id="L169">                .build();</span>

<span class="fc" id="L171">            try (Response response = httpClient.newCall(request).execute()) {</span>
<span class="fc" id="L172">                return response.isSuccessful();</span>
            }
<span class="nc" id="L174">        } catch (Exception e) {</span>
<span class="nc" id="L175">            logger.warn(&quot;Connection test failed: {}&quot;, e.getMessage());</span>
<span class="nc" id="L176">            return false;</span>
        }
    }

    /**
     * Close the HTTP client and release resources
     */
    public void close() {
<span class="pc bpc" id="L184" title="1 of 2 branches missed.">        if (httpClient != null) {</span>
<span class="fc" id="L185">            httpClient.dispatcher().executorService().shutdown();</span>
<span class="fc" id="L186">            httpClient.connectionPool().evictAll();</span>
        }
<span class="fc" id="L188">    }</span>
} 
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>