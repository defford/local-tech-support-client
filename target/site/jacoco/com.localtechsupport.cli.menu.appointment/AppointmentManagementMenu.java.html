<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AppointmentManagementMenu.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Local Tech Support CLI Client</a> &gt; <a href="index.source.html" class="el_package">com.localtechsupport.cli.menu.appointment</a> &gt; <span class="el_source">AppointmentManagementMenu.java</span></div><h1>AppointmentManagementMenu.java</h1><pre class="source lang-java linenums">package com.localtechsupport.cli.menu.appointment;

import com.localtechsupport.cli.menu.BaseMenu;
import com.localtechsupport.cli.menu.Menu;
import com.localtechsupport.cli.service.ApiService;
import com.localtechsupport.cli.model.Appointment;
import com.localtechsupport.cli.model.Ticket;
import com.localtechsupport.cli.model.Technician;
import com.localtechsupport.cli.client.ApiException;
import com.localtechsupport.cli.util.DisplayUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.List;
import java.util.Scanner;
import java.util.stream.Collectors;
import java.time.format.DateTimeFormatter;
import java.time.LocalDateTime;
import java.time.Duration;
import java.util.Map;
import java.util.HashMap;

/**
 * Menu for appointment management operations
 * 
 * Provides comprehensive appointment management with:
 * - View all appointments with calendar display
 * - Schedule new appointments with conflict detection
 * - Reschedule existing appointments
 * - Status management (6-state workflow)
 * - Cancel appointments with reasons
 * - Appointment reports and analytics
 * 
 * Implements business rules: 30min-8hr duration, only ACTIVE technicians, only OPEN tickets
 * Status workflow: PENDING ‚Üí CONFIRMED ‚Üí IN_PROGRESS ‚Üí COMPLETED/CANCELLED/NO_SHOW
 */
public class AppointmentManagementMenu extends BaseMenu {
    
<span class="nc" id="L39">    private static final Logger logger = LoggerFactory.getLogger(AppointmentManagementMenu.class);</span>
    private AppointmentBuilder appointmentBuilder;
    
    public AppointmentManagementMenu(Menu parentMenu) {
<span class="nc" id="L43">        super(parentMenu);</span>
<span class="nc" id="L44">    }</span>
    
    @Override
    protected String getMenuTitle() {
<span class="nc" id="L48">        return &quot;APPOINTMENT MANAGEMENT&quot;;</span>
    }
    
    @Override
    protected void displayCustomContent() {
        try {
            // Display current system status
<span class="nc" id="L55">            List&lt;Appointment&gt; appointments = apiService.getAllAppointments();</span>
<span class="nc" id="L56">            long totalCount = appointments.size();</span>
            
            // Status breakdown
<span class="nc" id="L59">            long pendingCount = appointments.stream().filter(a -&gt; &quot;PENDING&quot;.equals(a.getStatus())).count();</span>
<span class="nc" id="L60">            long confirmedCount = appointments.stream().filter(a -&gt; &quot;CONFIRMED&quot;.equals(a.getStatus())).count();</span>
<span class="nc" id="L61">            long inProgressCount = appointments.stream().filter(a -&gt; &quot;IN_PROGRESS&quot;.equals(a.getStatus())).count();</span>
<span class="nc" id="L62">            long completedCount = appointments.stream().filter(a -&gt; &quot;COMPLETED&quot;.equals(a.getStatus())).count();</span>
<span class="nc" id="L63">            long cancelledCount = appointments.stream().filter(a -&gt; &quot;CANCELLED&quot;.equals(a.getStatus())).count();</span>
<span class="nc" id="L64">            long noShowCount = appointments.stream().filter(a -&gt; &quot;NO_SHOW&quot;.equals(a.getStatus())).count();</span>
            
            // Upcoming appointments (next 7 days)
<span class="nc" id="L67">            List&lt;Appointment&gt; upcomingAppointments = apiService.getUpcomingAppointments(7);</span>
            
<span class="nc" id="L69">            System.out.println(&quot;üìä Current System Status:&quot;);</span>
<span class="nc" id="L70">            System.out.printf(&quot;    Total Appointments: %d\n&quot;, totalCount);</span>
<span class="nc" id="L71">            System.out.printf(&quot;    Status Breakdown: %d pending, %d confirmed, %d in-progress, %d completed\n&quot;, </span>
<span class="nc" id="L72">                pendingCount, confirmedCount, inProgressCount, completedCount);</span>
<span class="nc" id="L73">            System.out.printf(&quot;    Upcoming (7 days): %d appointments scheduled\n&quot;, upcomingAppointments.size());</span>
<span class="nc" id="L74">            System.out.println();</span>
            
<span class="nc" id="L76">            System.out.println(&quot;‚ÑπÔ∏è  Appointment Status Workflow:&quot;);</span>
<span class="nc" id="L77">            System.out.println(&quot;   PENDING ‚Üí CONFIRMED ‚Üí IN_PROGRESS ‚Üí COMPLETED (or CANCELLED/NO_SHOW)&quot;);</span>
<span class="nc" id="L78">            System.out.println(&quot;   Business Rules: 30min-8hr duration, Active technicians only, Open tickets only&quot;);</span>
<span class="nc" id="L79">            System.out.println();</span>
            
<span class="nc" id="L81">            System.out.println(&quot;‚ö†Ô∏è  API Update Limitations:&quot;);</span>
<span class="nc" id="L82">            System.out.println(&quot;   ‚úÖ Status updates: Full support for workflow transitions&quot;);</span>
<span class="nc" id="L83">            System.out.println(&quot;   ‚ùå Time changes: Not supported - use Cancel &amp; Recreate instead&quot;);</span>
<span class="nc" id="L84">            System.out.println(&quot;   ‚ùå Technician changes: Not supported - use Cancel &amp; Recreate instead&quot;);</span>
<span class="nc" id="L85">            System.out.println(&quot;   ‚ùå Ticket reassignment: Not supported (fixed at creation)&quot;);</span>
<span class="nc" id="L86">            System.out.println();</span>
            
<span class="nc" id="L88">        } catch (ApiException e) {</span>
<span class="nc" id="L89">            logger.error(&quot;Failed to fetch appointment statistics&quot;, e);</span>
<span class="nc" id="L90">            System.out.println(&quot;üìä Current System Status: Unable to load statistics&quot;);</span>
<span class="nc" id="L91">            System.out.println();</span>
            
<span class="nc" id="L93">            System.out.println(&quot;‚ÑπÔ∏è  Appointment Status Workflow:&quot;);</span>
<span class="nc" id="L94">            System.out.println(&quot;   PENDING ‚Üí CONFIRMED ‚Üí IN_PROGRESS ‚Üí COMPLETED (or CANCELLED/NO_SHOW)&quot;);</span>
<span class="nc" id="L95">            System.out.println(&quot;   Business Rules: 30min-8hr duration, Active technicians only, Open tickets only&quot;);</span>
<span class="nc" id="L96">            System.out.println();</span>
            
<span class="nc" id="L98">            System.out.println(&quot;‚ö†Ô∏è  API Update Limitations:&quot;);</span>
<span class="nc" id="L99">            System.out.println(&quot;   ‚úÖ Status updates: Full support for workflow transitions&quot;);</span>
<span class="nc" id="L100">            System.out.println(&quot;   ‚ùå Time changes: Not supported - use Cancel &amp; Recreate instead&quot;);</span>
<span class="nc" id="L101">            System.out.println(&quot;   ‚ùå Technician changes: Not supported - use Cancel &amp; Recreate instead&quot;);</span>
<span class="nc" id="L102">            System.out.println(&quot;   ‚ùå Ticket reassignment: Not supported (fixed at creation)&quot;);</span>
<span class="nc" id="L103">            System.out.println();</span>
<span class="nc" id="L104">        }</span>
<span class="nc" id="L105">    }</span>
    
    @Override
    protected void initializeMenuOptions() {
        // Initialize AppointmentBuilder with scanner and apiService from BaseMenu
<span class="nc" id="L110">        this.appointmentBuilder = new AppointmentBuilder(scanner, apiService);</span>
        
<span class="nc" id="L112">        addActionOption(1, &quot;View All Appointments&quot;, &quot;Calendar view of all appointments with status&quot;,</span>
            this::viewAllAppointments);
            
<span class="nc" id="L115">        addActionOption(2, &quot;Upcoming Appointments&quot;, &quot;View appointments in the next 7 days&quot;, </span>
            this::viewUpcomingAppointments);
            
<span class="nc" id="L118">        addActionOption(3, &quot;Schedule New Appointment&quot;, &quot;Create new appointment with conflict detection&quot;,</span>
            this::scheduleNewAppointment);
            
<span class="nc" id="L121">        addActionOption(4, &quot;View Appointment Details&quot;, &quot;Detailed view with ticket and technician info&quot;,</span>
            this::viewAppointmentDetails);
            
<span class="nc" id="L124">        addActionOption(5, &quot;Cancel &amp; Recreate Appointment&quot;, &quot;Change times/technician (cancel + create new)&quot;,</span>
            this::cancelAndRecreateAppointment);
            
<span class="nc" id="L127">        addActionOption(6, &quot;Confirm Appointment&quot;, &quot;Change status from PENDING to CONFIRMED&quot;,</span>
            this::confirmAppointment);
            
<span class="nc" id="L130">        addActionOption(7, &quot;Start Appointment&quot;, &quot;Change status to IN_PROGRESS&quot;,</span>
            this::startAppointment);
            
<span class="nc" id="L133">        addActionOption(8, &quot;Complete Appointment&quot;, &quot;Mark appointment as COMPLETED&quot;,</span>
            this::completeAppointment);
            
<span class="nc" id="L136">        addActionOption(9, &quot;Cancel Appointment&quot;, &quot;Cancel appointment with reason&quot;,</span>
            this::cancelAppointment);
            
<span class="nc" id="L139">        addActionOption(10, &quot;Mark No-Show&quot;, &quot;Mark client as no-show&quot;,</span>
            this::markNoShow);
            
<span class="nc" id="L142">        addActionOption(11, &quot;Search Appointments&quot;, &quot;Find appointments by various criteria&quot;,</span>
            this::searchAppointments);
            
<span class="nc" id="L145">        addActionOption(12, &quot;Appointment Reports&quot;, &quot;Statistics and analytics&quot;,</span>
            this::appointmentReports);
<span class="nc" id="L147">    }</span>
    
    // ==================== MENU OPERATIONS ====================
    
    private void viewAllAppointments() {
<span class="nc" id="L152">        DisplayUtils.printHeader(&quot;ALL APPOINTMENTS&quot;);</span>
        
        try {
<span class="nc" id="L155">            List&lt;Appointment&gt; appointments = apiService.getAllAppointments();</span>
            
<span class="nc bnc" id="L157" title="All 2 branches missed.">            if (appointments.isEmpty()) {</span>
<span class="nc" id="L158">                System.out.println(&quot;üì≠ No appointments found in the system.&quot;);</span>
<span class="nc" id="L159">                waitForEnter();</span>
<span class="nc" id="L160">                return;</span>
            }
            
            // Sort by scheduled start time
<span class="nc" id="L164">            appointments = appointments.stream()</span>
<span class="nc" id="L165">                .sorted((a1, a2) -&gt; {</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">                    if (a1.getScheduledStartTime() == null) return 1;</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">                    if (a2.getScheduledStartTime() == null) return -1;</span>
<span class="nc" id="L168">                    return a1.getScheduledStartTime().compareTo(a2.getScheduledStartTime());</span>
                })
<span class="nc" id="L170">                .collect(Collectors.toList());</span>
            
            // Display appointments table
<span class="nc" id="L173">            displayAppointmentsTable(appointments);</span>
            
<span class="nc" id="L175">            System.out.println();</span>
<span class="nc" id="L176">            System.out.print(&quot;Enter appointment ID to view details (or press Enter to continue): &quot;);</span>
<span class="nc" id="L177">            String input = scanner.nextLine().trim();</span>
            
<span class="nc bnc" id="L179" title="All 2 branches missed.">            if (!input.isEmpty()) {</span>
                try {
<span class="nc" id="L181">                    Long appointmentId = Long.parseLong(input);</span>
<span class="nc" id="L182">                    Appointment selectedAppointment = appointments.stream()</span>
<span class="nc" id="L183">                        .filter(a -&gt; a.getId().equals(appointmentId))</span>
<span class="nc" id="L184">                        .findFirst()</span>
<span class="nc" id="L185">                        .orElse(null);</span>
                        
<span class="nc bnc" id="L187" title="All 2 branches missed.">                    if (selectedAppointment != null) {</span>
<span class="nc" id="L188">                        displayAppointmentDetails(selectedAppointment);</span>
                    } else {
<span class="nc" id="L190">                        DisplayUtils.printError(&quot;Appointment not found with ID: &quot; + appointmentId);</span>
                    }
<span class="nc" id="L192">                } catch (NumberFormatException e) {</span>
<span class="nc" id="L193">                    DisplayUtils.printError(&quot;Invalid appointment ID format.&quot;);</span>
<span class="nc" id="L194">                }</span>
            }
            
<span class="nc" id="L197">        } catch (ApiException e) {</span>
<span class="nc" id="L198">            logger.error(&quot;Failed to fetch appointments&quot;, e);</span>
<span class="nc" id="L199">            DisplayUtils.printError(&quot;Failed to retrieve appointments: &quot; + e.getMessage());</span>
<span class="nc" id="L200">        }</span>
        
<span class="nc" id="L202">        waitForEnter();</span>
<span class="nc" id="L203">    }</span>
    
    private void viewUpcomingAppointments() {
<span class="nc" id="L206">        DisplayUtils.printHeader(&quot;UPCOMING APPOINTMENTS&quot;);</span>
        
        try {
<span class="nc" id="L209">            List&lt;Appointment&gt; upcomingAppointments = apiService.getUpcomingAppointments(7);</span>
            
<span class="nc bnc" id="L211" title="All 2 branches missed.">            if (upcomingAppointments.isEmpty()) {</span>
<span class="nc" id="L212">                System.out.println(&quot;üì≠ No upcoming appointments in the next 7 days.&quot;);</span>
<span class="nc" id="L213">                waitForEnter();</span>
<span class="nc" id="L214">                return;</span>
            }
            
<span class="nc" id="L217">            System.out.printf(&quot;üìÖ Found %d upcoming appointment(s) in the next 7 days:\n\n&quot;, upcomingAppointments.size());</span>
            
            // Display appointments table
<span class="nc" id="L220">            displayAppointmentsTable(upcomingAppointments);</span>
            
            // Show next few appointments with details
<span class="nc" id="L223">            System.out.println(&quot;\nüîú Next Few Appointments:&quot;);</span>
<span class="nc" id="L224">            upcomingAppointments.stream()</span>
<span class="nc" id="L225">                .limit(5)</span>
<span class="nc" id="L226">                .forEach(this::displayAppointmentSummary);</span>
                
<span class="nc" id="L228">        } catch (ApiException e) {</span>
<span class="nc" id="L229">            logger.error(&quot;Failed to fetch upcoming appointments&quot;, e);</span>
<span class="nc" id="L230">            DisplayUtils.printError(&quot;Failed to retrieve upcoming appointments: &quot; + e.getMessage());</span>
<span class="nc" id="L231">        }</span>
        
<span class="nc" id="L233">        waitForEnter();</span>
<span class="nc" id="L234">    }</span>
    
    private void scheduleNewAppointment() {
<span class="nc" id="L237">        DisplayUtils.printHeader(&quot;SCHEDULE NEW APPOINTMENT&quot;);</span>
        
        try {
            // Use AppointmentBuilder to collect input
<span class="nc" id="L241">            Appointment newAppointment = appointmentBuilder.buildNewAppointment();</span>
            
<span class="nc bnc" id="L243" title="All 2 branches missed.">            if (newAppointment == null) {</span>
<span class="nc" id="L244">                return; // User cancelled</span>
            }
            
            // Create the appointment via API
            Appointment createdAppointment;
            try {
                // Add pre-submission debugging information
<span class="nc" id="L251">                System.out.println();</span>
<span class="nc" id="L252">                System.out.println(&quot;üîß DEBUG: Submitting appointment with exact data:&quot;);</span>
<span class="nc" id="L253">                System.out.printf(&quot;   Ticket ID: %d\n&quot;, newAppointment.getTicketId());</span>
<span class="nc" id="L254">                System.out.printf(&quot;   Technician ID: %d\n&quot;, newAppointment.getTechnicianId());</span>
<span class="nc" id="L255">                System.out.printf(&quot;   Start Time: %s\n&quot;, newAppointment.getScheduledStartTime().toString());</span>
<span class="nc" id="L256">                System.out.printf(&quot;   End Time: %s\n&quot;, newAppointment.getScheduledEndTime().toString());</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">                System.out.printf(&quot;   Notes: %s\n&quot;, newAppointment.getNotes() != null ? &quot;\&quot;&quot; + newAppointment.getNotes() + &quot;\&quot;&quot; : &quot;null&quot;);</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">                System.out.printf(&quot;   Status: %s\n&quot;, newAppointment.getStatus() != null ? newAppointment.getStatus() : &quot;null (will be set by server)&quot;);</span>
<span class="nc" id="L259">                System.out.println(&quot;   Timestamp: &quot; + java.time.LocalDateTime.now());</span>
<span class="nc" id="L260">                System.out.println();</span>
                
<span class="nc" id="L262">                logger.info(&quot;Creating appointment - TicketId: {}, TechnicianId: {}, Start: {}, End: {}&quot;, </span>
<span class="nc" id="L263">                    newAppointment.getTicketId(), </span>
<span class="nc" id="L264">                    newAppointment.getTechnicianId(),</span>
<span class="nc" id="L265">                    newAppointment.getScheduledStartTime(),</span>
<span class="nc" id="L266">                    newAppointment.getScheduledEndTime());</span>
                
<span class="nc" id="L268">                createdAppointment = apiService.createAppointment(newAppointment);</span>
                
<span class="nc" id="L270">                DisplayUtils.printSuccess(&quot;‚úÖ Appointment scheduled successfully!&quot;);</span>
<span class="nc" id="L271">                System.out.printf(&quot;   Appointment ID: #%d\n&quot;, createdAppointment.getId());</span>
<span class="nc" id="L272">                System.out.printf(&quot;   Status: %s (requires confirmation)\n&quot;, createdAppointment.getStatus());</span>
<span class="nc" id="L273">                System.out.printf(&quot;   Scheduled: %s - %s\n&quot;, </span>
<span class="nc" id="L274">                    formatDateTime(createdAppointment.getScheduledStartTime()),</span>
<span class="nc" id="L275">                    formatDateTime(createdAppointment.getScheduledEndTime()));</span>
<span class="nc" id="L276">            } catch (ApiException e) {</span>
<span class="nc" id="L277">                logger.error(&quot;API exception during appointment creation&quot;, e);</span>
                
                // Detailed debugging information for troubleshooting
<span class="nc" id="L280">                System.out.println();</span>
<span class="nc" id="L281">                System.out.println(&quot;üö® APPOINTMENT CREATION FAILED - DEBUG INFORMATION:&quot;);</span>
<span class="nc" id="L282">                System.out.println(&quot;‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê&quot;);</span>
<span class="nc" id="L283">                System.out.printf(&quot;Error Type: %s\n&quot;, e.getClass().getSimpleName());</span>
<span class="nc" id="L284">                System.out.printf(&quot;Error Message: %s\n&quot;, e.getMessage());</span>
<span class="nc" id="L285">                System.out.printf(&quot;Timestamp: %s\n&quot;, java.time.LocalDateTime.now());</span>
<span class="nc" id="L286">                System.out.println();</span>
                
<span class="nc" id="L288">                System.out.println(&quot;üìä REQUEST DATA SENT TO SERVER:&quot;);</span>
<span class="nc" id="L289">                System.out.printf(&quot;   Ticket ID: %d\n&quot;, newAppointment.getTicketId());</span>
<span class="nc" id="L290">                System.out.printf(&quot;   Technician ID: %d\n&quot;, newAppointment.getTechnicianId());</span>
<span class="nc" id="L291">                System.out.printf(&quot;   Start Time (ISO): %s\n&quot;, newAppointment.getScheduledStartTime().toString());</span>
<span class="nc" id="L292">                System.out.printf(&quot;   End Time (ISO): %s\n&quot;, newAppointment.getScheduledEndTime().toString());</span>
<span class="nc" id="L293">                System.out.printf(&quot;   Duration: %d minutes\n&quot;, </span>
<span class="nc" id="L294">                    java.time.Duration.between(newAppointment.getScheduledStartTime(), newAppointment.getScheduledEndTime()).toMinutes());</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">                System.out.printf(&quot;   Notes: %s\n&quot;, newAppointment.getNotes() != null ? &quot;\&quot;&quot; + newAppointment.getNotes() + &quot;\&quot;&quot; : &quot;null&quot;);</span>
<span class="nc" id="L296">                System.out.println();</span>
                
                // Enhanced error analysis based on error type
<span class="nc bnc" id="L299" title="All 4 branches missed.">                if (e.getMessage().contains(&quot;500&quot;) || e.getMessage().contains(&quot;Internal Server Error&quot;)) {</span>
<span class="nc" id="L300">                    DisplayUtils.printError(&quot;‚ö†Ô∏è  SERVER ERROR (500) - Server-side validation or processing failed&quot;);</span>
<span class="nc" id="L301">                    System.out.println();</span>
<span class="nc" id="L302">                    System.out.println(&quot;üîç IMMEDIATE DIAGNOSTIC STEPS:&quot;);</span>
<span class="nc" id="L303">                    System.out.println(&quot;   1. Check server logs for stack trace at &quot; + java.time.LocalDateTime.now());</span>
<span class="nc" id="L304">                    System.out.println(&quot;   2. Verify these entities still exist and have correct status:&quot;);</span>
<span class="nc" id="L305">                    System.out.printf(&quot;      - Ticket #%d should be OPEN\n&quot;, newAppointment.getTicketId());</span>
<span class="nc" id="L306">                    System.out.printf(&quot;      - Technician #%d should be ACTIVE\n&quot;, newAppointment.getTechnicianId());</span>
<span class="nc" id="L307">                    System.out.println(&quot;   3. Check for database constraint violations&quot;);</span>
<span class="nc" id="L308">                    System.out.println(&quot;   4. Look for race conditions (another user modifying data)&quot;);</span>
<span class="nc" id="L309">                    System.out.println();</span>
<span class="nc" id="L310">                    System.out.println(&quot;üîß SERVER-SIDE ISSUES TO INVESTIGATE:&quot;);</span>
<span class="nc" id="L311">                    System.out.println(&quot;   ‚Ä¢ Database connection/transaction failures&quot;);</span>
<span class="nc" id="L312">                    System.out.println(&quot;   ‚Ä¢ JPQL query errors in conflict detection&quot;);</span>
<span class="nc" id="L313">                    System.out.println(&quot;   ‚Ä¢ Foreign key constraint violations&quot;);</span>
<span class="nc" id="L314">                    System.out.println(&quot;   ‚Ä¢ Business rule enforcement at DB level&quot;);</span>
<span class="nc" id="L315">                    System.out.println(&quot;   ‚Ä¢ Timezone handling issues&quot;);</span>
                    
<span class="nc bnc" id="L317" title="All 4 branches missed.">                } else if (e.getMessage().contains(&quot;400&quot;) || e.getMessage().contains(&quot;Bad Request&quot;)) {</span>
<span class="nc" id="L318">                    DisplayUtils.printError(&quot;‚ö†Ô∏è  BAD REQUEST (400) - Data format/validation error&quot;);</span>
<span class="nc" id="L319">                    System.out.println();</span>
<span class="nc" id="L320">                    System.out.println(&quot;üîç DATA FORMAT ISSUES:&quot;);</span>
<span class="nc" id="L321">                    System.out.println(&quot;   ‚Ä¢ Date format: Check if server expects different ISO format&quot;);</span>
<span class="nc" id="L322">                    System.out.println(&quot;   ‚Ä¢ Field validation: Server may have stricter rules than client&quot;);</span>
<span class="nc" id="L323">                    System.out.println(&quot;   ‚Ä¢ Required fields: Server may expect additional fields&quot;);</span>
                    
<span class="nc bnc" id="L325" title="All 4 branches missed.">                } else if (e.getMessage().contains(&quot;409&quot;) || e.getMessage().contains(&quot;Conflict&quot;)) {</span>
<span class="nc" id="L326">                    DisplayUtils.printError(&quot;‚ö†Ô∏è  CONFLICT (409) - Scheduling conflict detected by server&quot;);</span>
<span class="nc" id="L327">                    System.out.println();</span>
<span class="nc" id="L328">                    System.out.println(&quot;üîç CONFLICT ANALYSIS:&quot;);</span>
<span class="nc" id="L329">                    System.out.println(&quot;   ‚Ä¢ Server found conflicts that client validation missed&quot;);</span>
<span class="nc" id="L330">                    System.out.println(&quot;   ‚Ä¢ Race condition: Another appointment created between validation and submission&quot;);</span>
<span class="nc" id="L331">                    System.out.println(&quot;   ‚Ä¢ Different conflict detection logic on server vs client&quot;);</span>
                    
<span class="nc bnc" id="L333" title="All 4 branches missed.">                } else if (e.getMessage().contains(&quot;404&quot;) || e.getMessage().contains(&quot;Not Found&quot;)) {</span>
<span class="nc" id="L334">                    DisplayUtils.printError(&quot;‚ö†Ô∏è  NOT FOUND (404) - Referenced entity not found&quot;);</span>
<span class="nc" id="L335">                    System.out.println();</span>
<span class="nc" id="L336">                    System.out.println(&quot;üîç ENTITY VERIFICATION NEEDED:&quot;);</span>
<span class="nc" id="L337">                    System.out.printf(&quot;   ‚Ä¢ Ticket #%d may have been deleted\n&quot;, newAppointment.getTicketId());</span>
<span class="nc" id="L338">                    System.out.printf(&quot;   ‚Ä¢ Technician #%d may have been deleted\n&quot;, newAppointment.getTechnicianId());</span>
<span class="nc" id="L339">                    System.out.println(&quot;   ‚Ä¢ Database referential integrity issues&quot;);</span>
                    
                } else {
<span class="nc" id="L342">                    DisplayUtils.printError(&quot;‚ö†Ô∏è  UNEXPECTED ERROR - &quot; + e.getMessage());</span>
<span class="nc" id="L343">                    System.out.println();</span>
<span class="nc" id="L344">                    System.out.println(&quot;üîç GENERAL TROUBLESHOOTING:&quot;);</span>
<span class="nc" id="L345">                    System.out.println(&quot;   ‚Ä¢ Network connectivity issues&quot;);</span>
<span class="nc" id="L346">                    System.out.println(&quot;   ‚Ä¢ Server unavailable or overloaded&quot;);</span>
<span class="nc" id="L347">                    System.out.println(&quot;   ‚Ä¢ API endpoint changes&quot;);</span>
<span class="nc" id="L348">                    System.out.println(&quot;   ‚Ä¢ Authentication/authorization issues&quot;);</span>
                }
                
<span class="nc" id="L351">                System.out.println();</span>
<span class="nc" id="L352">                System.out.println(&quot;üí° IMMEDIATE WORKAROUNDS TO TRY:&quot;);</span>
<span class="nc" id="L353">                System.out.println(&quot;   1. Try with a different technician&quot;);</span>
<span class="nc" id="L354">                System.out.println(&quot;   2. Try with a different time slot (30 min later)&quot;);</span>
<span class="nc" id="L355">                System.out.println(&quot;   3. Try with a different ticket&quot;);</span>
<span class="nc" id="L356">                System.out.println(&quot;   4. Wait 1-2 minutes and retry (in case of race condition)&quot;);</span>
<span class="nc" id="L357">                System.out.println();</span>
                
                // Offer to run diagnostic checks
<span class="nc" id="L360">                System.out.print(&quot;üîπ Run diagnostic checks to verify current entity states? (y/n): &quot;);</span>
<span class="nc" id="L361">                String runDiagnostics = scanner.nextLine().trim().toLowerCase();</span>
                
<span class="nc bnc" id="L363" title="All 4 branches missed.">                if (runDiagnostics.equals(&quot;y&quot;) || runDiagnostics.equals(&quot;yes&quot;)) {</span>
<span class="nc" id="L364">                    runAppointmentDiagnostics(newAppointment);</span>
                }
                
<span class="nc" id="L367">                waitForEnter();</span>
<span class="nc" id="L368">                return;</span>
<span class="nc" id="L369">            }</span>
            
            // Ask if user wants to confirm immediately
<span class="nc" id="L372">            System.out.print(&quot;\nüîπ Confirm this appointment now? (y/n): &quot;);</span>
<span class="nc" id="L373">            String confirmChoice = scanner.nextLine().trim().toLowerCase();</span>
            
<span class="nc bnc" id="L375" title="All 4 branches missed.">            if (confirmChoice.equals(&quot;y&quot;) || confirmChoice.equals(&quot;yes&quot;)) {</span>
                try {
<span class="nc" id="L377">                    Appointment confirmedAppointment = apiService.confirmAppointment(createdAppointment.getId());</span>
<span class="nc" id="L378">                    DisplayUtils.printSuccess(&quot;‚úÖ Appointment confirmed! Status: &quot; + confirmedAppointment.getStatus());</span>
<span class="nc" id="L379">                } catch (ApiException e) {</span>
<span class="nc" id="L380">                    logger.error(&quot;Failed to confirm appointment&quot;, e);</span>
<span class="nc" id="L381">                    DisplayUtils.printError(&quot;Failed to confirm appointment: &quot; + e.getMessage());</span>
<span class="nc" id="L382">                    System.out.println(&quot;The appointment was created but confirmation failed. You can confirm it later.&quot;);</span>
<span class="nc" id="L383">                }</span>
            }
            
<span class="nc" id="L386">        } catch (Exception e) {</span>
<span class="nc" id="L387">            logger.error(&quot;Unexpected error during appointment creation&quot;, e);</span>
<span class="nc" id="L388">            DisplayUtils.printError(&quot;An unexpected error occurred while scheduling the appointment.&quot;);</span>
<span class="nc" id="L389">            System.out.println(&quot;This may indicate a system issue. Please try again or contact support.&quot;);</span>
<span class="nc" id="L390">        }</span>
        
<span class="nc" id="L392">        waitForEnter();</span>
<span class="nc" id="L393">    }</span>
    
    private void viewAppointmentDetails() {
<span class="nc" id="L396">        DisplayUtils.printHeader(&quot;APPOINTMENT DETAILS&quot;);</span>
        
        try {
<span class="nc" id="L399">            List&lt;Appointment&gt; appointments = apiService.getAllAppointments();</span>
            
<span class="nc bnc" id="L401" title="All 2 branches missed.">            if (appointments.isEmpty()) {</span>
<span class="nc" id="L402">                System.out.println(&quot;üì≠ No appointments found in the system.&quot;);</span>
<span class="nc" id="L403">                waitForEnter();</span>
<span class="nc" id="L404">                return;</span>
            }
            
            // Display appointment selection
<span class="nc" id="L408">            System.out.println(&quot;üìã Select an appointment to view details:&quot;);</span>
<span class="nc" id="L409">            System.out.println();</span>
<span class="nc" id="L410">            displayAppointmentsTable(appointments);</span>
            
<span class="nc" id="L412">            System.out.print(&quot;Enter appointment ID: &quot;);</span>
<span class="nc" id="L413">            String input = scanner.nextLine().trim();</span>
            
            try {
<span class="nc" id="L416">                Long appointmentId = Long.parseLong(input);</span>
<span class="nc" id="L417">                Appointment selectedAppointment = appointments.stream()</span>
<span class="nc" id="L418">                    .filter(a -&gt; a.getId().equals(appointmentId))</span>
<span class="nc" id="L419">                    .findFirst()</span>
<span class="nc" id="L420">                    .orElse(null);</span>
                    
<span class="nc bnc" id="L422" title="All 2 branches missed.">                if (selectedAppointment != null) {</span>
<span class="nc" id="L423">                    displayAppointmentDetails(selectedAppointment);</span>
                } else {
<span class="nc" id="L425">                    DisplayUtils.printError(&quot;Appointment not found with ID: &quot; + appointmentId);</span>
                }
                
<span class="nc" id="L428">            } catch (NumberFormatException e) {</span>
<span class="nc" id="L429">                DisplayUtils.printError(&quot;Invalid appointment ID format.&quot;);</span>
<span class="nc" id="L430">            }</span>
            
<span class="nc" id="L432">        } catch (ApiException e) {</span>
<span class="nc" id="L433">            logger.error(&quot;Failed to fetch appointments for details view&quot;, e);</span>
<span class="nc" id="L434">            DisplayUtils.printError(&quot;Failed to retrieve appointments: &quot; + e.getMessage());</span>
<span class="nc" id="L435">        }</span>
        
<span class="nc" id="L437">        waitForEnter();</span>
<span class="nc" id="L438">    }</span>
    
    private void cancelAndRecreateAppointment() {
<span class="nc" id="L441">        DisplayUtils.printHeader(&quot;CANCEL &amp; RECREATE APPOINTMENT&quot;);</span>
        
<span class="nc" id="L443">        System.out.println(&quot;‚ö†Ô∏è  API LIMITATION NOTICE:&quot;);</span>
<span class="nc" id="L444">        System.out.println(&quot;   The API does not support direct time/technician updates.&quot;);</span>
<span class="nc" id="L445">        System.out.println(&quot;   This process will:&quot;);</span>
<span class="nc" id="L446">        System.out.println(&quot;   1Ô∏è‚É£ Cancel the existing appointment&quot;);</span>
<span class="nc" id="L447">        System.out.println(&quot;   2Ô∏è‚É£ Create a new appointment with your changes&quot;);</span>
<span class="nc" id="L448">        System.out.println(&quot;   3Ô∏è‚É£ Preserve audit trail through cancellation reason&quot;);</span>
<span class="nc" id="L449">        System.out.println();</span>
        
        try {
<span class="nc" id="L452">            List&lt;Appointment&gt; appointments = apiService.getAllAppointments().stream()</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">                .filter(a -&gt; !&quot;COMPLETED&quot;.equals(a.getStatus()) &amp;&amp; </span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">                           !&quot;CANCELLED&quot;.equals(a.getStatus()) &amp;&amp; </span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">                           !&quot;NO_SHOW&quot;.equals(a.getStatus()))</span>
<span class="nc" id="L456">                .collect(Collectors.toList());</span>
            
<span class="nc bnc" id="L458" title="All 2 branches missed.">            if (appointments.isEmpty()) {</span>
<span class="nc" id="L459">                System.out.println(&quot;üì≠ No modifiable appointments found.&quot;);</span>
<span class="nc" id="L460">                waitForEnter();</span>
<span class="nc" id="L461">                return;</span>
            }
            
<span class="nc" id="L464">            System.out.println(&quot;üìã Select appointment to modify:&quot;);</span>
<span class="nc" id="L465">            System.out.println(&quot;   (Only non-terminal appointments can be modified)&quot;);</span>
<span class="nc" id="L466">            System.out.println();</span>
<span class="nc" id="L467">            displayAppointmentsTable(appointments);</span>
            
<span class="nc" id="L469">            System.out.print(&quot;Enter appointment ID to modify: &quot;);</span>
<span class="nc" id="L470">            String input = scanner.nextLine().trim();</span>
            
            try {
<span class="nc" id="L473">                Long appointmentId = Long.parseLong(input);</span>
<span class="nc" id="L474">                Appointment selectedAppointment = appointments.stream()</span>
<span class="nc" id="L475">                    .filter(a -&gt; a.getId().equals(appointmentId))</span>
<span class="nc" id="L476">                    .findFirst()</span>
<span class="nc" id="L477">                    .orElse(null);</span>
                    
<span class="nc bnc" id="L479" title="All 2 branches missed.">                if (selectedAppointment == null) {</span>
<span class="nc" id="L480">                    DisplayUtils.printError(&quot;Appointment not found or cannot be modified.&quot;);</span>
<span class="nc" id="L481">                    waitForEnter();</span>
<span class="nc" id="L482">                    return;</span>
                }
                
                // Display current appointment details
<span class="nc" id="L486">                System.out.println();</span>
<span class="nc" id="L487">                System.out.println(&quot;üìÑ CURRENT APPOINTMENT:&quot;);</span>
<span class="nc" id="L488">                displayAppointmentDetails(selectedAppointment);</span>
                
                // Confirm the operation
<span class="nc" id="L491">                System.out.printf(&quot;‚ùì Proceed to cancel appointment #%d and create a new one? (y/n): &quot;, appointmentId);</span>
<span class="nc" id="L492">                String confirm = scanner.nextLine().trim().toLowerCase();</span>
                
<span class="nc bnc" id="L494" title="All 4 branches missed.">                if (!confirm.equals(&quot;y&quot;) &amp;&amp; !confirm.equals(&quot;yes&quot;)) {</span>
<span class="nc" id="L495">                    System.out.println(&quot;‚ùå Operation cancelled.&quot;);</span>
<span class="nc" id="L496">                    waitForEnter();</span>
<span class="nc" id="L497">                    return;</span>
                }
                
                // Step 1: Cancel the existing appointment
<span class="nc" id="L501">                System.out.println();</span>
<span class="nc" id="L502">                System.out.println(&quot;üóëÔ∏è  STEP 1: Cancelling existing appointment...&quot;);</span>
<span class="nc" id="L503">                String cancellationReason = &quot;Cancelled for modification - recreating with updated details&quot;;</span>
                
                try {
<span class="nc" id="L506">                    apiService.cancelAppointment(appointmentId, cancellationReason);</span>
<span class="nc" id="L507">                    DisplayUtils.printSuccess(&quot;‚úÖ Original appointment cancelled successfully&quot;);</span>
<span class="nc" id="L508">                } catch (ApiException e) {</span>
<span class="nc" id="L509">                    DisplayUtils.printError(&quot;‚ùå Failed to cancel original appointment: &quot; + e.getMessage());</span>
<span class="nc" id="L510">                    waitForEnter();</span>
<span class="nc" id="L511">                    return;</span>
<span class="nc" id="L512">                }</span>
                
                // Step 2: Create new appointment with updated details
<span class="nc" id="L515">                System.out.println();</span>
<span class="nc" id="L516">                System.out.println(&quot;üìÖ STEP 2: Creating new appointment...&quot;);</span>
<span class="nc" id="L517">                System.out.println(&quot;   (You can modify any details - times, technician, notes, etc.)&quot;);</span>
<span class="nc" id="L518">                System.out.println();</span>
                
                // Create new appointment (user will input all details fresh)
<span class="nc" id="L521">                Appointment newAppointment = appointmentBuilder.buildNewAppointment();</span>
                
<span class="nc bnc" id="L523" title="All 2 branches missed.">                if (newAppointment == null) {</span>
<span class="nc" id="L524">                    System.out.println(&quot;‚ùå New appointment creation cancelled.&quot;);</span>
<span class="nc" id="L525">                    System.out.println(&quot;‚ö†Ô∏è  WARNING: Original appointment was already cancelled!&quot;);</span>
<span class="nc" id="L526">                    System.out.println(&quot;   You may need to manually recreate the appointment.&quot;);</span>
<span class="nc" id="L527">                    waitForEnter();</span>
<span class="nc" id="L528">                    return;</span>
                }
                
                // Create the new appointment
                try {
<span class="nc" id="L533">                    Appointment createdAppointment = apiService.createAppointment(newAppointment);</span>
                    
<span class="nc" id="L535">                    System.out.println();</span>
<span class="nc" id="L536">                    DisplayUtils.printSuccess(&quot;‚úÖ APPOINTMENT MODIFICATION COMPLETED!&quot;);</span>
<span class="nc" id="L537">                    System.out.printf(&quot;   Cancelled: Appointment #%d\n&quot;, appointmentId);</span>
<span class="nc" id="L538">                    System.out.printf(&quot;   Created:   Appointment #%d\n&quot;, createdAppointment.getId());</span>
<span class="nc" id="L539">                    System.out.printf(&quot;   Status:    %s\n&quot;, createdAppointment.getStatus());</span>
<span class="nc" id="L540">                    System.out.printf(&quot;   New Time:  %s - %s\n&quot;, </span>
<span class="nc" id="L541">                        formatDateTime(createdAppointment.getScheduledStartTime()),</span>
<span class="nc" id="L542">                        formatDateTime(createdAppointment.getScheduledEndTime()));</span>
                    
<span class="nc" id="L544">                } catch (ApiException e) {</span>
<span class="nc" id="L545">                    DisplayUtils.printError(&quot;‚ùå Failed to create new appointment: &quot; + e.getMessage());</span>
<span class="nc" id="L546">                    System.out.println(&quot;‚ö†Ô∏è  CRITICAL: Original appointment was cancelled but new one failed!&quot;);</span>
<span class="nc" id="L547">                    System.out.println(&quot;   You may need to manually recreate the appointment.&quot;);</span>
<span class="nc" id="L548">                }</span>
                
<span class="nc" id="L550">            } catch (NumberFormatException e) {</span>
<span class="nc" id="L551">                DisplayUtils.printError(&quot;Invalid appointment ID format.&quot;);</span>
<span class="nc" id="L552">            }</span>
            
<span class="nc" id="L554">        } catch (ApiException e) {</span>
<span class="nc" id="L555">            logger.error(&quot;Failed to modify appointment&quot;, e);</span>
<span class="nc" id="L556">            DisplayUtils.printError(&quot;Failed to modify appointment: &quot; + e.getMessage());</span>
<span class="nc" id="L557">        }</span>
        
<span class="nc" id="L559">        waitForEnter();</span>
<span class="nc" id="L560">    }</span>
    
    private void confirmAppointment() {
<span class="nc" id="L563">        updateAppointmentStatus(&quot;CONFIRM&quot;, &quot;PENDING&quot;, </span>
<span class="nc" id="L564">            apiService::confirmAppointment, </span>
            &quot;Confirm appointment (PENDING ‚Üí CONFIRMED)&quot;);
<span class="nc" id="L566">    }</span>
    
    private void startAppointment() {
<span class="nc" id="L569">        updateAppointmentStatus(&quot;START&quot;, &quot;CONFIRMED&quot;, </span>
<span class="nc" id="L570">            apiService::startAppointment, </span>
            &quot;Start appointment (CONFIRMED ‚Üí IN_PROGRESS)&quot;);
<span class="nc" id="L572">    }</span>
    
    private void completeAppointment() {
<span class="nc" id="L575">        DisplayUtils.printHeader(&quot;COMPLETE APPOINTMENT&quot;);</span>
        
        try {
<span class="nc" id="L578">            List&lt;Appointment&gt; appointments = apiService.getAllAppointments().stream()</span>
<span class="nc" id="L579">                .filter(a -&gt; &quot;IN_PROGRESS&quot;.equals(a.getStatus()))</span>
<span class="nc" id="L580">                .collect(Collectors.toList());</span>
            
<span class="nc bnc" id="L582" title="All 2 branches missed.">            if (appointments.isEmpty()) {</span>
<span class="nc" id="L583">                System.out.println(&quot;üì≠ No in-progress appointments to complete.&quot;);</span>
<span class="nc" id="L584">                waitForEnter();</span>
<span class="nc" id="L585">                return;</span>
            }
            
<span class="nc" id="L588">            System.out.println(&quot;üìã Select appointment to complete:&quot;);</span>
<span class="nc" id="L589">            System.out.println(&quot;   (Only IN_PROGRESS appointments can be completed)&quot;);</span>
<span class="nc" id="L590">            System.out.println();</span>
<span class="nc" id="L591">            displayAppointmentsTable(appointments);</span>
            
<span class="nc" id="L593">            System.out.print(&quot;Enter appointment ID to complete: &quot;);</span>
<span class="nc" id="L594">            String input = scanner.nextLine().trim();</span>
            
            try {
<span class="nc" id="L597">                Long appointmentId = Long.parseLong(input);</span>
<span class="nc" id="L598">                Appointment selectedAppointment = appointments.stream()</span>
<span class="nc" id="L599">                    .filter(a -&gt; a.getId().equals(appointmentId))</span>
<span class="nc" id="L600">                    .findFirst()</span>
<span class="nc" id="L601">                    .orElse(null);</span>
                    
<span class="nc bnc" id="L603" title="All 2 branches missed.">                if (selectedAppointment == null) {</span>
<span class="nc" id="L604">                    DisplayUtils.printError(&quot;Appointment not found or not in IN_PROGRESS status.&quot;);</span>
<span class="nc" id="L605">                    waitForEnter();</span>
<span class="nc" id="L606">                    return;</span>
                }
                
                // Collect completion notes
<span class="nc" id="L610">                System.out.print(&quot;Completion notes (optional): &quot;);</span>
<span class="nc" id="L611">                String notes = scanner.nextLine().trim();</span>
                
                // Confirm completion
<span class="nc" id="L614">                System.out.printf(&quot;‚úÖ Complete appointment #%d? (y/n): &quot;, appointmentId);</span>
<span class="nc" id="L615">                String confirm = scanner.nextLine().trim().toLowerCase();</span>
                
<span class="nc bnc" id="L617" title="All 4 branches missed.">                if (confirm.equals(&quot;y&quot;) || confirm.equals(&quot;yes&quot;)) {</span>
<span class="nc bnc" id="L618" title="All 2 branches missed.">                    Appointment result = apiService.completeAppointment(appointmentId, notes.isEmpty() ? null : notes);</span>
<span class="nc" id="L619">                    DisplayUtils.printSuccess(&quot;‚úÖ Appointment completed successfully!&quot;);</span>
<span class="nc" id="L620">                    System.out.printf(&quot;   Status: %s\n&quot;, result.getStatus());</span>
<span class="nc" id="L621">                } else {</span>
<span class="nc" id="L622">                    System.out.println(&quot;‚ùå Completion cancelled.&quot;);</span>
                }
                
<span class="nc" id="L625">            } catch (NumberFormatException e) {</span>
<span class="nc" id="L626">                DisplayUtils.printError(&quot;Invalid appointment ID format.&quot;);</span>
<span class="nc" id="L627">            }</span>
            
<span class="nc" id="L629">        } catch (ApiException e) {</span>
<span class="nc" id="L630">            logger.error(&quot;Failed to complete appointment&quot;, e);</span>
<span class="nc" id="L631">            DisplayUtils.printError(&quot;Failed to complete appointment: &quot; + e.getMessage());</span>
<span class="nc" id="L632">        }</span>
        
<span class="nc" id="L634">        waitForEnter();</span>
<span class="nc" id="L635">    }</span>
    
    private void cancelAppointment() {
<span class="nc" id="L638">        DisplayUtils.printHeader(&quot;CANCEL APPOINTMENT&quot;);</span>
        
        try {
<span class="nc" id="L641">            List&lt;Appointment&gt; appointments = apiService.getAllAppointments().stream()</span>
<span class="nc bnc" id="L642" title="All 2 branches missed.">                .filter(a -&gt; !&quot;COMPLETED&quot;.equals(a.getStatus()) &amp;&amp; </span>
<span class="nc bnc" id="L643" title="All 2 branches missed.">                           !&quot;CANCELLED&quot;.equals(a.getStatus()) &amp;&amp; </span>
<span class="nc bnc" id="L644" title="All 2 branches missed.">                           !&quot;NO_SHOW&quot;.equals(a.getStatus()))</span>
<span class="nc" id="L645">                .collect(Collectors.toList());</span>
            
<span class="nc bnc" id="L647" title="All 2 branches missed.">            if (appointments.isEmpty()) {</span>
<span class="nc" id="L648">                System.out.println(&quot;üì≠ No cancellable appointments found.&quot;);</span>
<span class="nc" id="L649">                waitForEnter();</span>
<span class="nc" id="L650">                return;</span>
            }
            
<span class="nc" id="L653">            System.out.println(&quot;üìã Select appointment to cancel:&quot;);</span>
<span class="nc" id="L654">            System.out.println(&quot;   (Only non-terminal appointments can be cancelled)&quot;);</span>
<span class="nc" id="L655">            System.out.println();</span>
<span class="nc" id="L656">            displayAppointmentsTable(appointments);</span>
            
<span class="nc" id="L658">            System.out.print(&quot;Enter appointment ID to cancel: &quot;);</span>
<span class="nc" id="L659">            String input = scanner.nextLine().trim();</span>
            
            try {
<span class="nc" id="L662">                Long appointmentId = Long.parseLong(input);</span>
<span class="nc" id="L663">                Appointment selectedAppointment = appointments.stream()</span>
<span class="nc" id="L664">                    .filter(a -&gt; a.getId().equals(appointmentId))</span>
<span class="nc" id="L665">                    .findFirst()</span>
<span class="nc" id="L666">                    .orElse(null);</span>
                    
<span class="nc bnc" id="L668" title="All 2 branches missed.">                if (selectedAppointment == null) {</span>
<span class="nc" id="L669">                    DisplayUtils.printError(&quot;Appointment not found or cannot be cancelled.&quot;);</span>
<span class="nc" id="L670">                    waitForEnter();</span>
<span class="nc" id="L671">                    return;</span>
                }
                
                // Collect cancellation reason
<span class="nc" id="L675">                System.out.print(&quot;Cancellation reason: &quot;);</span>
<span class="nc" id="L676">                String reason = scanner.nextLine().trim();</span>
                
<span class="nc bnc" id="L678" title="All 2 branches missed.">                if (reason.isEmpty()) {</span>
<span class="nc" id="L679">                    DisplayUtils.printError(&quot;Cancellation reason is required.&quot;);</span>
<span class="nc" id="L680">                    waitForEnter();</span>
<span class="nc" id="L681">                    return;</span>
                }
                
                // Confirm cancellation
<span class="nc" id="L685">                System.out.printf(&quot;‚ùå Cancel appointment #%d? This cannot be undone. (y/n): &quot;, appointmentId);</span>
<span class="nc" id="L686">                String confirm = scanner.nextLine().trim().toLowerCase();</span>
                
<span class="nc bnc" id="L688" title="All 4 branches missed.">                if (confirm.equals(&quot;y&quot;) || confirm.equals(&quot;yes&quot;)) {</span>
<span class="nc" id="L689">                    Appointment result = apiService.cancelAppointment(appointmentId, reason);</span>
<span class="nc" id="L690">                    DisplayUtils.printSuccess(&quot;‚úÖ Appointment cancelled successfully!&quot;);</span>
<span class="nc" id="L691">                    System.out.printf(&quot;   Status: %s\n&quot;, result.getStatus());</span>
<span class="nc" id="L692">                    System.out.printf(&quot;   Reason: %s\n&quot;, reason);</span>
<span class="nc" id="L693">                } else {</span>
<span class="nc" id="L694">                    System.out.println(&quot;‚ùå Cancellation aborted.&quot;);</span>
                }
                
<span class="nc" id="L697">            } catch (NumberFormatException e) {</span>
<span class="nc" id="L698">                DisplayUtils.printError(&quot;Invalid appointment ID format.&quot;);</span>
<span class="nc" id="L699">            }</span>
            
<span class="nc" id="L701">        } catch (ApiException e) {</span>
<span class="nc" id="L702">            logger.error(&quot;Failed to cancel appointment&quot;, e);</span>
<span class="nc" id="L703">            DisplayUtils.printError(&quot;Failed to cancel appointment: &quot; + e.getMessage());</span>
<span class="nc" id="L704">        }</span>
        
<span class="nc" id="L706">        waitForEnter();</span>
<span class="nc" id="L707">    }</span>
    
    private void markNoShow() {
<span class="nc" id="L710">        DisplayUtils.printHeader(&quot;MARK NO-SHOW&quot;);</span>
        
        try {
<span class="nc" id="L713">            List&lt;Appointment&gt; appointments = apiService.getAllAppointments().stream()</span>
<span class="nc bnc" id="L714" title="All 2 branches missed.">                .filter(a -&gt; &quot;CONFIRMED&quot;.equals(a.getStatus()) &amp;&amp; </span>
<span class="nc bnc" id="L715" title="All 2 branches missed.">                           a.getScheduledStartTime() != null &amp;&amp;</span>
<span class="nc bnc" id="L716" title="All 2 branches missed.">                           a.getScheduledStartTime().isBefore(LocalDateTime.now()))</span>
<span class="nc" id="L717">                .collect(Collectors.toList());</span>
            
<span class="nc bnc" id="L719" title="All 2 branches missed.">            if (appointments.isEmpty()) {</span>
<span class="nc" id="L720">                System.out.println(&quot;üì≠ No appointments eligible for no-show marking.&quot;);</span>
<span class="nc" id="L721">                System.out.println(&quot;    (Only confirmed past appointments can be marked as no-show)&quot;);</span>
<span class="nc" id="L722">                waitForEnter();</span>
<span class="nc" id="L723">                return;</span>
            }
            
<span class="nc" id="L726">            System.out.println(&quot;üìã Select appointment to mark as no-show:&quot;);</span>
<span class="nc" id="L727">            System.out.println(&quot;   (Only confirmed past appointments shown)&quot;);</span>
<span class="nc" id="L728">            System.out.println();</span>
<span class="nc" id="L729">            displayAppointmentsTable(appointments);</span>
            
<span class="nc" id="L731">            System.out.print(&quot;Enter appointment ID to mark as no-show: &quot;);</span>
<span class="nc" id="L732">            String input = scanner.nextLine().trim();</span>
            
            try {
<span class="nc" id="L735">                Long appointmentId = Long.parseLong(input);</span>
<span class="nc" id="L736">                Appointment selectedAppointment = appointments.stream()</span>
<span class="nc" id="L737">                    .filter(a -&gt; a.getId().equals(appointmentId))</span>
<span class="nc" id="L738">                    .findFirst()</span>
<span class="nc" id="L739">                    .orElse(null);</span>
                    
<span class="nc bnc" id="L741" title="All 2 branches missed.">                if (selectedAppointment == null) {</span>
<span class="nc" id="L742">                    DisplayUtils.printError(&quot;Appointment not found or not eligible for no-show.&quot;);</span>
<span class="nc" id="L743">                    waitForEnter();</span>
<span class="nc" id="L744">                    return;</span>
                }
                
                // Collect no-show notes
<span class="nc" id="L748">                System.out.print(&quot;No-show notes (optional): &quot;);</span>
<span class="nc" id="L749">                String notes = scanner.nextLine().trim();</span>
                
                // Confirm no-show marking
<span class="nc" id="L752">                System.out.printf(&quot;üëª Mark appointment #%d as no-show? This cannot be undone. (y/n): &quot;, appointmentId);</span>
<span class="nc" id="L753">                String confirm = scanner.nextLine().trim().toLowerCase();</span>
                
<span class="nc bnc" id="L755" title="All 4 branches missed.">                if (confirm.equals(&quot;y&quot;) || confirm.equals(&quot;yes&quot;)) {</span>
<span class="nc bnc" id="L756" title="All 2 branches missed.">                    Appointment result = apiService.markAppointmentNoShow(appointmentId, notes.isEmpty() ? null : notes);</span>
<span class="nc" id="L757">                    DisplayUtils.printSuccess(&quot;‚úÖ Appointment marked as no-show!&quot;);</span>
<span class="nc" id="L758">                    System.out.printf(&quot;   Status: %s\n&quot;, result.getStatus());</span>
<span class="nc" id="L759">                } else {</span>
<span class="nc" id="L760">                    System.out.println(&quot;‚ùå No-show marking cancelled.&quot;);</span>
                }
                
<span class="nc" id="L763">            } catch (NumberFormatException e) {</span>
<span class="nc" id="L764">                DisplayUtils.printError(&quot;Invalid appointment ID format.&quot;);</span>
<span class="nc" id="L765">            }</span>
            
<span class="nc" id="L767">        } catch (ApiException e) {</span>
<span class="nc" id="L768">            logger.error(&quot;Failed to mark appointment as no-show&quot;, e);</span>
<span class="nc" id="L769">            DisplayUtils.printError(&quot;Failed to mark appointment as no-show: &quot; + e.getMessage());</span>
<span class="nc" id="L770">        }</span>
        
<span class="nc" id="L772">        waitForEnter();</span>
<span class="nc" id="L773">    }</span>
    
    private void searchAppointments() {
<span class="nc" id="L776">        DisplayUtils.printHeader(&quot;SEARCH APPOINTMENTS&quot;);</span>
        
<span class="nc" id="L778">        System.out.println(&quot;üîç Search Options:&quot;);</span>
<span class="nc" id="L779">        System.out.println(&quot;   1. Search by Status&quot;);</span>
<span class="nc" id="L780">        System.out.println(&quot;   2. Search by Technician&quot;);</span>
<span class="nc" id="L781">        System.out.println(&quot;   3. Search by Date Range&quot;);</span>
<span class="nc" id="L782">        System.out.println(&quot;   4. View All Appointments&quot;);</span>
<span class="nc" id="L783">        System.out.println();</span>
        
<span class="nc" id="L785">        System.out.print(&quot;Select search option (1-4): &quot;);</span>
<span class="nc" id="L786">        String choice = scanner.nextLine().trim();</span>
        
        try {
<span class="nc" id="L789">            List&lt;Appointment&gt; allAppointments = apiService.getAllAppointments();</span>
            List&lt;Appointment&gt; filteredAppointments;
<span class="nc" id="L791">            String searchCriteria = &quot;&quot;;</span>
            
<span class="nc bnc" id="L793" title="All 4 branches missed.">            switch (choice) {</span>
                case &quot;1&quot;:
<span class="nc" id="L795">                    System.out.println(&quot;Available statuses: PENDING, CONFIRMED, IN_PROGRESS, COMPLETED, CANCELLED, NO_SHOW&quot;);</span>
<span class="nc" id="L796">                    System.out.print(&quot;Enter status: &quot;);</span>
<span class="nc" id="L797">                    String statusQuery = scanner.nextLine().trim().toUpperCase();</span>
<span class="nc bnc" id="L798" title="All 2 branches missed.">                    if (!statusQuery.isEmpty()) {</span>
<span class="nc" id="L799">                        filteredAppointments = allAppointments.stream()</span>
<span class="nc" id="L800">                            .filter(a -&gt; statusQuery.equals(a.getStatus()))</span>
<span class="nc" id="L801">                            .collect(Collectors.toList());</span>
<span class="nc" id="L802">                        searchCriteria = &quot;Status: &quot; + statusQuery;</span>
                    } else {
<span class="nc" id="L804">                        filteredAppointments = allAppointments;</span>
<span class="nc" id="L805">                        searchCriteria = &quot;All appointments&quot;;</span>
                    }
<span class="nc" id="L807">                    break;</span>
                    
                case &quot;2&quot;:
<span class="nc" id="L810">                    System.out.print(&quot;Enter technician name or ID: &quot;);</span>
<span class="nc" id="L811">                    String techQuery = scanner.nextLine().trim().toLowerCase();</span>
<span class="nc bnc" id="L812" title="All 2 branches missed.">                    if (!techQuery.isEmpty()) {</span>
                        // Get technician details for name matching
<span class="nc" id="L814">                        List&lt;Technician&gt; technicians = apiService.getAllTechnicians();</span>
<span class="nc" id="L815">                        filteredAppointments = allAppointments.stream()</span>
<span class="nc" id="L816">                            .filter(a -&gt; {</span>
<span class="nc bnc" id="L817" title="All 2 branches missed.">                                if (a.getTechnicianId() == null) return false;</span>
                                
                                // Check by ID
<span class="nc bnc" id="L820" title="All 2 branches missed.">                                if (techQuery.equals(a.getTechnicianId().toString())) {</span>
<span class="nc" id="L821">                                    return true;</span>
                                }
                                
                                // Check by name
<span class="nc" id="L825">                                Technician tech = technicians.stream()</span>
<span class="nc" id="L826">                                    .filter(t -&gt; t.getId().equals(a.getTechnicianId()))</span>
<span class="nc" id="L827">                                    .findFirst()</span>
<span class="nc" id="L828">                                    .orElse(null);</span>
                                    
<span class="nc bnc" id="L830" title="All 2 branches missed.">                                return tech != null &amp;&amp; </span>
<span class="nc bnc" id="L831" title="All 2 branches missed.">                                       tech.getFullName().toLowerCase().contains(techQuery);</span>
                            })
<span class="nc" id="L833">                            .collect(Collectors.toList());</span>
<span class="nc" id="L834">                        searchCriteria = &quot;Technician: &quot; + techQuery;</span>
<span class="nc" id="L835">                    } else {</span>
<span class="nc" id="L836">                        filteredAppointments = allAppointments;</span>
<span class="nc" id="L837">                        searchCriteria = &quot;All appointments&quot;;</span>
                    }
<span class="nc" id="L839">                    break;</span>
                    
                case &quot;3&quot;:
<span class="nc" id="L842">                    System.out.print(&quot;Enter days ahead to search (default: 7): &quot;);</span>
<span class="nc" id="L843">                    String daysInput = scanner.nextLine().trim();</span>
<span class="nc" id="L844">                    int daysAhead = 7;</span>
                    try {
<span class="nc bnc" id="L846" title="All 2 branches missed.">                        if (!daysInput.isEmpty()) {</span>
<span class="nc" id="L847">                            daysAhead = Integer.parseInt(daysInput);</span>
                        }
<span class="nc" id="L849">                    } catch (NumberFormatException e) {</span>
<span class="nc" id="L850">                        DisplayUtils.printError(&quot;Invalid number, using default 7 days.&quot;);</span>
<span class="nc" id="L851">                    }</span>
                    
<span class="nc" id="L853">                    LocalDateTime cutoff = LocalDateTime.now().plusDays(daysAhead);</span>
<span class="nc" id="L854">                    filteredAppointments = allAppointments.stream()</span>
<span class="nc bnc" id="L855" title="All 2 branches missed.">                        .filter(a -&gt; a.getScheduledStartTime() != null &amp;&amp; </span>
<span class="nc bnc" id="L856" title="All 2 branches missed.">                                   a.getScheduledStartTime().isBefore(cutoff) &amp;&amp;</span>
<span class="nc bnc" id="L857" title="All 2 branches missed.">                                   a.getScheduledStartTime().isAfter(LocalDateTime.now().minusDays(1)))</span>
<span class="nc" id="L858">                        .collect(Collectors.toList());</span>
<span class="nc" id="L859">                    searchCriteria = &quot;Next &quot; + daysAhead + &quot; days&quot;;</span>
<span class="nc" id="L860">                    break;</span>
                    
                case &quot;4&quot;:
                default:
<span class="nc" id="L864">                    filteredAppointments = allAppointments;</span>
<span class="nc" id="L865">                    searchCriteria = &quot;All appointments&quot;;</span>
                    break;
            }
            
<span class="nc" id="L869">            System.out.printf(&quot;\nüìä Search Results: %s\n&quot;, searchCriteria);</span>
            
<span class="nc bnc" id="L871" title="All 2 branches missed.">            if (filteredAppointments.isEmpty()) {</span>
<span class="nc" id="L872">                System.out.println(&quot;üì≠ No appointments found matching your search criteria.&quot;);</span>
            } else {
<span class="nc" id="L874">                System.out.printf(&quot;üìÖ Found %d appointment(s)\n\n&quot;, filteredAppointments.size());</span>
<span class="nc" id="L875">                displayAppointmentsTable(filteredAppointments);</span>
            }
            
<span class="nc" id="L878">        } catch (ApiException e) {</span>
<span class="nc" id="L879">            logger.error(&quot;Failed to search appointments&quot;, e);</span>
<span class="nc" id="L880">            DisplayUtils.printError(&quot;Failed to search appointments: &quot; + e.getMessage());</span>
<span class="nc" id="L881">        }</span>
        
<span class="nc" id="L883">        waitForEnter();</span>
<span class="nc" id="L884">    }</span>
    
    private void appointmentReports() {
<span class="nc" id="L887">        DisplayUtils.printHeader(&quot;APPOINTMENT REPORTS &amp; ANALYTICS&quot;);</span>
        
        try {
<span class="nc" id="L890">            List&lt;Appointment&gt; appointments = apiService.getAllAppointments();</span>
            
<span class="nc bnc" id="L892" title="All 2 branches missed.">            if (appointments.isEmpty()) {</span>
<span class="nc" id="L893">                System.out.println(&quot;üì≠ No appointments found in the system.&quot;);</span>
<span class="nc" id="L894">                waitForEnter();</span>
<span class="nc" id="L895">                return;</span>
            }
            
            // Calculate comprehensive statistics
<span class="nc" id="L899">            long totalCount = appointments.size();</span>
            
            // Status breakdown
<span class="nc" id="L902">            Map&lt;String, Long&gt; statusCounts = appointments.stream()</span>
<span class="nc" id="L903">                .collect(Collectors.groupingBy(</span>
<span class="nc bnc" id="L904" title="All 2 branches missed.">                    a -&gt; a.getStatus() != null ? a.getStatus() : &quot;UNKNOWN&quot;, </span>
<span class="nc" id="L905">                    Collectors.counting()));</span>
            
            // Upcoming vs past
<span class="nc" id="L908">            LocalDateTime now = LocalDateTime.now();</span>
<span class="nc" id="L909">            long upcomingCount = appointments.stream()</span>
<span class="nc bnc" id="L910" title="All 4 branches missed.">                .filter(a -&gt; a.getScheduledStartTime() != null &amp;&amp; a.getScheduledStartTime().isAfter(now))</span>
<span class="nc" id="L911">                .count();</span>
<span class="nc" id="L912">            long pastCount = totalCount - upcomingCount;</span>
            
            // Technician workload
<span class="nc" id="L915">            Map&lt;Long, Long&gt; technicianWorkload = appointments.stream()</span>
<span class="nc bnc" id="L916" title="All 2 branches missed.">                .filter(a -&gt; a.getTechnicianId() != null)</span>
<span class="nc" id="L917">                .collect(Collectors.groupingBy(</span>
                    Appointment::getTechnicianId,
<span class="nc" id="L919">                    Collectors.counting()));</span>
            
            // Display comprehensive report
<span class="nc" id="L922">            System.out.println(&quot;üìä APPOINTMENT SYSTEM OVERVIEW&quot;);</span>
<span class="nc" id="L923">            System.out.println(&quot;‚ïê&quot;.repeat(80));</span>
<span class="nc" id="L924">            System.out.printf(&quot;Total Appointments:      %d\n&quot;, totalCount);</span>
<span class="nc" id="L925">            System.out.printf(&quot;Upcoming Appointments:   %d\n&quot;, upcomingCount);</span>
<span class="nc" id="L926">            System.out.printf(&quot;Past Appointments:       %d\n&quot;, pastCount);</span>
<span class="nc" id="L927">            System.out.println();</span>
            
<span class="nc" id="L929">            System.out.println(&quot;üìà STATUS BREAKDOWN&quot;);</span>
<span class="nc" id="L930">            System.out.println(&quot;‚îÄ&quot;.repeat(40));</span>
<span class="nc" id="L931">            statusCounts.entrySet().stream()</span>
<span class="nc" id="L932">                .sorted(Map.Entry.&lt;String, Long&gt;comparingByValue().reversed())</span>
<span class="nc" id="L933">                .forEach(entry -&gt; {</span>
<span class="nc" id="L934">                    String emoji = getStatusEmoji(entry.getKey());</span>
<span class="nc" id="L935">                    System.out.printf(&quot;  %s %-12s: %d (%.1f%%)\n&quot;, </span>
<span class="nc" id="L936">                        emoji, entry.getKey(), entry.getValue(), </span>
<span class="nc" id="L937">                        (entry.getValue() * 100.0) / totalCount);</span>
<span class="nc" id="L938">                });</span>
            
<span class="nc" id="L940">            System.out.println(&quot;\nüë®‚Äçüîß TECHNICIAN WORKLOAD&quot;);</span>
<span class="nc" id="L941">            System.out.println(&quot;‚îÄ&quot;.repeat(40));</span>
<span class="nc bnc" id="L942" title="All 2 branches missed.">            if (technicianWorkload.isEmpty()) {</span>
<span class="nc" id="L943">                System.out.println(&quot;  No technician assignments found&quot;);</span>
            } else {
<span class="nc" id="L945">                List&lt;Technician&gt; technicians = apiService.getAllTechnicians();</span>
<span class="nc" id="L946">                technicianWorkload.entrySet().stream()</span>
<span class="nc" id="L947">                    .sorted(Map.Entry.&lt;Long, Long&gt;comparingByValue().reversed())</span>
<span class="nc" id="L948">                    .limit(10)</span>
<span class="nc" id="L949">                    .forEach(entry -&gt; {</span>
<span class="nc" id="L950">                        Technician tech = technicians.stream()</span>
<span class="nc" id="L951">                            .filter(t -&gt; t.getId().equals(entry.getKey()))</span>
<span class="nc" id="L952">                            .findFirst()</span>
<span class="nc" id="L953">                            .orElse(null);</span>
<span class="nc bnc" id="L954" title="All 2 branches missed.">                        String name = tech != null ? tech.getFullName() : &quot;ID: &quot; + entry.getKey();</span>
<span class="nc" id="L955">                        System.out.printf(&quot;  %-25s: %d appointments\n&quot;, name, entry.getValue());</span>
<span class="nc" id="L956">                    });</span>
            }
            
            // Next 7 days outlook
<span class="nc" id="L960">            List&lt;Appointment&gt; nextWeek = apiService.getUpcomingAppointments(7);</span>
<span class="nc" id="L961">            System.out.printf(&quot;\nüìÖ NEXT 7 DAYS OUTLOOK\n&quot;);</span>
<span class="nc" id="L962">            System.out.println(&quot;‚îÄ&quot;.repeat(40));</span>
<span class="nc" id="L963">            System.out.printf(&quot;  Scheduled Appointments: %d\n&quot;, nextWeek.size());</span>
            
<span class="nc bnc" id="L965" title="All 2 branches missed.">            if (!nextWeek.isEmpty()) {</span>
<span class="nc" id="L966">                long confirmedNextWeek = nextWeek.stream()</span>
<span class="nc" id="L967">                    .filter(a -&gt; &quot;CONFIRMED&quot;.equals(a.getStatus()))</span>
<span class="nc" id="L968">                    .count();</span>
<span class="nc" id="L969">                long pendingNextWeek = nextWeek.stream()</span>
<span class="nc" id="L970">                    .filter(a -&gt; &quot;PENDING&quot;.equals(a.getStatus()))</span>
<span class="nc" id="L971">                    .count();</span>
                    
<span class="nc" id="L973">                System.out.printf(&quot;  Confirmed:              %d\n&quot;, confirmedNextWeek);</span>
<span class="nc" id="L974">                System.out.printf(&quot;  Pending Confirmation:   %d\n&quot;, pendingNextWeek);</span>
            }
            
<span class="nc" id="L977">        } catch (ApiException e) {</span>
<span class="nc" id="L978">            logger.error(&quot;Failed to generate appointment reports&quot;, e);</span>
<span class="nc" id="L979">            DisplayUtils.printError(&quot;Failed to generate reports: &quot; + e.getMessage());</span>
<span class="nc" id="L980">        }</span>
        
<span class="nc" id="L982">        waitForEnter();</span>
<span class="nc" id="L983">    }</span>
    
    // ==================== UTILITY METHODS ====================
    
    private void updateAppointmentStatus(String operation, String requiredStatus, 
                                       AppointmentStatusUpdater updater, String title) {
<span class="nc" id="L989">        DisplayUtils.printHeader(title.toUpperCase());</span>
        
        try {
<span class="nc" id="L992">            List&lt;Appointment&gt; appointments = apiService.getAllAppointments().stream()</span>
<span class="nc" id="L993">                .filter(a -&gt; requiredStatus.equals(a.getStatus()))</span>
<span class="nc" id="L994">                .collect(Collectors.toList());</span>
            
<span class="nc bnc" id="L996" title="All 2 branches missed.">            if (appointments.isEmpty()) {</span>
<span class="nc" id="L997">                System.out.printf(&quot;üì≠ No %s appointments found.\n&quot;, requiredStatus);</span>
<span class="nc" id="L998">                waitForEnter();</span>
<span class="nc" id="L999">                return;</span>
            }
            
<span class="nc" id="L1002">            System.out.printf(&quot;üìã Select appointment to %s:\n&quot;, operation.toLowerCase());</span>
<span class="nc" id="L1003">            System.out.printf(&quot;   (Only %s appointments shown)\n&quot;, requiredStatus);</span>
<span class="nc" id="L1004">            System.out.println();</span>
<span class="nc" id="L1005">            displayAppointmentsTable(appointments);</span>
            
<span class="nc" id="L1007">            System.out.printf(&quot;Enter appointment ID to %s: &quot;, operation.toLowerCase());</span>
<span class="nc" id="L1008">            String input = scanner.nextLine().trim();</span>
            
            try {
<span class="nc" id="L1011">                Long appointmentId = Long.parseLong(input);</span>
<span class="nc" id="L1012">                Appointment selectedAppointment = appointments.stream()</span>
<span class="nc" id="L1013">                    .filter(a -&gt; a.getId().equals(appointmentId))</span>
<span class="nc" id="L1014">                    .findFirst()</span>
<span class="nc" id="L1015">                    .orElse(null);</span>
                    
<span class="nc bnc" id="L1017" title="All 2 branches missed.">                if (selectedAppointment == null) {</span>
<span class="nc" id="L1018">                    DisplayUtils.printError(&quot;Appointment not found or not in &quot; + requiredStatus + &quot; status.&quot;);</span>
<span class="nc" id="L1019">                    waitForEnter();</span>
<span class="nc" id="L1020">                    return;</span>
                }
                
                // Confirm action
<span class="nc" id="L1024">                System.out.printf(&quot;‚úÖ %s appointment #%d? (y/n): &quot;, operation, appointmentId);</span>
<span class="nc" id="L1025">                String confirm = scanner.nextLine().trim().toLowerCase();</span>
                
<span class="nc bnc" id="L1027" title="All 4 branches missed.">                if (confirm.equals(&quot;y&quot;) || confirm.equals(&quot;yes&quot;)) {</span>
<span class="nc" id="L1028">                    Appointment result = updater.update(appointmentId);</span>
<span class="nc" id="L1029">                    DisplayUtils.printSuccess(&quot;‚úÖ Appointment &quot; + operation.toLowerCase() + &quot;ed successfully!&quot;);</span>
<span class="nc" id="L1030">                    System.out.printf(&quot;   Status: %s\n&quot;, result.getStatus());</span>
<span class="nc" id="L1031">                } else {</span>
<span class="nc" id="L1032">                    System.out.println(&quot;‚ùå &quot; + operation + &quot; cancelled.&quot;);</span>
                }
                
<span class="nc" id="L1035">            } catch (NumberFormatException e) {</span>
<span class="nc" id="L1036">                DisplayUtils.printError(&quot;Invalid appointment ID format.&quot;);</span>
<span class="nc" id="L1037">            }</span>
            
<span class="nc" id="L1039">        } catch (ApiException e) {</span>
<span class="nc" id="L1040">            logger.error(&quot;Failed to {} appointment&quot;, operation.toLowerCase(), e);</span>
<span class="nc" id="L1041">            DisplayUtils.printError(&quot;Failed to &quot; + operation.toLowerCase() + &quot; appointment: &quot; + e.getMessage());</span>
<span class="nc" id="L1042">        }</span>
        
<span class="nc" id="L1044">        waitForEnter();</span>
<span class="nc" id="L1045">    }</span>
    
    @FunctionalInterface
    private interface AppointmentStatusUpdater {
        Appointment update(Long appointmentId) throws ApiException;
    }
    
    // ==================== DISPLAY METHODS ====================
    
    private void displayAppointmentsTable(List&lt;Appointment&gt; appointments) {
<span class="nc" id="L1055">        System.out.println(&quot;‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê&quot;);</span>
<span class="nc" id="L1056">        System.out.println(&quot;‚îÇ ID  ‚îÇ Start Time         ‚îÇ End Time            ‚îÇ Status     ‚îÇ Technician  ‚îÇ Ticket       ‚îÇ&quot;);</span>
<span class="nc" id="L1057">        System.out.println(&quot;‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§&quot;);</span>
        
<span class="nc bnc" id="L1059" title="All 2 branches missed.">        for (Appointment appointment : appointments.stream().limit(20).collect(Collectors.toList())) {</span>
<span class="nc bnc" id="L1060" title="All 2 branches missed.">            String startTime = appointment.getScheduledStartTime() != null ? </span>
<span class="nc" id="L1061">                formatDateTime(appointment.getScheduledStartTime()) : &quot;N/A&quot;;</span>
<span class="nc bnc" id="L1062" title="All 2 branches missed.">            String endTime = appointment.getScheduledEndTime() != null ? </span>
<span class="nc" id="L1063">                formatDateTime(appointment.getScheduledEndTime()) : &quot;N/A&quot;;</span>
<span class="nc" id="L1064">            String status = getStatusDisplay(appointment.getStatus());</span>
<span class="nc" id="L1065">            String technicianInfo = getTechnicianDisplay(appointment.getTechnicianId());</span>
<span class="nc" id="L1066">            String ticketInfo = getTicketDisplay(appointment.getTicketId());</span>
            
<span class="nc" id="L1068">            System.out.printf(&quot;‚îÇ %-3d ‚îÇ %-18s ‚îÇ %-19s ‚îÇ %-10s ‚îÇ %-11s ‚îÇ %-12s ‚îÇ%n&quot;,</span>
<span class="nc" id="L1069">                appointment.getId(),</span>
<span class="nc bnc" id="L1070" title="All 2 branches missed.">                startTime.length() &gt; 18 ? startTime.substring(0, 15) + &quot;...&quot; : startTime,</span>
<span class="nc bnc" id="L1071" title="All 2 branches missed.">                endTime.length() &gt; 19 ? endTime.substring(0, 16) + &quot;...&quot; : endTime,</span>
<span class="nc bnc" id="L1072" title="All 2 branches missed.">                status.length() &gt; 10 ? status.substring(0, 7) + &quot;...&quot; : status,</span>
<span class="nc bnc" id="L1073" title="All 2 branches missed.">                technicianInfo.length() &gt; 11 ? technicianInfo.substring(0, 8) + &quot;...&quot; : technicianInfo,</span>
<span class="nc bnc" id="L1074" title="All 2 branches missed.">                ticketInfo.length() &gt; 12 ? ticketInfo.substring(0, 9) + &quot;...&quot; : ticketInfo);</span>
<span class="nc" id="L1075">        }</span>
        
<span class="nc" id="L1077">        System.out.println(&quot;‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò&quot;);</span>
        
<span class="nc bnc" id="L1079" title="All 2 branches missed.">        if (appointments.size() &gt; 20) {</span>
<span class="nc" id="L1080">            System.out.printf(&quot;... and %d more appointments (showing first 20)\n&quot;, appointments.size() - 20);</span>
        }
<span class="nc" id="L1082">    }</span>
    
    private void displayAppointmentDetails(Appointment appointment) {
<span class="nc" id="L1085">        System.out.println();</span>
<span class="nc" id="L1086">        DisplayUtils.printHeader(&quot;APPOINTMENT DETAILS - #&quot; + appointment.getId());</span>
        
        try {
            // Use embedded entities if available, otherwise fetch from API
<span class="nc" id="L1090">            Ticket ticket = appointment.getTicket();</span>
<span class="nc bnc" id="L1091" title="All 4 branches missed.">            if (ticket == null &amp;&amp; appointment.getTicketId() != null) {</span>
<span class="nc" id="L1092">                ticket = apiService.getTicketById(appointment.getTicketId());</span>
            }
            
<span class="nc" id="L1095">            Technician technician = appointment.getTechnician();</span>
<span class="nc bnc" id="L1096" title="All 4 branches missed.">            if (technician == null &amp;&amp; appointment.getTechnicianId() != null) {</span>
<span class="nc" id="L1097">                List&lt;Technician&gt; technicians = apiService.getAllTechnicians();</span>
<span class="nc" id="L1098">                technician = technicians.stream()</span>
<span class="nc" id="L1099">                    .filter(t -&gt; t.getId().equals(appointment.getTechnicianId()))</span>
<span class="nc" id="L1100">                    .findFirst()</span>
<span class="nc" id="L1101">                    .orElse(null);</span>
            }
            
            // Basic appointment info
<span class="nc" id="L1105">            System.out.printf(&quot;üìÖ Appointment ID: #%d\n&quot;, appointment.getId());</span>
<span class="nc" id="L1106">            System.out.printf(&quot;üìä Status:        %s\n&quot;, getStatusDisplay(appointment.getStatus()));</span>
            
            // Timing information
<span class="nc bnc" id="L1109" title="All 2 branches missed.">            if (appointment.getScheduledStartTime() != null) {</span>
<span class="nc" id="L1110">                System.out.printf(&quot;‚è∞ Start Time:    %s\n&quot;, formatDateTime(appointment.getScheduledStartTime()));</span>
            }
<span class="nc bnc" id="L1112" title="All 2 branches missed.">            if (appointment.getScheduledEndTime() != null) {</span>
<span class="nc" id="L1113">                System.out.printf(&quot;‚è∞ End Time:      %s\n&quot;, formatDateTime(appointment.getScheduledEndTime()));</span>
            }
            
<span class="nc bnc" id="L1116" title="All 4 branches missed.">            if (appointment.getScheduledStartTime() != null &amp;&amp; appointment.getScheduledEndTime() != null) {</span>
<span class="nc" id="L1117">                Duration duration = Duration.between(appointment.getScheduledStartTime(), appointment.getScheduledEndTime());</span>
<span class="nc" id="L1118">                System.out.printf(&quot;‚è±Ô∏è  Duration:      %d hours, %d minutes\n&quot;, </span>
<span class="nc" id="L1119">                    duration.toHours(), duration.toMinutes() % 60);</span>
            }
            
            // Related entities
<span class="nc bnc" id="L1123" title="All 2 branches missed.">            if (ticket != null) {</span>
<span class="nc" id="L1124">                System.out.printf(&quot;üé´ Ticket:        #%d - %s\n&quot;, </span>
<span class="nc" id="L1125">                    ticket.getId(), </span>
<span class="nc bnc" id="L1126" title="All 2 branches missed.">                    ticket.getDescription() != null ? ticket.getDescription() : &quot;No description&quot;);</span>
<span class="nc" id="L1127">                System.out.printf(&quot;   Priority:      %s\n&quot;, ticket.getPriority());</span>
<span class="nc" id="L1128">                System.out.printf(&quot;   Service Type:  %s\n&quot;, ticket.getServiceType());</span>
<span class="nc bnc" id="L1129" title="All 2 branches missed.">                if (ticket.getClientName() != null) {</span>
<span class="nc" id="L1130">                    System.out.printf(&quot;   Client:        %s\n&quot;, ticket.getClientName());</span>
                }
<span class="nc bnc" id="L1132" title="All 2 branches missed.">                if (ticket.getClientEmail() != null) {</span>
<span class="nc" id="L1133">                    System.out.printf(&quot;   Client Email:  %s\n&quot;, ticket.getClientEmail());</span>
                }
<span class="nc bnc" id="L1135" title="All 2 branches missed.">            } else if (appointment.getTicketId() != null) {</span>
<span class="nc" id="L1136">                System.out.printf(&quot;üé´ Ticket:        #%d (details unavailable)\n&quot;, appointment.getTicketId());</span>
            } else {
<span class="nc" id="L1138">                System.out.println(&quot;üé´ Ticket:        Not assigned&quot;);</span>
            }
            
<span class="nc bnc" id="L1141" title="All 2 branches missed.">            if (technician != null) {</span>
<span class="nc" id="L1142">                System.out.printf(&quot;üë®‚Äçüîß Technician:    %s\n&quot;, technician.getFullName());</span>
<span class="nc" id="L1143">                System.out.printf(&quot;   Email:         %s\n&quot;, technician.getEmail());</span>
<span class="nc" id="L1144">                System.out.printf(&quot;   Phone:         %s\n&quot;, </span>
<span class="nc bnc" id="L1145" title="All 2 branches missed.">                    technician.getPhone() != null ? technician.getPhone() : &quot;N/A&quot;);</span>
<span class="nc bnc" id="L1146" title="All 4 branches missed.">                if (technician.getSkills() != null &amp;&amp; !technician.getSkills().isEmpty()) {</span>
<span class="nc" id="L1147">                    System.out.printf(&quot;   Skills:        %s\n&quot;, String.join(&quot;, &quot;, technician.getSkills()));</span>
                }
<span class="nc bnc" id="L1149" title="All 2 branches missed.">            } else if (appointment.getTechnicianId() != null) {</span>
<span class="nc" id="L1150">                System.out.printf(&quot;üë®‚Äçüîß Technician:    ID %d (details unavailable)\n&quot;, appointment.getTechnicianId());</span>
            } else {
<span class="nc" id="L1152">                System.out.println(&quot;üë®‚Äçüîß Technician:    Not assigned&quot;);</span>
            }
            
            // Notes
<span class="nc bnc" id="L1156" title="All 4 branches missed.">            if (appointment.getNotes() != null &amp;&amp; !appointment.getNotes().isEmpty()) {</span>
<span class="nc" id="L1157">                System.out.printf(&quot;üìù Notes:         %s\n&quot;, appointment.getNotes());</span>
            }
            
            // Timestamps
<span class="nc bnc" id="L1161" title="All 2 branches missed.">            if (appointment.getCreatedAt() != null) {</span>
<span class="nc" id="L1162">                System.out.printf(&quot;üìÖ Created:       %s\n&quot;, formatDateTime(appointment.getCreatedAt()));</span>
            }
<span class="nc bnc" id="L1164" title="All 2 branches missed.">            if (appointment.getUpdatedAt() != null) {</span>
<span class="nc" id="L1165">                System.out.printf(&quot;üìÖ Last Updated:  %s\n&quot;, formatDateTime(appointment.getUpdatedAt()));</span>
            }
            
<span class="nc" id="L1168">        } catch (ApiException e) {</span>
<span class="nc" id="L1169">            logger.warn(&quot;Failed to fetch appointment details&quot;, e);</span>
            // Show basic info even if we can't get related entities
<span class="nc" id="L1171">            System.out.printf(&quot;üìÖ Appointment ID: #%d\n&quot;, appointment.getId());</span>
<span class="nc" id="L1172">            System.out.printf(&quot;üìä Status:        %s\n&quot;, appointment.getStatus());</span>
<span class="nc" id="L1173">            System.out.printf(&quot;üé´ Ticket ID:     %d\n&quot;, appointment.getTicketId());</span>
<span class="nc" id="L1174">            System.out.printf(&quot;üë®‚Äçüîß Technician ID: %d\n&quot;, appointment.getTechnicianId());</span>
<span class="nc" id="L1175">        }</span>
        
<span class="nc" id="L1177">        System.out.println();</span>
<span class="nc" id="L1178">    }</span>
    
    private void displayAppointmentSummary(Appointment appointment) {
<span class="nc" id="L1181">        String statusEmoji = getStatusEmoji(appointment.getStatus());</span>
<span class="nc bnc" id="L1182" title="All 2 branches missed.">        String timeInfo = appointment.getScheduledStartTime() != null ? </span>
<span class="nc" id="L1183">            formatDateTime(appointment.getScheduledStartTime()) : &quot;N/A&quot;;</span>
<span class="nc" id="L1184">        String techInfo = getTechnicianDisplay(appointment.getTechnicianId());</span>
        
<span class="nc" id="L1186">        System.out.printf(&quot;   %s Appointment #%d - %s | %s\n&quot;, </span>
<span class="nc" id="L1187">            statusEmoji, appointment.getId(), timeInfo, techInfo);</span>
<span class="nc" id="L1188">    }</span>
    
    private String getStatusDisplay(String status) {
<span class="nc bnc" id="L1191" title="All 9 branches missed.">        return switch (status != null ? status.toUpperCase() : &quot;UNKNOWN&quot;) {</span>
<span class="nc" id="L1192">            case &quot;PENDING&quot; -&gt; &quot;üü° PENDING&quot;;</span>
<span class="nc" id="L1193">            case &quot;CONFIRMED&quot; -&gt; &quot;üü¢ CONFIRMED&quot;;</span>
<span class="nc" id="L1194">            case &quot;IN_PROGRESS&quot; -&gt; &quot;üîµ IN_PROGRESS&quot;;</span>
<span class="nc" id="L1195">            case &quot;COMPLETED&quot; -&gt; &quot;‚úÖ COMPLETED&quot;;</span>
<span class="nc" id="L1196">            case &quot;CANCELLED&quot; -&gt; &quot;‚ùå CANCELLED&quot;;</span>
<span class="nc" id="L1197">            case &quot;NO_SHOW&quot; -&gt; &quot;üëª NO_SHOW&quot;;</span>
<span class="nc" id="L1198">            default -&gt; &quot;‚ùì &quot; + status;</span>
        };
    }
    
    private String getStatusEmoji(String status) {
<span class="nc bnc" id="L1203" title="All 9 branches missed.">        return switch (status != null ? status.toUpperCase() : &quot;UNKNOWN&quot;) {</span>
<span class="nc" id="L1204">            case &quot;PENDING&quot; -&gt; &quot;üü°&quot;;</span>
<span class="nc" id="L1205">            case &quot;CONFIRMED&quot; -&gt; &quot;üü¢&quot;;</span>
<span class="nc" id="L1206">            case &quot;IN_PROGRESS&quot; -&gt; &quot;üîµ&quot;;</span>
<span class="nc" id="L1207">            case &quot;COMPLETED&quot; -&gt; &quot;‚úÖ&quot;;</span>
<span class="nc" id="L1208">            case &quot;CANCELLED&quot; -&gt; &quot;‚ùå&quot;;</span>
<span class="nc" id="L1209">            case &quot;NO_SHOW&quot; -&gt; &quot;üëª&quot;;</span>
<span class="nc" id="L1210">            default -&gt; &quot;‚ùì&quot;;</span>
        };
    }
    
    private String getTechnicianDisplay(Long technicianId) {
<span class="nc bnc" id="L1215" title="All 2 branches missed.">        if (technicianId == null) return &quot;Unassigned&quot;;</span>
        
        try {
<span class="nc" id="L1218">            List&lt;Technician&gt; technicians = apiService.getAllTechnicians();</span>
<span class="nc" id="L1219">            Technician technician = technicians.stream()</span>
<span class="nc" id="L1220">                .filter(t -&gt; t.getId().equals(technicianId))</span>
<span class="nc" id="L1221">                .findFirst()</span>
<span class="nc" id="L1222">                .orElse(null);</span>
            
<span class="nc bnc" id="L1224" title="All 2 branches missed.">            return technician != null ? technician.getFullName() : &quot;ID: &quot; + technicianId;</span>
            
<span class="nc" id="L1226">        } catch (ApiException e) {</span>
<span class="nc" id="L1227">            return &quot;ID: &quot; + technicianId;</span>
        }
    }
    
    private String getTicketDisplay(Long ticketId) {
<span class="nc bnc" id="L1232" title="All 2 branches missed.">        return ticketId != null ? &quot;#&quot; + ticketId : &quot;N/A&quot;;</span>
    }
    
    private String formatDateTime(LocalDateTime dateTime) {
<span class="nc" id="L1236">        return dateTime.format(DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm&quot;));</span>
    }
    
    /**
     * Run comprehensive diagnostics to identify why appointment creation failed
     * 
     * @param failedAppointment the appointment data that failed to create
     */
    private void runAppointmentDiagnostics(Appointment failedAppointment) {
<span class="nc" id="L1245">        System.out.println();</span>
<span class="nc" id="L1246">        DisplayUtils.printHeader(&quot;APPOINTMENT DIAGNOSTIC ANALYSIS&quot;);</span>
        
        try {
<span class="nc" id="L1249">            System.out.println(&quot;üîç Running comprehensive entity verification...&quot;);</span>
<span class="nc" id="L1250">            System.out.println();</span>
            
            // 1. Verify Ticket Status
<span class="nc" id="L1253">            System.out.print(&quot;1Ô∏è‚É£ Checking Ticket Status... &quot;);</span>
            try {
<span class="nc" id="L1255">                Ticket ticket = apiService.getTicketById(failedAppointment.getTicketId());</span>
<span class="nc bnc" id="L1256" title="All 2 branches missed.">                if (&quot;OPEN&quot;.equals(ticket.getStatus())) {</span>
<span class="nc" id="L1257">                    System.out.println(&quot;‚úÖ PASS&quot;);</span>
<span class="nc" id="L1258">                    System.out.printf(&quot;   Ticket #%d: %s (Status: %s)\n&quot;, </span>
<span class="nc" id="L1259">                        ticket.getId(), ticket.getDescription(), ticket.getStatus());</span>
                } else {
<span class="nc" id="L1261">                    System.out.println(&quot;‚ùå FAIL&quot;);</span>
<span class="nc" id="L1262">                    System.out.printf(&quot;   Ticket #%d: Status is '%s' (Expected: OPEN)\n&quot;, </span>
<span class="nc" id="L1263">                        ticket.getId(), ticket.getStatus());</span>
<span class="nc" id="L1264">                    System.out.println(&quot;   üö® ROOT CAUSE: Ticket status changed after validation!&quot;);</span>
                }
<span class="nc" id="L1266">            } catch (ApiException e) {</span>
<span class="nc" id="L1267">                System.out.println(&quot;‚ùå ERROR&quot;);</span>
<span class="nc" id="L1268">                System.out.printf(&quot;   Cannot retrieve ticket #%d: %s\n&quot;, </span>
<span class="nc" id="L1269">                    failedAppointment.getTicketId(), e.getMessage());</span>
<span class="nc" id="L1270">                System.out.println(&quot;   üö® ROOT CAUSE: Ticket may have been deleted!&quot;);</span>
<span class="nc" id="L1271">            }</span>
<span class="nc" id="L1272">            System.out.println();</span>
            
            // 2. Verify Technician Status
<span class="nc" id="L1275">            System.out.print(&quot;2Ô∏è‚É£ Checking Technician Status... &quot;);</span>
            try {
<span class="nc" id="L1277">                List&lt;Technician&gt; technicians = apiService.getAllTechnicians();</span>
<span class="nc" id="L1278">                Technician technician = technicians.stream()</span>
<span class="nc" id="L1279">                    .filter(t -&gt; t.getId().equals(failedAppointment.getTechnicianId()))</span>
<span class="nc" id="L1280">                    .findFirst()</span>
<span class="nc" id="L1281">                    .orElse(null);</span>
                
<span class="nc bnc" id="L1283" title="All 2 branches missed.">                if (technician == null) {</span>
<span class="nc" id="L1284">                    System.out.println(&quot;‚ùå ERROR&quot;);</span>
<span class="nc" id="L1285">                    System.out.printf(&quot;   Technician ID %d not found\n&quot;, failedAppointment.getTechnicianId());</span>
<span class="nc" id="L1286">                    System.out.println(&quot;   üö® ROOT CAUSE: Technician may have been deleted!&quot;);</span>
<span class="nc bnc" id="L1287" title="All 2 branches missed.">                } else if (&quot;ACTIVE&quot;.equals(technician.getStatus())) {</span>
<span class="nc" id="L1288">                    System.out.println(&quot;‚úÖ PASS&quot;);</span>
<span class="nc" id="L1289">                    System.out.printf(&quot;   %s (ID: %d, Status: %s)\n&quot;, </span>
<span class="nc" id="L1290">                        technician.getFullName(), technician.getId(), technician.getStatus());</span>
                } else {
<span class="nc" id="L1292">                    System.out.println(&quot;‚ùå FAIL&quot;);</span>
<span class="nc" id="L1293">                    System.out.printf(&quot;   %s (ID: %d): Status is '%s' (Expected: ACTIVE)\n&quot;, </span>
<span class="nc" id="L1294">                        technician.getFullName(), technician.getId(), technician.getStatus());</span>
<span class="nc" id="L1295">                    System.out.println(&quot;   üö® ROOT CAUSE: Technician status changed after validation!&quot;);</span>
                }
<span class="nc" id="L1297">            } catch (ApiException e) {</span>
<span class="nc" id="L1298">                System.out.println(&quot;‚ùå ERROR&quot;);</span>
<span class="nc" id="L1299">                System.out.printf(&quot;   Cannot retrieve technician data: %s\n&quot;, e.getMessage());</span>
<span class="nc" id="L1300">            }</span>
<span class="nc" id="L1301">            System.out.println();</span>
            
            // 3. Check for Scheduling Conflicts
<span class="nc" id="L1304">            System.out.print(&quot;3Ô∏è‚É£ Checking Scheduling Conflicts... &quot;);</span>
            try {
<span class="nc" id="L1306">                boolean isAvailable = apiService.checkTechnicianAvailability(</span>
<span class="nc" id="L1307">                    failedAppointment.getTechnicianId(),</span>
<span class="nc" id="L1308">                    failedAppointment.getScheduledStartTime(),</span>
<span class="nc" id="L1309">                    failedAppointment.getScheduledEndTime()</span>
                );
                
<span class="nc bnc" id="L1312" title="All 2 branches missed.">                if (isAvailable) {</span>
<span class="nc" id="L1313">                    System.out.println(&quot;‚úÖ PASS&quot;);</span>
<span class="nc" id="L1314">                    System.out.println(&quot;   No scheduling conflicts detected&quot;);</span>
                } else {
<span class="nc" id="L1316">                    System.out.println(&quot;‚ùå FAIL&quot;);</span>
<span class="nc" id="L1317">                    System.out.println(&quot;   Scheduling conflict detected!&quot;);</span>
<span class="nc" id="L1318">                    System.out.println(&quot;   üö® ROOT CAUSE: Another appointment was created since validation!&quot;);</span>
                    
                    // Try to get specific conflict information
                    try {
<span class="nc" id="L1322">                        List&lt;Appointment&gt; conflictingAppointments = apiService.getAllAppointments().stream()</span>
<span class="nc" id="L1323">                            .filter(a -&gt; a.getTechnicianId().equals(failedAppointment.getTechnicianId()))</span>
<span class="nc" id="L1324">                            .filter(a -&gt; {</span>
<span class="nc" id="L1325">                                LocalDateTime start = failedAppointment.getScheduledStartTime();</span>
<span class="nc" id="L1326">                                LocalDateTime end = failedAppointment.getScheduledEndTime();</span>
<span class="nc" id="L1327">                                LocalDateTime aStart = a.getScheduledStartTime();</span>
<span class="nc" id="L1328">                                LocalDateTime aEnd = a.getScheduledEndTime();</span>
                                
<span class="nc bnc" id="L1330" title="All 4 branches missed.">                                return (start.isBefore(aEnd) &amp;&amp; end.isAfter(aStart));</span>
                            })
<span class="nc" id="L1332">                            .collect(Collectors.toList());</span>
                        
<span class="nc bnc" id="L1334" title="All 2 branches missed.">                        if (!conflictingAppointments.isEmpty()) {</span>
<span class="nc" id="L1335">                            System.out.println(&quot;   Conflicting appointments found:&quot;);</span>
<span class="nc bnc" id="L1336" title="All 2 branches missed.">                            for (Appointment conflict : conflictingAppointments.subList(0, Math.min(3, conflictingAppointments.size()))) {</span>
<span class="nc" id="L1337">                                System.out.printf(&quot;   ‚Ä¢ Appointment #%d: %s - %s (Status: %s)\n&quot;,</span>
<span class="nc" id="L1338">                                    conflict.getId(),</span>
<span class="nc" id="L1339">                                    formatDateTime(conflict.getScheduledStartTime()),</span>
<span class="nc" id="L1340">                                    formatDateTime(conflict.getScheduledEndTime()),</span>
<span class="nc" id="L1341">                                    conflict.getStatus());</span>
<span class="nc" id="L1342">                            }</span>
                        }
<span class="nc" id="L1344">                    } catch (Exception ex) {</span>
<span class="nc" id="L1345">                        System.out.println(&quot;   Could not retrieve conflict details: &quot; + ex.getMessage());</span>
<span class="nc" id="L1346">                    }</span>
                }
<span class="nc" id="L1348">            } catch (ApiException e) {</span>
<span class="nc" id="L1349">                System.out.println(&quot;‚ùå ERROR&quot;);</span>
<span class="nc" id="L1350">                System.out.printf(&quot;   Cannot check availability: %s\n&quot;, e.getMessage());</span>
<span class="nc" id="L1351">                System.out.println(&quot;   üö® ROOT CAUSE: Server-side conflict checking is failing!&quot;);</span>
<span class="nc" id="L1352">            }</span>
<span class="nc" id="L1353">            System.out.println();</span>
            
            // 4. Verify Date/Time Constraints
<span class="nc" id="L1356">            System.out.print(&quot;4Ô∏è‚É£ Checking Date/Time Constraints... &quot;);</span>
<span class="nc" id="L1357">            LocalDateTime now = LocalDateTime.now();</span>
<span class="nc" id="L1358">            Duration duration = Duration.between(</span>
<span class="nc" id="L1359">                failedAppointment.getScheduledStartTime(), </span>
<span class="nc" id="L1360">                failedAppointment.getScheduledEndTime()</span>
            );
            
<span class="nc" id="L1363">            boolean futureCheck = failedAppointment.getScheduledStartTime().isAfter(now.plusMinutes(5));</span>
<span class="nc bnc" id="L1364" title="All 4 branches missed.">            boolean durationCheck = duration.toMinutes() &gt;= 30 &amp;&amp; duration.toHours() &lt;= 8;</span>
            
<span class="nc bnc" id="L1366" title="All 4 branches missed.">            if (futureCheck &amp;&amp; durationCheck) {</span>
<span class="nc" id="L1367">                System.out.println(&quot;‚úÖ PASS&quot;);</span>
<span class="nc bnc" id="L1368" title="All 2 branches missed.">                System.out.printf(&quot;   Future date: %s (‚úì)\n&quot;, futureCheck ? &quot;Yes&quot; : &quot;No&quot;);</span>
<span class="nc" id="L1369">                System.out.printf(&quot;   Duration: %d minutes (‚úì)\n&quot;, duration.toMinutes());</span>
            } else {
<span class="nc" id="L1371">                System.out.println(&quot;‚ùå FAIL&quot;);</span>
<span class="nc" id="L1372">                System.out.printf(&quot;   Future date: %s (%s)\n&quot;, </span>
<span class="nc bnc" id="L1373" title="All 4 branches missed.">                    futureCheck ? &quot;Yes&quot; : &quot;No&quot;, futureCheck ? &quot;‚úì&quot; : &quot;‚úó&quot;);</span>
<span class="nc" id="L1374">                System.out.printf(&quot;   Duration: %d minutes (%s)\n&quot;, </span>
<span class="nc bnc" id="L1375" title="All 2 branches missed.">                    duration.toMinutes(), durationCheck ? &quot;‚úì&quot; : &quot;‚úó&quot;);</span>
<span class="nc bnc" id="L1376" title="All 2 branches missed.">                if (!futureCheck) {</span>
<span class="nc" id="L1377">                    System.out.println(&quot;   üö® ROOT CAUSE: Appointment time is in the past!&quot;);</span>
                }
<span class="nc bnc" id="L1379" title="All 2 branches missed.">                if (!durationCheck) {</span>
<span class="nc" id="L1380">                    System.out.println(&quot;   üö® ROOT CAUSE: Duration violates 30min-8hr constraint!&quot;);</span>
                }
            }
<span class="nc" id="L1383">            System.out.println();</span>
            
            // 5. Server Connection Test
<span class="nc" id="L1386">            System.out.print(&quot;5Ô∏è‚É£ Testing Server Connection... &quot;);</span>
            try {
                // Simple API call to test connectivity
<span class="nc" id="L1389">                apiService.getAllAppointments();</span>
<span class="nc" id="L1390">                System.out.println(&quot;‚úÖ PASS&quot;);</span>
<span class="nc" id="L1391">                System.out.println(&quot;   Server is responding to API requests&quot;);</span>
<span class="nc" id="L1392">            } catch (ApiException e) {</span>
<span class="nc" id="L1393">                System.out.println(&quot;‚ùå FAIL&quot;);</span>
<span class="nc" id="L1394">                System.out.printf(&quot;   Server connection issue: %s\n&quot;, e.getMessage());</span>
<span class="nc" id="L1395">                System.out.println(&quot;   üö® ROOT CAUSE: Server connectivity or availability issue!&quot;);</span>
<span class="nc" id="L1396">            }</span>
<span class="nc" id="L1397">            System.out.println();</span>
            
            // Summary and Recommendations
<span class="nc" id="L1400">            System.out.println(&quot;‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê&quot;);</span>
<span class="nc" id="L1401">            System.out.println(&quot;üîß DIAGNOSTIC SUMMARY &amp; RECOMMENDATIONS:&quot;);</span>
<span class="nc" id="L1402">            System.out.println();</span>
<span class="nc" id="L1403">            System.out.println(&quot;Based on the diagnostic results above:&quot;);</span>
<span class="nc" id="L1404">            System.out.println(&quot;‚Ä¢ If all checks PASS: This indicates a server-side processing error&quot;);</span>
<span class="nc" id="L1405">            System.out.println(&quot;‚Ä¢ If any check FAILS: That failure is likely the root cause&quot;);</span>
<span class="nc" id="L1406">            System.out.println();</span>
<span class="nc" id="L1407">            System.out.println(&quot;üìã NEXT STEPS:&quot;);</span>
<span class="nc" id="L1408">            System.out.println(&quot;1. Review any FAILED checks above&quot;);</span>
<span class="nc" id="L1409">            System.out.println(&quot;2. If all checks pass, examine server logs for internal errors&quot;);</span>
<span class="nc" id="L1410">            System.out.println(&quot;3. Try the suggested workarounds (different technician/time)&quot;);</span>
<span class="nc" id="L1411">            System.out.println(&quot;4. Contact system administrator if server-side issues persist&quot;);</span>
            
<span class="nc" id="L1413">        } catch (Exception e) {</span>
<span class="nc" id="L1414">            logger.error(&quot;Error during diagnostic analysis&quot;, e);</span>
<span class="nc" id="L1415">            DisplayUtils.printError(&quot;Diagnostic analysis failed: &quot; + e.getMessage());</span>
<span class="nc" id="L1416">        }</span>
<span class="nc" id="L1417">    }</span>
} 
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>