<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AppointmentBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Local Tech Support CLI Client</a> &gt; <a href="index.source.html" class="el_package">com.localtechsupport.cli.menu.appointment</a> &gt; <span class="el_source">AppointmentBuilder.java</span></div><h1>AppointmentBuilder.java</h1><pre class="source lang-java linenums">package com.localtechsupport.cli.menu.appointment;

import com.localtechsupport.cli.model.Appointment;
import com.localtechsupport.cli.model.Ticket;
import com.localtechsupport.cli.model.Technician;
import com.localtechsupport.cli.util.InputValidator;
import com.localtechsupport.cli.util.DisplayUtils;
import com.localtechsupport.cli.service.ApiService;
import com.localtechsupport.cli.client.ApiException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Arrays;
import java.util.List;
import java.util.Objects;
import java.util.Scanner;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.time.format.DateTimeParseException;
import java.time.Duration;
import java.util.stream.Collectors;

/**
 * Utility class for building appointment objects from user input
 * 
 * Handles collection and validation of appointment data for create/update operations
 * Implements business rules: 30min-8hr duration, only ACTIVE technicians, only OPEN tickets
 */
public class AppointmentBuilder {
    
<span class="nc" id="L31">    private static final Logger logger = LoggerFactory.getLogger(AppointmentBuilder.class);</span>
    private final Scanner scanner;
    private final ApiService apiService;
    
    // Available appointment statuses (for updates only - new appointments start PENDING)
<span class="nc" id="L36">    private static final List&lt;String&gt; APPOINTMENT_STATUSES = Arrays.asList(</span>
        &quot;PENDING&quot;, &quot;CONFIRMED&quot;, &quot;IN_PROGRESS&quot;, &quot;COMPLETED&quot;, &quot;CANCELLED&quot;, &quot;NO_SHOW&quot;
    );
    
    // Business rules
    private static final int MIN_DURATION_MINUTES = 30;
    private static final int MAX_DURATION_HOURS = 8;
    
<span class="nc" id="L44">    public AppointmentBuilder(Scanner scanner, ApiService apiService) {</span>
<span class="nc" id="L45">        this.scanner = scanner;</span>
<span class="nc" id="L46">        this.apiService = apiService;</span>
<span class="nc" id="L47">    }</span>
    
    /**
     * Build a new appointment from user input
     * 
     * @return populated Appointment object or null if cancelled
     */
    public Appointment buildNewAppointment() {
<span class="nc" id="L55">        DisplayUtils.printHeader(&quot;NEW APPOINTMENT SCHEDULING&quot;);</span>
        
<span class="nc" id="L57">        System.out.println(&quot;üìÖ Please provide the following information:&quot;);</span>
<span class="nc" id="L58">        System.out.println(&quot;   Business Rules: 30min-8hr duration, Active technicians only, Open tickets only&quot;);</span>
<span class="nc" id="L59">        System.out.println(&quot;   (Enter 'cancel' at any time to abort)&quot;);</span>
<span class="nc" id="L60">        System.out.println();</span>
        
        try {
            // Collect required fields
<span class="nc" id="L64">            Long ticketId = collectTicketId();</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">            if (ticketId == null) return null;</span>
            
<span class="nc" id="L67">            Long technicianId = collectTechnicianId();</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">            if (technicianId == null) return null;</span>
            
<span class="nc" id="L70">            LocalDateTime startTime = collectStartTime();</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">            if (startTime == null) return null;</span>
            
<span class="nc" id="L73">            LocalDateTime endTime = collectEndTime(startTime);</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">            if (endTime == null) return null;</span>
            
<span class="nc" id="L76">            String notes = collectNotes();</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">            if (notes == null) return null; // Only if user cancelled</span>
            
            // Create appointment object
<span class="nc" id="L80">            Appointment appointment = new Appointment();</span>
<span class="nc" id="L81">            appointment.setTicketId(ticketId);</span>
<span class="nc" id="L82">            appointment.setTechnicianId(technicianId);</span>
<span class="nc" id="L83">            appointment.setScheduledStartTime(startTime);</span>
<span class="nc" id="L84">            appointment.setScheduledEndTime(endTime);</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">            appointment.setNotes(notes.isEmpty() ? null : notes);</span>
            // Server automatically sets: id, status=PENDING, createdAt, updatedAt
            
            // Validate business rules before showing confirmation
<span class="nc bnc" id="L89" title="All 2 branches missed.">            if (!validateBusinessRules(appointment)) {</span>
<span class="nc" id="L90">                return null;</span>
            }
            
            // Show confirmation
<span class="nc" id="L94">            displayAppointmentSummary(appointment, &quot;NEW APPOINTMENT SUMMARY&quot;);</span>
            
<span class="nc" id="L96">            System.out.print(&quot;‚úÖ Schedule this appointment? (y/n): &quot;);</span>
<span class="nc" id="L97">            String confirm = scanner.nextLine().trim().toLowerCase();</span>
            
<span class="nc bnc" id="L99" title="All 4 branches missed.">            if (confirm.equals(&quot;y&quot;) || confirm.equals(&quot;yes&quot;)) {</span>
<span class="nc" id="L100">                return appointment;</span>
            } else {
<span class="nc" id="L102">                System.out.println(&quot;‚ùå Appointment scheduling cancelled.&quot;);</span>
<span class="nc" id="L103">                return null;</span>
            }
            
<span class="nc" id="L106">        } catch (Exception e) {</span>
<span class="nc" id="L107">            logger.error(&quot;Error building new appointment&quot;, e);</span>
<span class="nc" id="L108">            DisplayUtils.printError(&quot;An error occurred while collecting appointment information.&quot;);</span>
<span class="nc" id="L109">            return null;</span>
        }
    }
    
    /**
     * Build appointment update from user input (for rescheduling)
     * 
     * @param existing the existing appointment to update
     * @return updated Appointment object or null if cancelled
     */
    public Appointment buildAppointmentUpdate(Appointment existing) {
<span class="nc" id="L120">        DisplayUtils.printHeader(&quot;RESCHEDULE APPOINTMENT&quot;);</span>
        
<span class="nc" id="L122">        System.out.printf(&quot;üìÖ Rescheduling Appointment #%d\n&quot;, existing.getId());</span>
<span class="nc" id="L123">        System.out.println(&quot;   Current Times: &quot; + formatTimeRange(existing.getScheduledStartTime(), existing.getScheduledEndTime()));</span>
<span class="nc" id="L124">        System.out.println(&quot;   (Enter 'cancel' to abort, or press Enter to keep current values)&quot;);</span>
<span class="nc" id="L125">        System.out.println();</span>
        
        try {
            // Show current appointment details
<span class="nc" id="L129">            displayCurrentAppointmentInfo(existing);</span>
<span class="nc" id="L130">            System.out.println();</span>
            
            // Collect new times (optional - can keep existing)
<span class="nc" id="L133">            LocalDateTime newStartTime = collectOptionalStartTime(existing.getScheduledStartTime());</span>
<span class="nc bnc" id="L134" title="All 4 branches missed.">            if (newStartTime == null &amp;&amp; scanner.hasNext()) return null; // User cancelled</span>
            
<span class="nc" id="L136">            LocalDateTime newEndTime = collectOptionalEndTime(</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">                newStartTime != null ? newStartTime : existing.getScheduledStartTime(),</span>
<span class="nc" id="L138">                existing.getScheduledEndTime()</span>
            );
<span class="nc bnc" id="L140" title="All 4 branches missed.">            if (newEndTime == null &amp;&amp; scanner.hasNext()) return null; // User cancelled</span>
            
            // Optional notes update
<span class="nc" id="L143">            String newNotes = collectOptionalNotes(existing.getNotes());</span>
<span class="nc bnc" id="L144" title="All 4 branches missed.">            if (newNotes == null &amp;&amp; scanner.hasNext()) return null; // User cancelled</span>
            
            // Create updated appointment
<span class="nc" id="L147">            Appointment updated = new Appointment();</span>
<span class="nc" id="L148">            updated.setId(existing.getId());</span>
<span class="nc" id="L149">            updated.setTicketId(existing.getTicketId());</span>
<span class="nc" id="L150">            updated.setTechnicianId(existing.getTechnicianId());</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">            updated.setScheduledStartTime(newStartTime != null ? newStartTime : existing.getScheduledStartTime());</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">            updated.setScheduledEndTime(newEndTime != null ? newEndTime : existing.getScheduledEndTime());</span>
<span class="nc" id="L153">            updated.setStatus(existing.getStatus());</span>
<span class="nc bnc" id="L154" title="All 4 branches missed.">            updated.setNotes(newNotes != null ? (newNotes.isEmpty() ? null : newNotes) : existing.getNotes());</span>
            
            // Validate if times changed
<span class="nc bnc" id="L157" title="All 4 branches missed.">            if (newStartTime != null || newEndTime != null) {</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">                if (!validateBusinessRules(updated)) {</span>
<span class="nc" id="L159">                    return null;</span>
                }
            }
            
            // Show confirmation
<span class="nc" id="L164">            displayAppointmentUpdateSummary(existing, updated);</span>
            
<span class="nc" id="L166">            System.out.print(&quot;‚úÖ Apply these changes? (y/n): &quot;);</span>
<span class="nc" id="L167">            String confirm = scanner.nextLine().trim().toLowerCase();</span>
            
<span class="nc bnc" id="L169" title="All 4 branches missed.">            if (confirm.equals(&quot;y&quot;) || confirm.equals(&quot;yes&quot;)) {</span>
<span class="nc" id="L170">                return updated;</span>
            } else {
<span class="nc" id="L172">                System.out.println(&quot;‚ùå Appointment rescheduling cancelled.&quot;);</span>
<span class="nc" id="L173">                return null;</span>
            }
            
<span class="nc" id="L176">        } catch (Exception e) {</span>
<span class="nc" id="L177">            logger.error(&quot;Error building appointment update&quot;, e);</span>
<span class="nc" id="L178">            DisplayUtils.printError(&quot;An error occurred while updating appointment information.&quot;);</span>
<span class="nc" id="L179">            return null;</span>
        }
    }
    
    // ==================== INPUT COLLECTION METHODS ====================
    
    private Long collectTicketId() {
        while (true) {
            try {
                // Get open tickets only (business rule)
<span class="nc" id="L189">                List&lt;Ticket&gt; openTickets = apiService.getAllTickets().stream()</span>
<span class="nc" id="L190">                    .filter(t -&gt; &quot;OPEN&quot;.equals(t.getStatus()))</span>
<span class="nc" id="L191">                    .collect(Collectors.toList());</span>
                
<span class="nc bnc" id="L193" title="All 2 branches missed.">                if (openTickets.isEmpty()) {</span>
<span class="nc" id="L194">                    DisplayUtils.printError(&quot;No open tickets available for scheduling appointments.&quot;);</span>
<span class="nc" id="L195">                    return null;</span>
                }
                
<span class="nc" id="L198">                System.out.println(&quot;üìã Available Open Tickets:&quot;);</span>
<span class="nc" id="L199">                System.out.println(&quot;   (Only open tickets can have appointments scheduled)&quot;);</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">                for (int i = 0; i &lt; Math.min(10, openTickets.size()); i++) {</span>
<span class="nc" id="L201">                    Ticket ticket = openTickets.get(i);</span>
<span class="nc" id="L202">                    String description = ticket.getDescription();</span>
<span class="nc bnc" id="L203" title="All 4 branches missed.">                    if (description != null &amp;&amp; description.length() &gt; 40) {</span>
<span class="nc" id="L204">                        description = description.substring(0, 37) + &quot;...&quot;;</span>
                    }
<span class="nc" id="L206">                    System.out.printf(&quot;   %d. Ticket #%d: %s\n&quot;, i + 1, ticket.getId(), </span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">                        description != null ? description : &quot;No description&quot;);</span>
                }
                
<span class="nc bnc" id="L210" title="All 2 branches missed.">                if (openTickets.size() &gt; 10) {</span>
<span class="nc" id="L211">                    System.out.printf(&quot;   ... and %d more tickets\n&quot;, openTickets.size() - 10);</span>
                }
                
<span class="nc" id="L214">                System.out.print(&quot;Select ticket by number or enter ticket ID: &quot;);</span>
<span class="nc" id="L215">                String input = scanner.nextLine().trim();</span>
                
<span class="nc bnc" id="L217" title="All 2 branches missed.">                if (input.equalsIgnoreCase(&quot;cancel&quot;)) {</span>
<span class="nc" id="L218">                    return null;</span>
                }
                
                Long ticketId;
                try {
<span class="nc" id="L223">                    int choice = Integer.parseInt(input);</span>
<span class="nc bnc" id="L224" title="All 4 branches missed.">                    if (choice &gt;= 1 &amp;&amp; choice &lt;= Math.min(10, openTickets.size())) {</span>
<span class="nc" id="L225">                        ticketId = openTickets.get(choice - 1).getId();</span>
                    } else {
<span class="nc" id="L227">                        ticketId = Long.parseLong(input);</span>
                    }
<span class="nc" id="L229">                } catch (NumberFormatException e) {</span>
<span class="nc" id="L230">                    DisplayUtils.printError(&quot;Please enter a valid number or ticket ID.&quot;);</span>
<span class="nc" id="L231">                    continue;</span>
<span class="nc" id="L232">                }</span>
                
                // Verify ticket exists and is open
<span class="nc" id="L235">                Ticket selectedTicket = openTickets.stream()</span>
<span class="nc" id="L236">                    .filter(t -&gt; t.getId().equals(ticketId))</span>
<span class="nc" id="L237">                    .findFirst()</span>
<span class="nc" id="L238">                    .orElse(null);</span>
                
<span class="nc bnc" id="L240" title="All 2 branches missed.">                if (selectedTicket != null) {</span>
<span class="nc" id="L241">                    System.out.printf(&quot;‚úÖ Selected: Ticket #%d\n&quot;, ticketId);</span>
<span class="nc" id="L242">                    return ticketId;</span>
                } else {
<span class="nc" id="L244">                    DisplayUtils.printError(&quot;Ticket not found or not in OPEN status. Please select from the list.&quot;);</span>
                }
                
<span class="nc" id="L247">            } catch (ApiException e) {</span>
<span class="nc" id="L248">                logger.error(&quot;Failed to fetch tickets&quot;, e);</span>
<span class="nc" id="L249">                DisplayUtils.printError(&quot;Failed to retrieve tickets: &quot; + e.getMessage());</span>
<span class="nc" id="L250">                return null;</span>
<span class="nc" id="L251">            }</span>
        }
    }
    
    private Long collectTechnicianId() {
        while (true) {
            try {
                // Get active technicians only (business rule)
<span class="nc" id="L259">                List&lt;Technician&gt; activeTechnicians = apiService.getAllTechnicians().stream()</span>
<span class="nc" id="L260">                    .filter(t -&gt; &quot;ACTIVE&quot;.equals(t.getStatus()))</span>
<span class="nc" id="L261">                    .collect(Collectors.toList());</span>
                
<span class="nc bnc" id="L263" title="All 2 branches missed.">                if (activeTechnicians.isEmpty()) {</span>
<span class="nc" id="L264">                    DisplayUtils.printError(&quot;No active technicians available for appointment scheduling.&quot;);</span>
<span class="nc" id="L265">                    return null;</span>
                }
                
<span class="nc" id="L268">                System.out.println(&quot;üë®‚Äçüîß Available Active Technicians:&quot;);</span>
<span class="nc" id="L269">                System.out.println(&quot;   (Only active technicians can be assigned appointments)&quot;);</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">                for (int i = 0; i &lt; activeTechnicians.size(); i++) {</span>
<span class="nc" id="L271">                    Technician tech = activeTechnicians.get(i);</span>
<span class="nc bnc" id="L272" title="All 4 branches missed.">                    String skills = tech.getSkills() != null &amp;&amp; !tech.getSkills().isEmpty() ? </span>
<span class="nc" id="L273">                        String.join(&quot;, &quot;, tech.getSkills()) : &quot;General&quot;;</span>
<span class="nc" id="L274">                    System.out.printf(&quot;   %d. %s (Skills: %s)\n&quot;, i + 1, tech.getFullName(), skills);</span>
                }
                
<span class="nc" id="L277">                System.out.print(&quot;Select technician by number or enter technician ID: &quot;);</span>
<span class="nc" id="L278">                String input = scanner.nextLine().trim();</span>
                
<span class="nc bnc" id="L280" title="All 2 branches missed.">                if (input.equalsIgnoreCase(&quot;cancel&quot;)) {</span>
<span class="nc" id="L281">                    return null;</span>
                }
                
                Long technicianId;
                try {
<span class="nc" id="L286">                    int choice = Integer.parseInt(input);</span>
<span class="nc bnc" id="L287" title="All 4 branches missed.">                    if (choice &gt;= 1 &amp;&amp; choice &lt;= activeTechnicians.size()) {</span>
<span class="nc" id="L288">                        technicianId = activeTechnicians.get(choice - 1).getId();</span>
                    } else {
<span class="nc" id="L290">                        technicianId = Long.parseLong(input);</span>
                    }
<span class="nc" id="L292">                } catch (NumberFormatException e) {</span>
<span class="nc" id="L293">                    DisplayUtils.printError(&quot;Please enter a valid number or technician ID.&quot;);</span>
<span class="nc" id="L294">                    continue;</span>
<span class="nc" id="L295">                }</span>
                
                // Verify technician exists and is active
<span class="nc" id="L298">                Technician selectedTechnician = activeTechnicians.stream()</span>
<span class="nc" id="L299">                    .filter(t -&gt; t.getId().equals(technicianId))</span>
<span class="nc" id="L300">                    .findFirst()</span>
<span class="nc" id="L301">                    .orElse(null);</span>
                
<span class="nc bnc" id="L303" title="All 2 branches missed.">                if (selectedTechnician != null) {</span>
<span class="nc" id="L304">                    System.out.printf(&quot;‚úÖ Selected: %s\n&quot;, selectedTechnician.getFullName());</span>
<span class="nc" id="L305">                    return technicianId;</span>
                } else {
<span class="nc" id="L307">                    DisplayUtils.printError(&quot;Technician not found or not ACTIVE. Please select from the list.&quot;);</span>
                }
                
<span class="nc" id="L310">            } catch (ApiException e) {</span>
<span class="nc" id="L311">                logger.error(&quot;Failed to fetch technicians&quot;, e);</span>
<span class="nc" id="L312">                DisplayUtils.printError(&quot;Failed to retrieve technicians: &quot; + e.getMessage());</span>
<span class="nc" id="L313">                return null;</span>
<span class="nc" id="L314">            }</span>
        }
    }
    
    private LocalDateTime collectStartTime() {
<span class="nc" id="L319">        System.out.println(&quot;üìÖ Schedule Start Time:&quot;);</span>
<span class="nc" id="L320">        System.out.println(&quot;   Format: YYYY-MM-DD HH:MM (24-hour format)&quot;);</span>
<span class="nc" id="L321">        System.out.println(&quot;   Example: 2025-01-30 14:30&quot;);</span>
<span class="nc" id="L322">        System.out.println(&quot;   Must be in the future&quot;);</span>
        
        while (true) {
<span class="nc" id="L325">            System.out.print(&quot;Start time: &quot;);</span>
<span class="nc" id="L326">            String input = scanner.nextLine().trim();</span>
            
<span class="nc bnc" id="L328" title="All 2 branches missed.">            if (input.equalsIgnoreCase(&quot;cancel&quot;)) {</span>
<span class="nc" id="L329">                return null;</span>
            }
            
            try {
<span class="nc" id="L333">                LocalDateTime startTime = LocalDateTime.parse(input, DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm&quot;));</span>
                
                // Validate: must be in the future
<span class="nc bnc" id="L336" title="All 2 branches missed.">                if (startTime.isBefore(LocalDateTime.now().plusMinutes(5))) {</span>
<span class="nc" id="L337">                    DisplayUtils.printError(&quot;Start time must be at least 5 minutes in the future.&quot;);</span>
<span class="nc" id="L338">                    continue;</span>
                }
                
<span class="nc" id="L341">                return startTime;</span>
                
<span class="nc" id="L343">            } catch (DateTimeParseException e) {</span>
<span class="nc" id="L344">                DisplayUtils.printError(&quot;Invalid date/time format. Please use: YYYY-MM-DD HH:MM&quot;);</span>
            }
<span class="nc" id="L346">        }</span>
    }
    
    private LocalDateTime collectEndTime(LocalDateTime startTime) {
<span class="nc" id="L350">        System.out.println(&quot;üìÖ Schedule End Time:&quot;);</span>
<span class="nc" id="L351">        System.out.println(&quot;   Format: YYYY-MM-DD HH:MM (24-hour format)&quot;);</span>
<span class="nc" id="L352">        System.out.println(&quot;   Duration: 30 minutes to 8 hours maximum&quot;);</span>
<span class="nc" id="L353">        System.out.printf(&quot;   Must be after: %s\n&quot;, startTime.format(DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm&quot;)));</span>
        
        while (true) {
<span class="nc" id="L356">            System.out.print(&quot;End time: &quot;);</span>
<span class="nc" id="L357">            String input = scanner.nextLine().trim();</span>
            
<span class="nc bnc" id="L359" title="All 2 branches missed.">            if (input.equalsIgnoreCase(&quot;cancel&quot;)) {</span>
<span class="nc" id="L360">                return null;</span>
            }
            
            try {
<span class="nc" id="L364">                LocalDateTime endTime = LocalDateTime.parse(input, DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm&quot;));</span>
                
                // Validate: must be after start time
<span class="nc bnc" id="L367" title="All 2 branches missed.">                if (!endTime.isAfter(startTime)) {</span>
<span class="nc" id="L368">                    DisplayUtils.printError(&quot;End time must be after start time.&quot;);</span>
<span class="nc" id="L369">                    continue;</span>
                }
                
                // Validate duration (business rule: 30min - 8hr)
<span class="nc" id="L373">                Duration duration = Duration.between(startTime, endTime);</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">                if (duration.toMinutes() &lt; MIN_DURATION_MINUTES) {</span>
<span class="nc" id="L375">                    DisplayUtils.printError(&quot;Minimum appointment duration is &quot; + MIN_DURATION_MINUTES + &quot; minutes.&quot;);</span>
<span class="nc" id="L376">                    continue;</span>
                }
                
<span class="nc bnc" id="L379" title="All 2 branches missed.">                if (duration.toHours() &gt; MAX_DURATION_HOURS) {</span>
<span class="nc" id="L380">                    DisplayUtils.printError(&quot;Maximum appointment duration is &quot; + MAX_DURATION_HOURS + &quot; hours.&quot;);</span>
<span class="nc" id="L381">                    continue;</span>
                }
                
<span class="nc" id="L384">                return endTime;</span>
                
<span class="nc" id="L386">            } catch (DateTimeParseException e) {</span>
<span class="nc" id="L387">                DisplayUtils.printError(&quot;Invalid date/time format. Please use: YYYY-MM-DD HH:MM&quot;);</span>
            }
<span class="nc" id="L389">        }</span>
    }
    
    private String collectNotes() {
<span class="nc" id="L393">        System.out.print(&quot;Notes (optional): &quot;);</span>
<span class="nc" id="L394">        String input = scanner.nextLine().trim();</span>
        
<span class="nc bnc" id="L396" title="All 2 branches missed.">        if (input.equalsIgnoreCase(&quot;cancel&quot;)) {</span>
<span class="nc" id="L397">            return null;</span>
        }
        
<span class="nc" id="L400">        return input; // Can be empty</span>
    }
    
    // ==================== OPTIONAL INPUT METHODS (FOR UPDATES) ====================
    
    private LocalDateTime collectOptionalStartTime(LocalDateTime currentStartTime) {
<span class="nc" id="L406">        System.out.printf(&quot;Current start time: %s\n&quot;, </span>
<span class="nc" id="L407">            currentStartTime.format(DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm&quot;)));</span>
<span class="nc" id="L408">        System.out.print(&quot;New start time (or press Enter to keep current): &quot;);</span>
<span class="nc" id="L409">        String input = scanner.nextLine().trim();</span>
        
<span class="nc bnc" id="L411" title="All 2 branches missed.">        if (input.isEmpty()) {</span>
<span class="nc" id="L412">            return null; // Keep current</span>
        }
        
<span class="nc bnc" id="L415" title="All 2 branches missed.">        if (input.equalsIgnoreCase(&quot;cancel&quot;)) {</span>
<span class="nc" id="L416">            return null;</span>
        }
        
        try {
<span class="nc" id="L420">            LocalDateTime newStartTime = LocalDateTime.parse(input, DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm&quot;));</span>
            
<span class="nc bnc" id="L422" title="All 2 branches missed.">            if (newStartTime.isBefore(LocalDateTime.now().plusMinutes(5))) {</span>
<span class="nc" id="L423">                DisplayUtils.printError(&quot;Start time must be at least 5 minutes in the future.&quot;);</span>
<span class="nc" id="L424">                return collectOptionalStartTime(currentStartTime); // Retry</span>
            }
            
<span class="nc" id="L427">            return newStartTime;</span>
            
<span class="nc" id="L429">        } catch (DateTimeParseException e) {</span>
<span class="nc" id="L430">            DisplayUtils.printError(&quot;Invalid date/time format. Please use: YYYY-MM-DD HH:MM&quot;);</span>
<span class="nc" id="L431">            return collectOptionalStartTime(currentStartTime); // Retry</span>
        }
    }
    
    private LocalDateTime collectOptionalEndTime(LocalDateTime startTime, LocalDateTime currentEndTime) {
<span class="nc" id="L436">        System.out.printf(&quot;Current end time: %s\n&quot;, </span>
<span class="nc" id="L437">            currentEndTime.format(DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm&quot;)));</span>
<span class="nc" id="L438">        System.out.print(&quot;New end time (or press Enter to keep current): &quot;);</span>
<span class="nc" id="L439">        String input = scanner.nextLine().trim();</span>
        
<span class="nc bnc" id="L441" title="All 2 branches missed.">        if (input.isEmpty()) {</span>
<span class="nc" id="L442">            return null; // Keep current</span>
        }
        
<span class="nc bnc" id="L445" title="All 2 branches missed.">        if (input.equalsIgnoreCase(&quot;cancel&quot;)) {</span>
<span class="nc" id="L446">            return null;</span>
        }
        
        try {
<span class="nc" id="L450">            LocalDateTime newEndTime = LocalDateTime.parse(input, DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm&quot;));</span>
            
<span class="nc bnc" id="L452" title="All 2 branches missed.">            if (!newEndTime.isAfter(startTime)) {</span>
<span class="nc" id="L453">                DisplayUtils.printError(&quot;End time must be after start time.&quot;);</span>
<span class="nc" id="L454">                return collectOptionalEndTime(startTime, currentEndTime); // Retry</span>
            }
            
<span class="nc" id="L457">            Duration duration = Duration.between(startTime, newEndTime);</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">            if (duration.toMinutes() &lt; MIN_DURATION_MINUTES) {</span>
<span class="nc" id="L459">                DisplayUtils.printError(&quot;Minimum appointment duration is &quot; + MIN_DURATION_MINUTES + &quot; minutes.&quot;);</span>
<span class="nc" id="L460">                return collectOptionalEndTime(startTime, currentEndTime); // Retry</span>
            }
            
<span class="nc bnc" id="L463" title="All 2 branches missed.">            if (duration.toHours() &gt; MAX_DURATION_HOURS) {</span>
<span class="nc" id="L464">                DisplayUtils.printError(&quot;Maximum appointment duration is &quot; + MAX_DURATION_HOURS + &quot; hours.&quot;);</span>
<span class="nc" id="L465">                return collectOptionalEndTime(startTime, currentEndTime); // Retry</span>
            }
            
<span class="nc" id="L468">            return newEndTime;</span>
            
<span class="nc" id="L470">        } catch (DateTimeParseException e) {</span>
<span class="nc" id="L471">            DisplayUtils.printError(&quot;Invalid date/time format. Please use: YYYY-MM-DD HH:MM&quot;);</span>
<span class="nc" id="L472">            return collectOptionalEndTime(startTime, currentEndTime); // Retry</span>
        }
    }
    
    private String collectOptionalNotes(String currentNotes) {
<span class="nc bnc" id="L477" title="All 2 branches missed.">        System.out.printf(&quot;Current notes: %s\n&quot;, currentNotes != null ? currentNotes : &quot;(none)&quot;);</span>
<span class="nc" id="L478">        System.out.print(&quot;New notes (or press Enter to keep current): &quot;);</span>
<span class="nc" id="L479">        String input = scanner.nextLine().trim();</span>
        
<span class="nc bnc" id="L481" title="All 2 branches missed.">        if (input.isEmpty()) {</span>
<span class="nc" id="L482">            return null; // Keep current</span>
        }
        
<span class="nc bnc" id="L485" title="All 2 branches missed.">        if (input.equalsIgnoreCase(&quot;cancel&quot;)) {</span>
<span class="nc" id="L486">            return null;</span>
        }
        
<span class="nc" id="L489">        return input;</span>
    }
    
    // ==================== VALIDATION METHODS ====================
    
    private boolean validateBusinessRules(Appointment appointment) {
<span class="nc" id="L495">        System.out.println(&quot;üîç Performing pre-submission validation...&quot;);</span>
        
        try {
            // 1. Re-verify ticket status (might have changed since selection)
<span class="nc" id="L499">            System.out.print(&quot;   Verifying ticket status... &quot;);</span>
<span class="nc" id="L500">            Ticket ticket = apiService.getTicketById(appointment.getTicketId());</span>
<span class="nc bnc" id="L501" title="All 2 branches missed.">            if (!&quot;OPEN&quot;.equals(ticket.getStatus())) {</span>
<span class="nc" id="L502">                System.out.println(&quot;‚ùå&quot;);</span>
<span class="nc" id="L503">                DisplayUtils.printError(&quot;Ticket #&quot; + ticket.getId() + &quot; is no longer OPEN (current status: &quot; + ticket.getStatus() + &quot;).&quot;);</span>
<span class="nc" id="L504">                System.out.println(&quot;Only OPEN tickets can have appointments scheduled.&quot;);</span>
<span class="nc" id="L505">                return false;</span>
            }
<span class="nc" id="L507">            System.out.println(&quot;‚úÖ&quot;);</span>
            
            // 2. Re-verify technician status (might have changed since selection)
<span class="nc" id="L510">            System.out.print(&quot;   Verifying technician status... &quot;);</span>
<span class="nc" id="L511">            List&lt;Technician&gt; allTechnicians = apiService.getAllTechnicians();</span>
<span class="nc" id="L512">            Technician technician = allTechnicians.stream()</span>
<span class="nc" id="L513">                .filter(t -&gt; t.getId().equals(appointment.getTechnicianId()))</span>
<span class="nc" id="L514">                .findFirst()</span>
<span class="nc" id="L515">                .orElse(null);</span>
            
<span class="nc bnc" id="L517" title="All 2 branches missed.">            if (technician == null) {</span>
<span class="nc" id="L518">                System.out.println(&quot;‚ùå&quot;);</span>
<span class="nc" id="L519">                DisplayUtils.printError(&quot;Technician not found with ID: &quot; + appointment.getTechnicianId());</span>
<span class="nc" id="L520">                return false;</span>
            }
            
<span class="nc bnc" id="L523" title="All 2 branches missed.">            if (!&quot;ACTIVE&quot;.equals(technician.getStatus())) {</span>
<span class="nc" id="L524">                System.out.println(&quot;‚ùå&quot;);</span>
<span class="nc" id="L525">                DisplayUtils.printError(&quot;Technician &quot; + technician.getFullName() + &quot; is no longer ACTIVE (current status: &quot; + technician.getStatus() + &quot;).&quot;);</span>
<span class="nc" id="L526">                System.out.println(&quot;Only ACTIVE technicians can be assigned appointments.&quot;);</span>
<span class="nc" id="L527">                return false;</span>
            }
<span class="nc" id="L529">            System.out.println(&quot;‚úÖ&quot;);</span>
            
            // 3. Verify appointment is still in the future (user might have delayed)
<span class="nc" id="L532">            System.out.print(&quot;   Verifying appointment time... &quot;);</span>
<span class="nc bnc" id="L533" title="All 2 branches missed.">            if (appointment.getScheduledStartTime().isBefore(LocalDateTime.now().plusMinutes(5))) {</span>
<span class="nc" id="L534">                System.out.println(&quot;‚ùå&quot;);</span>
<span class="nc" id="L535">                DisplayUtils.printError(&quot;Appointment start time is no longer in the future.&quot;);</span>
<span class="nc" id="L536">                System.out.println(&quot;Please schedule for at least 5 minutes from now.&quot;);</span>
<span class="nc" id="L537">                return false;</span>
            }
<span class="nc" id="L539">            System.out.println(&quot;‚úÖ&quot;);</span>
            
            // 4. Check for scheduling conflicts
<span class="nc" id="L542">            System.out.print(&quot;   Checking for scheduling conflicts... &quot;);</span>
<span class="nc" id="L543">            boolean isAvailable = apiService.checkTechnicianAvailability(</span>
<span class="nc" id="L544">                appointment.getTechnicianId(),</span>
<span class="nc" id="L545">                appointment.getScheduledStartTime(),</span>
<span class="nc" id="L546">                appointment.getScheduledEndTime()</span>
            );
            
<span class="nc bnc" id="L549" title="All 2 branches missed.">            if (!isAvailable) {</span>
<span class="nc" id="L550">                System.out.println(&quot;‚ùå&quot;);</span>
<span class="nc" id="L551">                DisplayUtils.printError(&quot;Technician &quot; + technician.getFullName() + &quot; is not available during the requested time slot.&quot;);</span>
<span class="nc" id="L552">                System.out.println(&quot;Another appointment may have been scheduled since your selection.&quot;);</span>
<span class="nc" id="L553">                System.out.println(&quot;Please choose a different time or technician.&quot;);</span>
<span class="nc" id="L554">                return false;</span>
            }
<span class="nc" id="L556">            System.out.println(&quot;‚úÖ&quot;);</span>
            
            // 5. Verify business rule constraints one more time
<span class="nc" id="L559">            System.out.print(&quot;   Verifying business constraints... &quot;);</span>
<span class="nc" id="L560">            Duration duration = Duration.between(appointment.getScheduledStartTime(), appointment.getScheduledEndTime());</span>
<span class="nc bnc" id="L561" title="All 4 branches missed.">            if (duration.toMinutes() &lt; MIN_DURATION_MINUTES || duration.toHours() &gt; MAX_DURATION_HOURS) {</span>
<span class="nc" id="L562">                System.out.println(&quot;‚ùå&quot;);</span>
<span class="nc" id="L563">                DisplayUtils.printError(&quot;Duration constraint violation: &quot; + duration.toMinutes() + &quot; minutes (must be 30min-8hr).&quot;);</span>
<span class="nc" id="L564">                return false;</span>
            }
<span class="nc" id="L566">            System.out.println(&quot;‚úÖ&quot;);</span>
            
<span class="nc" id="L568">            System.out.println(&quot;‚úÖ All validation checks passed! Appointment is ready for submission.&quot;);</span>
<span class="nc" id="L569">            return true;</span>
            
<span class="nc" id="L571">        } catch (ApiException e) {</span>
<span class="nc" id="L572">            logger.error(&quot;Failed to validate appointment business rules&quot;, e);</span>
<span class="nc" id="L573">            System.out.println(&quot;‚ùå&quot;);</span>
<span class="nc" id="L574">            DisplayUtils.printError(&quot;‚ö†Ô∏è  Could not complete validation checks: &quot; + e.getMessage());</span>
<span class="nc" id="L575">            System.out.println(&quot;This may be due to a server connectivity issue.&quot;);</span>
<span class="nc" id="L576">            System.out.println();</span>
            
            // Give user option to proceed anyway (with clear warning)
<span class="nc" id="L579">            System.out.println(&quot;‚ö†Ô∏è  WARNING: Unable to verify all business rules!&quot;);</span>
<span class="nc" id="L580">            System.out.println(&quot;   - Ticket status might have changed&quot;);</span>
<span class="nc" id="L581">            System.out.println(&quot;   - Technician status might have changed&quot;);</span>
<span class="nc" id="L582">            System.out.println(&quot;   - Scheduling conflicts cannot be detected&quot;);</span>
<span class="nc" id="L583">            System.out.println();</span>
<span class="nc" id="L584">            System.out.print(&quot;üîπ Proceed with appointment creation anyway? (y/n): &quot;);</span>
<span class="nc" id="L585">            String proceed = scanner.nextLine().trim().toLowerCase();</span>
            
<span class="nc bnc" id="L587" title="All 4 branches missed.">            if (proceed.equals(&quot;y&quot;) || proceed.equals(&quot;yes&quot;)) {</span>
<span class="nc" id="L588">                System.out.println(&quot;‚ö†Ô∏è  Proceeding without complete validation...&quot;);</span>
<span class="nc" id="L589">                System.out.println(&quot;   If the appointment fails, check ticket/technician status and scheduling conflicts.&quot;);</span>
<span class="nc" id="L590">                return true;</span>
            } else {
<span class="nc" id="L592">                System.out.println(&quot;‚ùå Appointment creation cancelled.&quot;);</span>
<span class="nc" id="L593">                return false;</span>
            }
        }
    }
    
    // ==================== DISPLAY METHODS ====================
    
    private void displayAppointmentSummary(Appointment appointment, String title) {
<span class="nc" id="L601">        System.out.println();</span>
<span class="nc" id="L602">        DisplayUtils.printHeader(title);</span>
        
        try {
            // Get ticket and technician details for display
<span class="nc" id="L606">            Ticket ticket = apiService.getTicketById(appointment.getTicketId());</span>
<span class="nc" id="L607">            List&lt;Technician&gt; technicians = apiService.getAllTechnicians();</span>
<span class="nc" id="L608">            Technician technician = technicians.stream()</span>
<span class="nc" id="L609">                .filter(t -&gt; t.getId().equals(appointment.getTechnicianId()))</span>
<span class="nc" id="L610">                .findFirst()</span>
<span class="nc" id="L611">                .orElse(null);</span>
            
<span class="nc" id="L613">            System.out.printf(&quot;üìã Ticket:      #%d - %s\n&quot;, </span>
<span class="nc" id="L614">                ticket.getId(), </span>
<span class="nc bnc" id="L615" title="All 2 branches missed.">                ticket.getDescription() != null ? ticket.getDescription() : &quot;No description&quot;);</span>
<span class="nc" id="L616">            System.out.printf(&quot;üë®‚Äçüîß Technician:  %s\n&quot;, </span>
<span class="nc bnc" id="L617" title="All 2 branches missed.">                technician != null ? technician.getFullName() : &quot;ID: &quot; + appointment.getTechnicianId());</span>
<span class="nc" id="L618">            System.out.printf(&quot;üìÖ Start Time:  %s\n&quot;, </span>
<span class="nc" id="L619">                appointment.getScheduledStartTime().format(DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm&quot;)));</span>
<span class="nc" id="L620">            System.out.printf(&quot;üìÖ End Time:    %s\n&quot;, </span>
<span class="nc" id="L621">                appointment.getScheduledEndTime().format(DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm&quot;)));</span>
            
<span class="nc" id="L623">            Duration duration = Duration.between(appointment.getScheduledStartTime(), appointment.getScheduledEndTime());</span>
<span class="nc" id="L624">            System.out.printf(&quot;‚è±Ô∏è  Duration:    %d hours, %d minutes\n&quot;, </span>
<span class="nc" id="L625">                duration.toHours(), duration.toMinutes() % 60);</span>
            
<span class="nc bnc" id="L627" title="All 4 branches missed.">            if (appointment.getNotes() != null &amp;&amp; !appointment.getNotes().isEmpty()) {</span>
<span class="nc" id="L628">                System.out.printf(&quot;üìù Notes:       %s\n&quot;, appointment.getNotes());</span>
            }
            
<span class="nc" id="L631">            System.out.printf(&quot;üìä Status:      PENDING (will be set after creation)\n&quot;);</span>
            
<span class="nc" id="L633">        } catch (ApiException e) {</span>
<span class="nc" id="L634">            logger.warn(&quot;Failed to fetch details for appointment summary&quot;, e);</span>
<span class="nc" id="L635">            System.out.printf(&quot;üìã Ticket ID:   %d\n&quot;, appointment.getTicketId());</span>
<span class="nc" id="L636">            System.out.printf(&quot;üë®‚Äçüîß Technician: ID %d\n&quot;, appointment.getTechnicianId());</span>
<span class="nc" id="L637">            System.out.printf(&quot;üìÖ Time:        %s - %s\n&quot;, </span>
<span class="nc" id="L638">                appointment.getScheduledStartTime().format(DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm&quot;)),</span>
<span class="nc" id="L639">                appointment.getScheduledEndTime().format(DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm&quot;)));</span>
<span class="nc" id="L640">        }</span>
        
<span class="nc" id="L642">        System.out.println();</span>
<span class="nc" id="L643">    }</span>
    
    private void displayCurrentAppointmentInfo(Appointment appointment) {
        try {
<span class="nc" id="L647">            Ticket ticket = apiService.getTicketById(appointment.getTicketId());</span>
<span class="nc" id="L648">            List&lt;Technician&gt; technicians = apiService.getAllTechnicians();</span>
<span class="nc" id="L649">            Technician technician = technicians.stream()</span>
<span class="nc" id="L650">                .filter(t -&gt; t.getId().equals(appointment.getTechnicianId()))</span>
<span class="nc" id="L651">                .findFirst()</span>
<span class="nc" id="L652">                .orElse(null);</span>
            
<span class="nc" id="L654">            System.out.printf(&quot;üìã Ticket: #%d - %s\n&quot;, </span>
<span class="nc" id="L655">                ticket.getId(), </span>
<span class="nc bnc" id="L656" title="All 2 branches missed.">                ticket.getDescription() != null ? ticket.getDescription() : &quot;No description&quot;);</span>
<span class="nc" id="L657">            System.out.printf(&quot;üë®‚Äçüîß Technician: %s\n&quot;, </span>
<span class="nc bnc" id="L658" title="All 2 branches missed.">                technician != null ? technician.getFullName() : &quot;ID: &quot; + appointment.getTechnicianId());</span>
<span class="nc" id="L659">            System.out.printf(&quot;üìä Status: %s\n&quot;, appointment.getStatus());</span>
            
<span class="nc" id="L661">        } catch (ApiException e) {</span>
<span class="nc" id="L662">            logger.warn(&quot;Failed to fetch appointment details&quot;, e);</span>
<span class="nc" id="L663">            System.out.printf(&quot;üìã Ticket ID: %d | üë®‚Äçüîß Technician ID: %d | üìä Status: %s\n&quot;, </span>
<span class="nc" id="L664">                appointment.getTicketId(), appointment.getTechnicianId(), appointment.getStatus());</span>
<span class="nc" id="L665">        }</span>
<span class="nc" id="L666">    }</span>
    
    private void displayAppointmentUpdateSummary(Appointment original, Appointment updated) {
<span class="nc" id="L669">        System.out.println();</span>
<span class="nc" id="L670">        DisplayUtils.printHeader(&quot;APPOINTMENT UPDATE SUMMARY&quot;);</span>
        
<span class="nc" id="L672">        System.out.printf(&quot;üìÖ Appointment #%d Changes:\n\n&quot;, updated.getId());</span>
        
        // Compare times
<span class="nc bnc" id="L675" title="All 2 branches missed.">        if (!original.getScheduledStartTime().equals(updated.getScheduledStartTime())) {</span>
<span class="nc" id="L676">            System.out.printf(&quot;‚è∞ Start Time: %s ‚Üí %s\n&quot;, </span>
<span class="nc" id="L677">                formatDateTime(original.getScheduledStartTime()),</span>
<span class="nc" id="L678">                formatDateTime(updated.getScheduledStartTime()));</span>
        }
        
<span class="nc bnc" id="L681" title="All 2 branches missed.">        if (!original.getScheduledEndTime().equals(updated.getScheduledEndTime())) {</span>
<span class="nc" id="L682">            System.out.printf(&quot;‚è∞ End Time:   %s ‚Üí %s\n&quot;, </span>
<span class="nc" id="L683">                formatDateTime(original.getScheduledEndTime()),</span>
<span class="nc" id="L684">                formatDateTime(updated.getScheduledEndTime()));</span>
        }
        
        // Compare notes
<span class="nc bnc" id="L688" title="All 2 branches missed.">        if (!Objects.equals(original.getNotes(), updated.getNotes())) {</span>
<span class="nc" id="L689">            System.out.printf(&quot;üìù Notes:      \&quot;%s\&quot; ‚Üí \&quot;%s\&quot;\n&quot;, </span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">                original.getNotes() != null ? original.getNotes() : &quot;(none)&quot;,</span>
<span class="nc bnc" id="L691" title="All 2 branches missed.">                updated.getNotes() != null ? updated.getNotes() : &quot;(none)&quot;);</span>
        }
        
<span class="nc bnc" id="L694" title="All 2 branches missed.">        if (original.getScheduledStartTime().equals(updated.getScheduledStartTime()) &amp;&amp;</span>
<span class="nc bnc" id="L695" title="All 2 branches missed.">            original.getScheduledEndTime().equals(updated.getScheduledEndTime()) &amp;&amp;</span>
<span class="nc bnc" id="L696" title="All 2 branches missed.">            Objects.equals(original.getNotes(), updated.getNotes())) {</span>
<span class="nc" id="L697">            System.out.println(&quot;‚ÑπÔ∏è  No changes detected.&quot;);</span>
        }
        
<span class="nc" id="L700">        System.out.println();</span>
<span class="nc" id="L701">    }</span>
    
    private String formatDateTime(LocalDateTime dateTime) {
<span class="nc" id="L704">        return dateTime.format(DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm&quot;));</span>
    }
    
    private String formatTimeRange(LocalDateTime start, LocalDateTime end) {
<span class="nc" id="L708">        return String.format(&quot;%s - %s&quot;, formatDateTime(start), formatDateTime(end));</span>
    }
} 
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>