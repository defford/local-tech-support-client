<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ApiService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Local Tech Support CLI Client</a> &gt; <a href="index.source.html" class="el_package">com.localtechsupport.cli.service</a> &gt; <span class="el_source">ApiService.java</span></div><h1>ApiService.java</h1><pre class="source lang-java linenums">package com.localtechsupport.cli.service;

import com.localtechsupport.cli.client.TechSupportApiClient;
import com.localtechsupport.cli.client.ApiResponse;
import com.localtechsupport.cli.client.ApiException;
import com.localtechsupport.cli.model.Client;
import com.localtechsupport.cli.model.Technician;
import com.localtechsupport.cli.model.Ticket;
import com.localtechsupport.cli.model.Appointment;
import com.localtechsupport.cli.model.PagedResponse;
import com.fasterxml.jackson.core.type.TypeReference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import java.util.List;
import java.util.Map;
import java.util.HashMap;

/**
 * Service layer for API communication and business logic
 * 
 * This service handles all interactions with the Tech Support API
 * using the correct endpoints that exist on the actual Spring Boot server.
 */
public class ApiService implements AutoCloseable {

<span class="nc" id="L26">    private static final Logger logger = LoggerFactory.getLogger(ApiService.class);</span>

    private final TechSupportApiClient apiClient;

<span class="nc" id="L30">    public ApiService(String baseUrl) {</span>
<span class="nc" id="L31">        this.apiClient = new TechSupportApiClient(baseUrl);</span>
<span class="nc" id="L32">        logger.info(&quot;ApiService initialized with base URL: {}&quot;, baseUrl);</span>
<span class="nc" id="L33">    }</span>

<span class="nc" id="L35">    public ApiService(TechSupportApiClient apiClient) {</span>
<span class="nc" id="L36">        this.apiClient = apiClient;</span>
<span class="nc" id="L37">        logger.info(&quot;ApiService initialized with custom API client&quot;);</span>
<span class="nc" id="L38">    }</span>

    /**
     * Test connection to the API server
     * 
     * @return true if connection is successful, false otherwise
     */
    public boolean testConnection() {
<span class="nc" id="L46">        logger.debug(&quot;Testing API connection&quot;);</span>
<span class="nc" id="L47">        return apiClient.testConnection();</span>
    }

    /**
     * Get the base URL of the API client
     * 
     * @return the base URL
     */
    public String getBaseUrl() {
<span class="nc" id="L56">        return apiClient.getBaseUrl();</span>
    }

    /**
     * Close the API service and release resources
     */
    public void close() {
<span class="nc" id="L63">        logger.info(&quot;Closing API service&quot;);</span>
<span class="nc" id="L64">        apiClient.close();</span>
<span class="nc" id="L65">    }</span>

    /**
     * Get all clients from the API
     * 
     * @return List of all clients
     * @throws ApiException if the API call fails
     */
    public List&lt;Client&gt; getAllClients() throws ApiException {
<span class="nc" id="L74">        logger.debug(&quot;Fetching all clients&quot;);</span>
        
        try {
<span class="nc" id="L77">            ApiResponse&lt;PagedResponse&lt;Client&gt;&gt; response = apiClient.get(</span>
<span class="nc" id="L78">                &quot;/api/clients&quot;, </span>
<span class="nc" id="L79">                new TypeReference&lt;PagedResponse&lt;Client&gt;&gt;() {}</span>
            );
            
<span class="nc" id="L82">            List&lt;Client&gt; clients = response.getData().getContent();</span>
<span class="nc" id="L83">            logger.info(&quot;Successfully fetched {} clients&quot;, clients.size());</span>
            
<span class="nc" id="L85">            return clients;</span>
            
<span class="nc" id="L87">        } catch (ApiException e) {</span>
<span class="nc" id="L88">            logger.error(&quot;Failed to fetch clients: {}&quot;, e.getMessage());</span>
<span class="nc" id="L89">            throw e;</span>
        }
    }

    /**
     * Get a specific client by ID
     * 
     * @param clientId the client ID
     * @return the client
     * @throws ApiException if the API call fails
     */
    public Client getClientById(Long clientId) throws ApiException {
<span class="nc" id="L101">        logger.debug(&quot;Fetching client with ID: {}&quot;, clientId);</span>
        
        try {
<span class="nc" id="L104">            ApiResponse&lt;Client&gt; response = apiClient.get(</span>
<span class="nc" id="L105">                &quot;/api/clients/&quot; + clientId, </span>
<span class="nc" id="L106">                Client.class</span>
            );
            
<span class="nc" id="L109">            Client client = response.getData();</span>
<span class="nc" id="L110">            logger.info(&quot;Successfully fetched client: {}&quot;, client.getId());</span>
            
<span class="nc" id="L112">            return client;</span>
            
<span class="nc" id="L114">        } catch (ApiException e) {</span>
<span class="nc" id="L115">            logger.error(&quot;Failed to fetch client {}: {}&quot;, clientId, e.getMessage());</span>
<span class="nc" id="L116">            throw e;</span>
        }
    }

    /**
     * Get tickets for a specific client using query parameter
     * 
     * @param clientId the client ID
     * @return List of tickets for the client
     * @throws ApiException if the API call fails
     */
    public List&lt;Ticket&gt; getTicketsByClient(Long clientId) throws ApiException {
<span class="nc" id="L128">        logger.debug(&quot;Fetching tickets for client: {}&quot;, clientId);</span>
        
        try {
<span class="nc" id="L131">            ApiResponse&lt;PagedResponse&lt;Ticket&gt;&gt; response = apiClient.get(</span>
<span class="nc" id="L132">                &quot;/api/tickets?clientId=&quot; + clientId, </span>
<span class="nc" id="L133">                new TypeReference&lt;PagedResponse&lt;Ticket&gt;&gt;() {}</span>
            );
            
<span class="nc" id="L136">            List&lt;Ticket&gt; tickets = response.getData().getContent();</span>
<span class="nc" id="L137">            logger.info(&quot;Successfully fetched {} tickets for client {}&quot;, tickets.size(), clientId);</span>
            
<span class="nc" id="L139">            return tickets;</span>
            
<span class="nc" id="L141">        } catch (ApiException e) {</span>
<span class="nc" id="L142">            logger.error(&quot;Failed to fetch tickets for client {}: {}&quot;, clientId, e.getMessage());</span>
<span class="nc" id="L143">            throw e;</span>
        }
    }

    /**
     * Get all technicians from the API
     * 
     * @return List of all technicians
     * @throws ApiException if the API call fails
     */
    public List&lt;Technician&gt; getAllTechnicians() throws ApiException {
<span class="nc" id="L154">        logger.debug(&quot;Fetching all technicians&quot;);</span>
        
        try {
<span class="nc" id="L157">            ApiResponse&lt;PagedResponse&lt;Technician&gt;&gt; response = apiClient.get(</span>
<span class="nc" id="L158">                &quot;/api/technicians&quot;, </span>
<span class="nc" id="L159">                new TypeReference&lt;PagedResponse&lt;Technician&gt;&gt;() {}</span>
            );
            
<span class="nc" id="L162">            List&lt;Technician&gt; technicians = response.getData().getContent();</span>
<span class="nc" id="L163">            logger.info(&quot;Successfully fetched {} technicians&quot;, technicians.size());</span>
            
<span class="nc" id="L165">            return technicians;</span>
            
<span class="nc" id="L167">        } catch (ApiException e) {</span>
<span class="nc" id="L168">            logger.error(&quot;Failed to fetch technicians: {}&quot;, e.getMessage());</span>
<span class="nc" id="L169">            throw e;</span>
        }
    }

    /**
     * Get tickets for a specific technician using query parameter
     * 
     * @param technicianId the technician ID
     * @return List of tickets assigned to the technician
     * @throws ApiException if the API call fails
     */
    public List&lt;Ticket&gt; getTicketsByTechnician(Long technicianId) throws ApiException {
<span class="nc" id="L181">        logger.debug(&quot;Fetching tickets for technician: {}&quot;, technicianId);</span>
        
        try {
<span class="nc" id="L184">            ApiResponse&lt;PagedResponse&lt;Ticket&gt;&gt; response = apiClient.get(</span>
<span class="nc" id="L185">                &quot;/api/tickets?technicianId=&quot; + technicianId, </span>
<span class="nc" id="L186">                new TypeReference&lt;PagedResponse&lt;Ticket&gt;&gt;() {}</span>
            );
            
<span class="nc" id="L189">            List&lt;Ticket&gt; tickets = response.getData().getContent();</span>
<span class="nc" id="L190">            logger.info(&quot;Successfully fetched {} tickets for technician {}&quot;, tickets.size(), technicianId);</span>
            
<span class="nc" id="L192">            return tickets;</span>
            
<span class="nc" id="L194">        } catch (ApiException e) {</span>
<span class="nc" id="L195">            logger.error(&quot;Failed to fetch tickets for technician {}: {}&quot;, technicianId, e.getMessage());</span>
<span class="nc" id="L196">            throw e;</span>
        }
    }

    /**
     * Get available technicians for a specific service type
     * 
     * @param serviceType the service type (HARDWARE, SOFTWARE, etc.)
     * @return List of available technicians
     * @throws ApiException if the API call fails
     */
    public List&lt;Technician&gt; getAvailableTechniciansByServiceType(String serviceType) throws ApiException {
<span class="nc" id="L208">        logger.debug(&quot;Fetching available technicians for service type: {}&quot;, serviceType);</span>
        
        try {
            // Note: /api/technicians/available?serviceType=X returns a plain array, not a PagedResponse
<span class="nc" id="L212">            ApiResponse&lt;List&lt;Technician&gt;&gt; response = apiClient.get(</span>
<span class="nc" id="L213">                &quot;/api/technicians/available?serviceType=&quot; + serviceType, </span>
<span class="nc" id="L214">                new TypeReference&lt;List&lt;Technician&gt;&gt;() {}</span>
            );
            
<span class="nc" id="L217">            List&lt;Technician&gt; technicians = response.getData();</span>
<span class="nc" id="L218">            logger.info(&quot;Successfully fetched {} available technicians for {}&quot;, technicians.size(), serviceType);</span>
            
<span class="nc" id="L220">            return technicians;</span>
            
<span class="nc" id="L222">        } catch (ApiException e) {</span>
<span class="nc" id="L223">            logger.error(&quot;Failed to fetch available technicians for {}: {}&quot;, serviceType, e.getMessage());</span>
<span class="nc" id="L224">            throw e;</span>
        }
    }

    /**
     * Get all available technicians
     * 
     * @return List of available technicians
     * @throws ApiException if the API call fails
     */
    public List&lt;Technician&gt; getAvailableTechnicians() throws ApiException {
<span class="nc" id="L235">        logger.debug(&quot;Fetching all available technicians&quot;);</span>
        
        try {
            // Note: /api/technicians/available returns a plain array, not a PagedResponse
<span class="nc" id="L239">            ApiResponse&lt;List&lt;Technician&gt;&gt; response = apiClient.get(</span>
<span class="nc" id="L240">                &quot;/api/technicians/available&quot;, </span>
<span class="nc" id="L241">                new TypeReference&lt;List&lt;Technician&gt;&gt;() {}</span>
            );
            
<span class="nc" id="L244">            List&lt;Technician&gt; technicians = response.getData();</span>
<span class="nc" id="L245">            logger.info(&quot;Successfully fetched {} available technicians&quot;, technicians.size());</span>
            
<span class="nc" id="L247">            return technicians;</span>
            
<span class="nc" id="L249">        } catch (ApiException e) {</span>
<span class="nc" id="L250">            logger.error(&quot;Failed to fetch available technicians: {}&quot;, e.getMessage());</span>
<span class="nc" id="L251">            throw e;</span>
        }
    }

    /**
     * Get overdue tickets
     * 
     * @return List of overdue tickets
     * @throws ApiException if the API call fails
     */
    public List&lt;Ticket&gt; getOverdueTickets() throws ApiException {
<span class="nc" id="L262">        logger.debug(&quot;Fetching overdue tickets&quot;);</span>
        
        try {
            // Note: /api/tickets/overdue returns a plain array, not a PagedResponse
<span class="nc" id="L266">            ApiResponse&lt;List&lt;Ticket&gt;&gt; response = apiClient.get(</span>
<span class="nc" id="L267">                &quot;/api/tickets/overdue&quot;, </span>
<span class="nc" id="L268">                new TypeReference&lt;List&lt;Ticket&gt;&gt;() {}</span>
            );
            
<span class="nc" id="L271">            List&lt;Ticket&gt; tickets = response.getData();</span>
<span class="nc" id="L272">            logger.info(&quot;Successfully fetched {} overdue tickets&quot;, tickets.size());</span>
            
<span class="nc" id="L274">            return tickets;</span>
            
<span class="nc" id="L276">        } catch (ApiException e) {</span>
<span class="nc" id="L277">            logger.error(&quot;Failed to fetch overdue tickets: {}&quot;, e.getMessage());</span>
<span class="nc" id="L278">            throw e;</span>
        }
    }

    /**
     * Get appointments for a specific technician using query parameter
     * 
     * @param technicianId the technician ID
     * @return List of appointments for the technician
     * @throws ApiException if the API call fails
     */
    public List&lt;Appointment&gt; getAppointmentsByTechnician(Long technicianId) throws ApiException {
<span class="nc" id="L290">        logger.debug(&quot;Fetching appointments for technician: {}&quot;, technicianId);</span>
        
        try {
<span class="nc" id="L293">            ApiResponse&lt;PagedResponse&lt;Appointment&gt;&gt; response = apiClient.get(</span>
<span class="nc" id="L294">                &quot;/api/appointments?technicianId=&quot; + technicianId, </span>
<span class="nc" id="L295">                new TypeReference&lt;PagedResponse&lt;Appointment&gt;&gt;() {}</span>
            );
            
<span class="nc" id="L298">            List&lt;Appointment&gt; appointments = response.getData().getContent();</span>
<span class="nc" id="L299">            logger.info(&quot;Successfully fetched {} appointments for technician {}&quot;, appointments.size(), technicianId);</span>
            
<span class="nc" id="L301">            return appointments;</span>
            
<span class="nc" id="L303">        } catch (ApiException e) {</span>
<span class="nc" id="L304">            logger.error(&quot;Failed to fetch appointments for technician {}: {}&quot;, technicianId, e.getMessage());</span>
<span class="nc" id="L305">            throw e;</span>
        }
    }

    /**
     * Get all tickets from the API
     * 
     * @return List of all tickets
     * @throws ApiException if the API call fails
     */
    public List&lt;Ticket&gt; getAllTickets() throws ApiException {
<span class="nc" id="L316">        logger.debug(&quot;Fetching all tickets&quot;);</span>
        
        try {
<span class="nc" id="L319">            ApiResponse&lt;PagedResponse&lt;Ticket&gt;&gt; response = apiClient.get(</span>
<span class="nc" id="L320">                &quot;/api/tickets&quot;, </span>
<span class="nc" id="L321">                new TypeReference&lt;PagedResponse&lt;Ticket&gt;&gt;() {}</span>
            );
            
<span class="nc" id="L324">            List&lt;Ticket&gt; tickets = response.getData().getContent();</span>
<span class="nc" id="L325">            logger.info(&quot;Successfully fetched {} tickets&quot;, tickets.size());</span>
            
<span class="nc" id="L327">            return tickets;</span>
            
<span class="nc" id="L329">        } catch (ApiException e) {</span>
<span class="nc" id="L330">            logger.error(&quot;Failed to fetch tickets: {}&quot;, e.getMessage());</span>
<span class="nc" id="L331">            throw e;</span>
        }
    }

    /**
     * Get a specific ticket by ID with full details
     * 
     * @param ticketId the ticket ID
     * @return the ticket with full nested objects
     * @throws ApiException if the API call fails
     */
    public Ticket getTicketById(Long ticketId) throws ApiException {
<span class="nc" id="L343">        logger.debug(&quot;Fetching ticket with ID: {}&quot;, ticketId);</span>
        
        try {
<span class="nc" id="L346">            ApiResponse&lt;Ticket&gt; response = apiClient.get(</span>
<span class="nc" id="L347">                &quot;/api/tickets/&quot; + ticketId, </span>
<span class="nc" id="L348">                Ticket.class</span>
            );
            
<span class="nc" id="L351">            Ticket ticket = response.getData();</span>
<span class="nc" id="L352">            logger.info(&quot;Successfully fetched ticket: {}&quot;, ticket.getId());</span>
            
<span class="nc" id="L354">            return ticket;</span>
            
<span class="nc" id="L356">        } catch (ApiException e) {</span>
<span class="nc" id="L357">            logger.error(&quot;Failed to fetch ticket {}: {}&quot;, ticketId, e.getMessage());</span>
<span class="nc" id="L358">            throw e;</span>
        }
    }

    /**
     * Get all appointments from the API
     * 
     * @return List of all appointments
     * @throws ApiException if the API call fails
     */
    public List&lt;Appointment&gt; getAllAppointments() throws ApiException {
<span class="nc" id="L369">        logger.debug(&quot;Fetching all appointments&quot;);</span>
        
        try {
<span class="nc" id="L372">            ApiResponse&lt;PagedResponse&lt;Appointment&gt;&gt; response = apiClient.get(</span>
<span class="nc" id="L373">                &quot;/api/appointments&quot;, </span>
<span class="nc" id="L374">                new TypeReference&lt;PagedResponse&lt;Appointment&gt;&gt;() {}</span>
            );
            
<span class="nc" id="L377">            List&lt;Appointment&gt; appointments = response.getData().getContent();</span>
<span class="nc" id="L378">            logger.info(&quot;Successfully fetched {} appointments&quot;, appointments.size());</span>
            
<span class="nc" id="L380">            return appointments;</span>
            
<span class="nc" id="L382">        } catch (ApiException e) {</span>
<span class="nc" id="L383">            logger.error(&quot;Failed to fetch appointments: {}&quot;, e.getMessage());</span>
<span class="nc" id="L384">            throw e;</span>
        }
    }

    // ==================== CLIENT WRITE OPERATIONS ====================

    /**
     * Create a new client
     * 
     * @param client the client to create (without ID)
     * @return the created client with generated ID
     * @throws ApiException if the API call fails
     */
    public Client createClient(Client client) throws ApiException {
<span class="nc" id="L398">        logger.debug(&quot;Creating new client: {} {}&quot;, client.getFirstName(), client.getLastName());</span>
        
        try {
<span class="nc" id="L401">            ApiResponse&lt;Client&gt; response = apiClient.post(</span>
<span class="nc" id="L402">                &quot;/api/clients&quot;, </span>
<span class="nc" id="L403">                client, </span>
<span class="nc" id="L404">                Client.class</span>
            );
            
<span class="nc" id="L407">            Client createdClient = response.getData();</span>
<span class="nc" id="L408">            logger.info(&quot;Successfully created client with ID: {}&quot;, createdClient.getId());</span>
            
<span class="nc" id="L410">            return createdClient;</span>
            
<span class="nc" id="L412">        } catch (ApiException e) {</span>
<span class="nc" id="L413">            logger.error(&quot;Failed to create client: {}&quot;, e.getMessage());</span>
<span class="nc" id="L414">            throw e;</span>
        }
    }

    /**
     * Update an existing client
     * 
     * @param clientId the client ID to update
     * @param client the updated client data
     * @return the updated client
     * @throws ApiException if the API call fails
     */
    public Client updateClient(Long clientId, Client client) throws ApiException {
<span class="nc" id="L427">        logger.debug(&quot;Updating client ID: {}&quot;, clientId);</span>
        
        try {
<span class="nc" id="L430">            ApiResponse&lt;Client&gt; response = apiClient.put(</span>
<span class="nc" id="L431">                &quot;/api/clients/&quot; + clientId, </span>
<span class="nc" id="L432">                client, </span>
<span class="nc" id="L433">                Client.class</span>
            );
            
<span class="nc" id="L436">            Client updatedClient = response.getData();</span>
<span class="nc" id="L437">            logger.info(&quot;Successfully updated client ID: {}&quot;, clientId);</span>
            
<span class="nc" id="L439">            return updatedClient;</span>
            
<span class="nc" id="L441">        } catch (ApiException e) {</span>
<span class="nc" id="L442">            logger.error(&quot;Failed to update client {}: {}&quot;, clientId, e.getMessage());</span>
<span class="nc" id="L443">            throw e;</span>
        }
    }

    /**
     * Delete a client by ID
     * 
     * @param clientId the client ID to delete
     * @throws ApiException if the API call fails
     */
    public void deleteClient(Long clientId) throws ApiException {
<span class="nc" id="L454">        logger.debug(&quot;Deleting client ID: {}&quot;, clientId);</span>
        
        try {
<span class="nc" id="L457">            apiClient.delete(&quot;/api/clients/&quot; + clientId);</span>
<span class="nc" id="L458">            logger.info(&quot;Successfully deleted client ID: {}&quot;, clientId);</span>
            
<span class="nc" id="L460">        } catch (ApiException e) {</span>
<span class="nc" id="L461">            logger.error(&quot;Failed to delete client {}: {}&quot;, clientId, e.getMessage());</span>
<span class="nc" id="L462">            throw e;</span>
        }
<span class="nc" id="L464">    }</span>

    /**
     * Activate a client (set status to ACTIVE and active to true)
     * 
     * @param clientId the client ID to activate
     * @return the updated client
     * @throws ApiException if the API call fails
     */
    public Client activateClient(Long clientId) throws ApiException {
<span class="nc" id="L474">        logger.debug(&quot;Activating client ID: {}&quot;, clientId);</span>
        
        try {
            // First get the current client data
<span class="nc" id="L478">            Client currentClient = getClientById(clientId);</span>
            
            // Create an updated client with ACTIVE status
<span class="nc" id="L481">            Client updatedClientData = new Client();</span>
<span class="nc" id="L482">            updatedClientData.setId(currentClient.getId());</span>
<span class="nc" id="L483">            updatedClientData.setFirstName(currentClient.getFirstName());</span>
<span class="nc" id="L484">            updatedClientData.setLastName(currentClient.getLastName());</span>
<span class="nc" id="L485">            updatedClientData.setEmail(currentClient.getEmail());</span>
<span class="nc" id="L486">            updatedClientData.setPhone(currentClient.getPhone());</span>
<span class="nc" id="L487">            updatedClientData.setAddress(currentClient.getAddress());</span>
<span class="nc" id="L488">            updatedClientData.setNotes(currentClient.getNotes());</span>
<span class="nc" id="L489">            updatedClientData.setStatus(&quot;ACTIVE&quot;);</span>
<span class="nc" id="L490">            updatedClientData.setActive(true);</span>
            
            // Update the client
<span class="nc" id="L493">            Client activatedClient = updateClient(clientId, updatedClientData);</span>
<span class="nc" id="L494">            logger.info(&quot;Successfully activated client ID: {}&quot;, clientId);</span>
            
<span class="nc" id="L496">            return activatedClient;</span>
            
<span class="nc" id="L498">        } catch (ApiException e) {</span>
<span class="nc" id="L499">            logger.error(&quot;Failed to activate client {}: {}&quot;, clientId, e.getMessage());</span>
<span class="nc" id="L500">            throw e;</span>
        }
    }

    /**
     * Suspend a client (set status to SUSPENDED and active to false)
     * 
     * @param clientId the client ID to suspend
     * @return the updated client
     * @throws ApiException if the API call fails
     */
    public Client suspendClient(Long clientId) throws ApiException {
<span class="nc" id="L512">        logger.debug(&quot;Suspending client ID: {}&quot;, clientId);</span>
        
        try {
            // First get the current client data
<span class="nc" id="L516">            Client currentClient = getClientById(clientId);</span>
            
            // Create an updated client with SUSPENDED status
<span class="nc" id="L519">            Client updatedClientData = new Client();</span>
<span class="nc" id="L520">            updatedClientData.setId(currentClient.getId());</span>
<span class="nc" id="L521">            updatedClientData.setFirstName(currentClient.getFirstName());</span>
<span class="nc" id="L522">            updatedClientData.setLastName(currentClient.getLastName());</span>
<span class="nc" id="L523">            updatedClientData.setEmail(currentClient.getEmail());</span>
<span class="nc" id="L524">            updatedClientData.setPhone(currentClient.getPhone());</span>
<span class="nc" id="L525">            updatedClientData.setAddress(currentClient.getAddress());</span>
<span class="nc" id="L526">            updatedClientData.setNotes(currentClient.getNotes());</span>
<span class="nc" id="L527">            updatedClientData.setStatus(&quot;SUSPENDED&quot;);</span>
<span class="nc" id="L528">            updatedClientData.setActive(false);</span>
            
            // Update the client
<span class="nc" id="L531">            Client suspendedClient = updateClient(clientId, updatedClientData);</span>
<span class="nc" id="L532">            logger.info(&quot;Successfully suspended client ID: {}&quot;, clientId);</span>
            
<span class="nc" id="L534">            return suspendedClient;</span>
            
<span class="nc" id="L536">        } catch (ApiException e) {</span>
<span class="nc" id="L537">            logger.error(&quot;Failed to suspend client {}: {}&quot;, clientId, e.getMessage());</span>
<span class="nc" id="L538">            throw e;</span>
        }
    }

    // ==================== TECHNICIAN CRUD OPERATIONS ====================
    
    /**
     * Create a new technician
     * 
     * @param technician the technician to create
     * @return the created technician
     * @throws ApiException if the API call fails
     */
    public Technician createTechnician(Technician technician) throws ApiException {
<span class="nc" id="L552">        logger.debug(&quot;Creating new technician: {}&quot;, technician.getFullName());</span>
        
        try {
<span class="nc" id="L555">            ApiResponse&lt;Technician&gt; response = apiClient.post(</span>
<span class="nc" id="L556">                &quot;/api/technicians&quot;, </span>
<span class="nc" id="L557">                technician,</span>
<span class="nc" id="L558">                Technician.class</span>
            );
            
<span class="nc" id="L561">            Technician createdTechnician = response.getData();</span>
<span class="nc" id="L562">            logger.info(&quot;Successfully created technician: {} (ID: {})&quot;, </span>
<span class="nc" id="L563">                createdTechnician.getFullName(), createdTechnician.getId());</span>
            
<span class="nc" id="L565">            return createdTechnician;</span>
            
<span class="nc" id="L567">        } catch (ApiException e) {</span>
<span class="nc" id="L568">            logger.error(&quot;Failed to create technician: {}&quot;, e.getMessage());</span>
<span class="nc" id="L569">            throw e;</span>
        }
    }
    
    /**
     * Update an existing technician
     * 
     * @param technicianId the technician ID
     * @param technician the updated technician data
     * @return the updated technician
     * @throws ApiException if the API call fails
     */
    public Technician updateTechnician(Long technicianId, Technician technician) throws ApiException {
<span class="nc" id="L582">        logger.debug(&quot;Updating technician ID: {}&quot;, technicianId);</span>
        
        try {
<span class="nc" id="L585">            ApiResponse&lt;Technician&gt; response = apiClient.put(</span>
<span class="nc" id="L586">                &quot;/api/technicians/&quot; + technicianId, </span>
<span class="nc" id="L587">                technician,</span>
<span class="nc" id="L588">                Technician.class</span>
            );
            
<span class="nc" id="L591">            Technician updatedTechnician = response.getData();</span>
<span class="nc" id="L592">            logger.info(&quot;Successfully updated technician: {} (ID: {})&quot;, </span>
<span class="nc" id="L593">                updatedTechnician.getFullName(), technicianId);</span>
            
<span class="nc" id="L595">            return updatedTechnician;</span>
            
<span class="nc" id="L597">        } catch (ApiException e) {</span>
<span class="nc" id="L598">            logger.error(&quot;Failed to update technician ID {}: {}&quot;, technicianId, e.getMessage());</span>
<span class="nc" id="L599">            throw e;</span>
        }
    }
    
    /**
     * Delete a technician
     * 
     * @param technicianId the technician ID
     * @throws ApiException if the API call fails
     */
    public void deleteTechnician(Long technicianId) throws ApiException {
<span class="nc" id="L610">        logger.debug(&quot;Deleting technician ID: {}&quot;, technicianId);</span>
        
        try {
<span class="nc" id="L613">            apiClient.delete(&quot;/api/technicians/&quot; + technicianId);</span>
<span class="nc" id="L614">            logger.info(&quot;Successfully deleted technician ID: {}&quot;, technicianId);</span>
            
<span class="nc" id="L616">        } catch (ApiException e) {</span>
<span class="nc" id="L617">            logger.error(&quot;Failed to delete technician ID {}: {}&quot;, technicianId, e.getMessage());</span>
<span class="nc" id="L618">            throw e;</span>
        }
<span class="nc" id="L620">    }</span>

    // ==================== END TECHNICIAN CRUD OPERATIONS ====================

    // ==================== TICKET CRUD OPERATIONS ====================
    
    /**
     * Create a new ticket
     * 
     * @param ticket the ticket to create
     * @return the created ticket
     * @throws ApiException if the API call fails
     */
    public Ticket createTicket(Ticket ticket) throws ApiException {
<span class="nc" id="L634">        logger.info(&quot;Creating new ticket - Request data: description='{}', serviceType='{}', clientId={}&quot;, </span>
<span class="nc bnc" id="L635" title="All 2 branches missed.">            ticket.getDescription() != null ? ticket.getDescription().substring(0, Math.min(50, ticket.getDescription().length())) + &quot;...&quot; : &quot;null&quot;,</span>
<span class="nc" id="L636">            ticket.getServiceType(),</span>
<span class="nc" id="L637">            ticket.getClientId());</span>
        
        // Create a minimal request object with only the fields the server expects
        // Server only expects: clientId, serviceType, description
        // Server automatically sets: id, status=OPEN, createdAt, updatedAt, dueAt (24h/48h SLA)
<span class="nc" id="L642">        java.util.Map&lt;String, Object&gt; createRequest = new java.util.HashMap&lt;&gt;();</span>
<span class="nc" id="L643">        createRequest.put(&quot;clientId&quot;, ticket.getClientId());</span>
<span class="nc" id="L644">        createRequest.put(&quot;serviceType&quot;, ticket.getServiceType());</span>
<span class="nc" id="L645">        createRequest.put(&quot;description&quot;, ticket.getDescription());</span>
        
        try {
<span class="nc" id="L648">            ApiResponse&lt;Ticket&gt; response = apiClient.post(</span>
<span class="nc" id="L649">                &quot;/api/tickets&quot;, </span>
<span class="nc" id="L650">                createRequest,</span>
<span class="nc" id="L651">                Ticket.class</span>
            );
            
<span class="nc" id="L654">            Ticket createdTicket = response.getData();</span>
            
            // Debug logging to see what the server actually returned
<span class="nc" id="L657">            logger.info(&quot;Create ticket response: ID={}, status='{}', serviceType='{}', description='{}'&quot;, </span>
<span class="nc" id="L658">                createdTicket.getId(), </span>
<span class="nc" id="L659">                createdTicket.getStatus(),</span>
<span class="nc" id="L660">                createdTicket.getServiceType(),</span>
<span class="nc bnc" id="L661" title="All 2 branches missed.">                createdTicket.getDescription() != null ? createdTicket.getDescription().substring(0, Math.min(50, createdTicket.getDescription().length())) + &quot;...&quot; : &quot;null&quot;);</span>
            
<span class="nc" id="L663">            logger.info(&quot;Successfully created ticket: Description-based ticket (ID: {})&quot;, createdTicket.getId());</span>
            
<span class="nc" id="L665">            return createdTicket;</span>
            
<span class="nc" id="L667">        } catch (ApiException e) {</span>
<span class="nc" id="L668">            logger.error(&quot;Failed to create ticket: {}&quot;, e.getMessage());</span>
<span class="nc" id="L669">            throw e;</span>
        }
    }
    
    /**
     * Update an existing ticket
     * 
     * @param ticketId the ticket ID
     * @param ticket the updated ticket data
     * @return the updated ticket
     * @throws ApiException if the API call fails
     */
    public Ticket updateTicket(Long ticketId, Ticket ticket) throws ApiException {
<span class="nc" id="L682">        logger.debug(&quot;Updating ticket ID: {}&quot;, ticketId);</span>
        
        try {
<span class="nc" id="L685">            ApiResponse&lt;Ticket&gt; response = apiClient.put(</span>
<span class="nc" id="L686">                &quot;/api/tickets/&quot; + ticketId, </span>
<span class="nc" id="L687">                ticket,</span>
<span class="nc" id="L688">                Ticket.class</span>
            );
            
<span class="nc" id="L691">            Ticket updatedTicket = response.getData();</span>
<span class="nc" id="L692">            logger.info(&quot;Successfully updated ticket: Description-based ticket (ID: {})&quot;, ticketId);</span>
            
<span class="nc" id="L694">            return updatedTicket;</span>
            
<span class="nc" id="L696">        } catch (ApiException e) {</span>
<span class="nc" id="L697">            logger.error(&quot;Failed to update ticket ID {}: {}&quot;, ticketId, e.getMessage());</span>
<span class="nc" id="L698">            throw e;</span>
        }
    }
    
    /**
     * Delete a ticket
     * 
     * @param ticketId the ticket ID
     * @throws ApiException if the API call fails
     */
    public void deleteTicket(Long ticketId) throws ApiException {
<span class="nc" id="L709">        logger.debug(&quot;Deleting ticket ID: {}&quot;, ticketId);</span>
        
        try {
<span class="nc" id="L712">            apiClient.delete(&quot;/api/tickets/&quot; + ticketId);</span>
<span class="nc" id="L713">            logger.info(&quot;Successfully deleted ticket ID: {}&quot;, ticketId);</span>
            
<span class="nc" id="L715">        } catch (ApiException e) {</span>
<span class="nc" id="L716">            logger.error(&quot;Failed to delete ticket ID {}: {}&quot;, ticketId, e.getMessage());</span>
<span class="nc" id="L717">            throw e;</span>
        }
<span class="nc" id="L719">    }</span>
    
    /**
     * Assign a technician to a ticket using the proper assignment endpoint
     * 
     * @param ticketId the ticket ID
     * @param technicianId the technician ID to assign
     * @return the updated ticket
     * @throws ApiException if the API call fails
     */
    public Ticket assignTechnician(Long ticketId, Long technicianId) throws ApiException {
<span class="nc" id="L730">        logger.debug(&quot;Assigning technician {} to ticket {}&quot;, technicianId, ticketId);</span>
        
        try {
            // Create request body with technician ID
<span class="nc" id="L734">            Map&lt;String, Object&gt; requestBody = new HashMap&lt;&gt;();</span>
<span class="nc" id="L735">            requestBody.put(&quot;technicianId&quot;, technicianId);</span>
            
<span class="nc" id="L737">            ApiResponse&lt;Ticket&gt; response = apiClient.post(</span>
<span class="nc" id="L738">                &quot;/api/tickets/&quot; + ticketId + &quot;/assign&quot;,</span>
<span class="nc" id="L739">                requestBody,</span>
<span class="nc" id="L740">                Ticket.class</span>
            );
            
<span class="nc" id="L743">            Ticket updatedTicket = response.getData();</span>
<span class="nc" id="L744">            logger.info(&quot;Successfully assigned technician {} to ticket {}&quot;, technicianId, ticketId);</span>
<span class="nc" id="L745">            return updatedTicket;</span>
            
<span class="nc" id="L747">        } catch (ApiException e) {</span>
<span class="nc" id="L748">            logger.error(&quot;Failed to assign technician {} to ticket {}: {}&quot;, technicianId, ticketId, e.getMessage());</span>
<span class="nc" id="L749">            throw e;</span>
        }
    }
    
    /**
     * Unassign the current technician from a ticket
     * 
     * @param ticketId the ticket ID
     * @param reason optional reason for unassignment
     * @param unassignedBy user making the change
     * @return the updated ticket
     * @throws ApiException if the API call fails
     */
    public Ticket unassignTechnician(Long ticketId, String reason, String unassignedBy) throws ApiException {
<span class="nc" id="L763">        logger.debug(&quot;Unassigning technician from ticket {}&quot;, ticketId);</span>
        
        try {
            // Create request body with optional reason and user
<span class="nc" id="L767">            Map&lt;String, Object&gt; requestBody = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L768" title="All 4 branches missed.">            if (reason != null &amp;&amp; !reason.trim().isEmpty()) {</span>
<span class="nc" id="L769">                requestBody.put(&quot;reason&quot;, reason.trim());</span>
            }
<span class="nc bnc" id="L771" title="All 4 branches missed.">            if (unassignedBy != null &amp;&amp; !unassignedBy.trim().isEmpty()) {</span>
<span class="nc" id="L772">                requestBody.put(&quot;updatedBy&quot;, unassignedBy.trim());</span>
            }
            
<span class="nc" id="L775">            ApiResponse&lt;Ticket&gt; response = apiClient.delete(</span>
<span class="nc" id="L776">                &quot;/api/tickets/&quot; + ticketId + &quot;/assign&quot;,</span>
<span class="nc" id="L777">                requestBody,</span>
<span class="nc" id="L778">                Ticket.class</span>
            );
            
<span class="nc" id="L781">            Ticket updatedTicket = response.getData();</span>
<span class="nc" id="L782">            logger.info(&quot;Successfully unassigned technician from ticket {}&quot;, ticketId);</span>
<span class="nc" id="L783">            return updatedTicket;</span>
            
<span class="nc" id="L785">        } catch (ApiException e) {</span>
<span class="nc" id="L786">            logger.error(&quot;Failed to unassign technician from ticket {}: {}&quot;, ticketId, e.getMessage());</span>
<span class="nc" id="L787">            throw e;</span>
        }
    }
    
    /**
     * Update ticket status using the proper status endpoint
     * 
     * @param ticketId the ticket ID
     * @param status the new status (OPEN, CLOSED)
     * @return the updated ticket
     * @throws ApiException if the API call fails
     */
    public Ticket updateTicketStatus(Long ticketId, String status) throws ApiException {
<span class="nc" id="L800">        logger.debug(&quot;Updating ticket {} status to {}&quot;, ticketId, status);</span>
        
        try {
            // Create request body with status and required updatedBy field
<span class="nc" id="L804">            Map&lt;String, Object&gt; requestBody = new HashMap&lt;&gt;();</span>
<span class="nc" id="L805">            requestBody.put(&quot;status&quot;, status);</span>
<span class="nc" id="L806">            requestBody.put(&quot;updatedBy&quot;, &quot;CLI User&quot;); // Required field for audit trail</span>
            
<span class="nc" id="L808">            ApiResponse&lt;Ticket&gt; response = apiClient.put(</span>
<span class="nc" id="L809">                &quot;/api/tickets/&quot; + ticketId + &quot;/status&quot;,</span>
<span class="nc" id="L810">                requestBody,</span>
<span class="nc" id="L811">                Ticket.class</span>
            );
            
<span class="nc" id="L814">            Ticket updatedTicket = response.getData();</span>
<span class="nc" id="L815">            logger.info(&quot;Successfully updated ticket {} status to {}&quot;, ticketId, status);</span>
<span class="nc" id="L816">            return updatedTicket;</span>
            
<span class="nc" id="L818">        } catch (ApiException e) {</span>
<span class="nc" id="L819">            logger.error(&quot;Failed to update ticket {} status to {}: {}&quot;, ticketId, status, e.getMessage());</span>
<span class="nc" id="L820">            throw e;</span>
        }
    }
    
    /**
     * Auto-assign a ticket using the server's assignment logic
     * 
     * @param ticketId the ticket ID to auto-assign
     * @return the updated ticket with assigned technician
     * @throws ApiException if the API call fails
     */
    public Ticket autoAssignTicket(Long ticketId) throws ApiException {
<span class="nc" id="L832">        logger.info(&quot;Auto-assigning ticket {}&quot;, ticketId);</span>
        
        try {
<span class="nc" id="L835">            ApiResponse&lt;Ticket&gt; response = apiClient.post(</span>
<span class="nc" id="L836">                &quot;/api/tickets/&quot; + ticketId + &quot;/auto-assign&quot;,</span>
<span class="nc" id="L837">                null,</span>
<span class="nc" id="L838">                Ticket.class</span>
            );
            
<span class="nc" id="L841">            Ticket assignedTicket = response.getData();</span>
            
            // Debug logging to see what the server actually returned
<span class="nc" id="L844">            Long technicianId = getEffectiveAssignedTechnicianId(assignedTicket);</span>
<span class="nc" id="L845">            logger.info(&quot;Auto-assign response for ticket {}: assignedTechnicianId={}, assignedTechnician={}, status={}&quot;, </span>
<span class="nc" id="L846">                ticketId, assignedTicket.getAssignedTechnicianId(), </span>
<span class="nc bnc" id="L847" title="All 2 branches missed.">                (assignedTicket.getAssignedTechnician() != null ? assignedTicket.getAssignedTechnician().getId() : &quot;null&quot;),</span>
<span class="nc" id="L848">                assignedTicket.getStatus());</span>
            
            // Check if we need to fetch the updated ticket to get the latest assignment
<span class="nc bnc" id="L851" title="All 2 branches missed.">            if (technicianId == null) {</span>
<span class="nc" id="L852">                logger.info(&quot;Response shows null assignment, fetching fresh ticket data to verify...&quot;);</span>
                try {
                    // Get the updated ticket from the server to see if assignment was applied
<span class="nc" id="L855">                    List&lt;Ticket&gt; allTickets = getAllTickets();</span>
<span class="nc" id="L856">                    Ticket refreshedTicket = allTickets.stream()</span>
<span class="nc" id="L857">                        .filter(t -&gt; t.getId().equals(ticketId))</span>
<span class="nc" id="L858">                        .findFirst()</span>
<span class="nc" id="L859">                        .orElse(assignedTicket);</span>
                    
<span class="nc" id="L861">                    Long refreshedTechnicianId = getEffectiveAssignedTechnicianId(refreshedTicket);</span>
<span class="nc" id="L862">                    logger.info(&quot;Refreshed ticket {}: assignedTechnicianId={}, assignedTechnician={}&quot;, </span>
<span class="nc" id="L863">                        ticketId, refreshedTicket.getAssignedTechnicianId(),</span>
<span class="nc bnc" id="L864" title="All 2 branches missed.">                        (refreshedTicket.getAssignedTechnician() != null ? refreshedTicket.getAssignedTechnician().getId() : &quot;null&quot;));</span>
                    
                    // Use the refreshed ticket if it has assignment data
<span class="nc bnc" id="L867" title="All 2 branches missed.">                    if (refreshedTechnicianId != null) {</span>
<span class="nc" id="L868">                        logger.info(&quot;Successfully auto-assigned ticket {} to technician {} (found via refresh)&quot;, </span>
<span class="nc" id="L869">                            ticketId, refreshedTechnicianId);</span>
<span class="nc" id="L870">                        return refreshedTicket;</span>
                    }
<span class="nc" id="L872">                } catch (Exception refreshError) {</span>
<span class="nc" id="L873">                    logger.warn(&quot;Failed to refresh ticket data after auto-assignment: {}&quot;, refreshError.getMessage());</span>
                }
            }
            
<span class="nc" id="L877">            logger.info(&quot;Successfully auto-assigned ticket {} to technician {}&quot;, </span>
<span class="nc bnc" id="L878" title="All 2 branches missed.">                ticketId, technicianId != null ? technicianId : &quot;null&quot;);</span>
            
<span class="nc" id="L880">            return assignedTicket;</span>
            
<span class="nc" id="L882">        } catch (ApiException e) {</span>
<span class="nc" id="L883">            logger.error(&quot;Failed to auto-assign ticket {}: {}&quot;, ticketId, e.getMessage());</span>
<span class="nc" id="L884">            throw e;</span>
        }
    }
    
    /**
     * Helper method to get the effective assigned technician ID from a ticket.
     * Checks both the assignedTechnicianId field and the nested assignedTechnician object.
     * 
     * @param ticket the ticket to check
     * @return the technician ID if found, null otherwise
     */
    private Long getEffectiveAssignedTechnicianId(Ticket ticket) {
<span class="nc bnc" id="L896" title="All 2 branches missed.">        if (ticket == null) {</span>
<span class="nc" id="L897">            return null;</span>
        }
        
        // First check the direct assignedTechnicianId field
<span class="nc bnc" id="L901" title="All 2 branches missed.">        if (ticket.getAssignedTechnicianId() != null) {</span>
<span class="nc" id="L902">            return ticket.getAssignedTechnicianId();</span>
        }
        
        // Then check the nested assignedTechnician object
<span class="nc bnc" id="L906" title="All 4 branches missed.">        if (ticket.getAssignedTechnician() != null &amp;&amp; ticket.getAssignedTechnician().getId() != null) {</span>
<span class="nc" id="L907">            return ticket.getAssignedTechnician().getId();</span>
        }
        
<span class="nc" id="L910">        return null;</span>
    }

    // ==================== END TICKET CRUD OPERATIONS ====================
} 
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>